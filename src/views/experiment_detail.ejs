<%- include('partials/head', { title: `IM Planner | ${experiment.name}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="card-header card-header-main">
      <a class="back-link" href="/" aria-label="Back to experiments">
        <span class="material-symbols-rounded" aria-hidden="true">arrow_back</span>
      </a>
      <div>
        <div class="title-row">
          <h1 class="card-title"><%- formatInline(experiment.name) %></h1>
        </div>
      </div>
      <div class="section-actions">
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
          <button class="icon-button" type="button" id="openMachineEdit" title="Edit experiment">
            <span class="material-symbols-rounded" aria-hidden="true">edit</span>
          </button>
        <% } %>
        <span class="status-pill status-<%= status %>" id="experimentStatusPill" data-auto-status="<%= autoStatus %>" data-auto-label="<%= autoStatusLabel %>"><%= statusLabel %></span>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager')) { %>
          <label class="toggle" title="Mark done">
            <input type="checkbox" id="experimentStatusToggle" <%= experiment.status_done_manual === 1 ? 'checked' : '' %>>
            <span class="track"></span>
          </label>
        <% } %>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Experiment</h2>
    </div>
    <div class="setup-summary">
      <div>
        <div class="small-note">Assigned machine</div>
        <div class="setup-value">
          <%= selectedMachine ? formatInline(selectedMachine.name) : 'No machine selected' %>
        </div>
      </div>
      <div>
        <div class="small-note">Recipe</div>
        <div class="setup-value">
          <% if (recipeNames && recipeNames.length) { %>
            <%= recipeNames.map((name) => formatInline(name)).join(', ') %>
          <% } else { %>
            -
          <% } %>
        </div>
      </div>
      <div>
        <div class="small-note">Description</div>
        <div class="setup-value"><%= experiment.notes ? formatInline(experiment.notes) : '-' %></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Research Sections</h2>
    </div>
    <div class="section-list">
      <div class="section-row">
        <div>
          <a class="section-title" href="/experiments/<%= experiment.id %>/qualification"><strong>Qualification</strong></a>
          <div class="small-note">Six-step Scientific Molding sequence.</div>
        </div>
        <div class="section-actions">
          <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/qualification">Open</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/1">Step 1</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/2">Step 2</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/3">Step 3</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/4">Step 4</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/5">Step 5</a>
          <a class="pure-button" href="/experiments/<%= experiment.id %>/qualification/6">Step 6</a>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Detailed Optimization</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="pure-button pure-button-secondary" type="button" id="openDoeCreate">AddNew</button>
      <% } %>
    </div>
    <div class="section-list">
      <% if (!doeStudies || doeStudies.length === 0) { %>
        <div class="small-note">No detailed optimization studies yet. Create one.</div>
      <% } else { %>
        <% doeStudies.forEach((doe) => { %>
          <div class="section-row">
            <div>
              <a class="section-title" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=design"><strong><%- formatInline(doe.name) %></strong></a>
              <div class="small-note">Type: <%= doe.design_type %> Â· Seed: <%= doe.seed %></div>
            </div>
          <div class="section-actions">
            <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=analysis">Analysis</a>
            <a class="pure-button" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=runs">Runs</a>
            <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
              <form class="pure-form icon-action" action="/experiments/<%= experiment.id %>/doe/<%= doe.id %>/clone" method="post">
                <button class="icon-button" type="submit" title="Clone detailed optimization">
                  <span class="material-symbols-rounded" aria-hidden="true">content_copy</span>
                </button>
              </form>
              <form class="pure-form icon-action" action="/experiments/<%= experiment.id %>/doe/<%= doe.id %>/delete" method="post" onsubmit="return confirm('Delete this detailed optimization study?');">
                <button class="icon-button danger" type="submit" title="Delete detailed optimization">
                  <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                </button>
              </form>
            <% } %>
          </div>
          </div>
        <% }); %>
      <% } %>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Reports</h2>
    </div>
    <p class="small-note">Generate report variants for this experiment (qualification/DOE/outputs).</p>
    <div class="section-list">
      <% if (!reports || reports.length === 0) { %>
        <div class="small-note">No reports yet. Create one.</div>
      <% } else { %>
        <% reports.forEach((report) => { 
             let includeList = [];
             let doeList = [];
             if (report.include_json) {
               try { includeList = JSON.parse(report.include_json); } catch {}
             }
             if (report.doe_ids_json) {
               try { doeList = JSON.parse(report.doe_ids_json); } catch {}
             }
        %>
          <div class="section-row">
            <div>
              <a class="section-title" href="/reports/<%= report.id %>"><strong><%- formatInline(report.name) %></strong></a>
              <div class="small-note">Created: <%= new Date(report.created_at).toLocaleString() %></div>
            </div>
            <div class="section-actions">
              <a class="pure-button pure-button-secondary" href="/reports/<%= report.id %>">Open</a>
              <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
                <button
                  class="icon-button"
                  type="button"
                  title="Edit report"
                  data-report-edit
                  data-report-id="<%= report.id %>"
                  data-report-name="<%= report.name %>"
                  data-report-executors="<%= report.executors || '' %>"
                  data-report-include="<%= JSON.stringify(includeList) %>"
                  data-report-doe="<%= JSON.stringify(doeList) %>"
                >
                  <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                </button>
                <form class="pure-form icon-action" action="/reports/<%= report.id %>/delete" method="post" onsubmit="return confirm('Delete this report?');">
                  <button class="icon-button danger" type="submit" title="Delete report">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                </form>
              <% } %>
            </div>
          </div>
        <% }); %>
      <% } %>
    </div>
    <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
      <div class="section-actions" style="margin-top: 0.75rem;">
        <button class="pure-button pure-button-primary" type="button" id="openReportDialog">Generate Report</button>
      </div>
    <% } %>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Tasks</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="pure-button pure-button-secondary" type="button" id="openTaskCreate">New Task</button>
      <% } %>
    </div>
    <div class="kanban-board" data-experiment-id="<%= experiment.id %>">
      <div class="kanban-column" data-status="init">
        <div class="kanban-title">Init</div>
        <div class="kanban-list" data-list></div>
      </div>
      <div class="kanban-column" data-status="in_progress">
        <div class="kanban-title">In progress</div>
        <div class="kanban-list" data-list></div>
      </div>
      <div class="kanban-column" data-status="done">
        <div class="kanban-title">Done</div>
        <div class="kanban-list" data-list></div>
      </div>
      <div class="kanban-column" data-status="failed">
        <div class="kanban-title">Failed</div>
        <div class="kanban-list" data-list></div>
      </div>
    </div>
  </div>

</div>

<dialog class="modal-frame" id="reportDialog">
  <div class="modal-header">
    <strong>Generate Report</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <form class="pure-form form-grid" id="reportForm">
      <div>
        <label for="reportName">Report name</label>
        <input id="reportName" name="name" type="text" placeholder="Report 1">
      </div>
      <div>
        <label for="reportExecutors">Executors</label>
        <input id="reportExecutors" name="executors" type="text" placeholder="e.g. Ivan Petrov, Anna Lee" data-default-executors="<%- formatInline(ownerName || '') %>">
      </div>
      <div>
        <div class="small-note">Include sections</div>
        <div class="form-row">
          <label class="toggle">
            <input type="checkbox" name="include" value="qualification" checked>
            <span class="track"></span>
            <span>Qualification (6 steps)</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="doe" id="includeDoeToggle">
            <span class="track"></span>
            <span>DOE</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="outputs">
            <span class="track"></span>
            <span>Outputs</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="defects">
            <span class="track"></span>
            <span>Defects</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="raw">
            <span class="track"></span>
            <span>Raw runs</span>
          </label>
        </div>
      </div>
      <div id="doePicker" style="display: none;">
        <label for="reportDoe">DOE studies</label>
        <select id="reportDoe" name="doe_ids" multiple size="4">
          <% doeStudies.forEach((study) => { %>
            <option value="<%= study.id %>"><%- formatInline(study.name) %> (<%= study.design_type %>)</option>
          <% }); %>
        </select>
        <div class="small-note">Select one or more DOE studies to include.</div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="pure-button pure-button-primary" type="button" id="generateReportBtn">Generate</button>
  </div>
</dialog>

<dialog class="modal-frame" id="machineEditDialog">
  <div class="modal-header">
    <strong>Edit experiment</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/update" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label>Experiment name</label>
          <input type="text" name="name" value="<%- formatInline(experiment.name) %>">
        </div>
        <div>
          <label>Assigned machine</label>
          <select name="machine_id">
            <option value="">No machine</option>
            <% (machines || []).forEach((machine) => { %>
              <option value="<%= machine.id %>" <%= experiment.machine_id === machine.id ? 'selected' : '' %>>
                <%- formatInline(machine.name) %>
              </option>
            <% }); %>
          </select>
        </div>
        <div class="field-span">
          <label>Description</label>
          <textarea name="notes" rows="4" placeholder="Optional description"><%- formatInline(experiment.notes || '') %></textarea>
        </div>
        <% if (canManageOwner) { %>
          <div class="field-span">
            <label>Owner (admin/manager only)</label>
            <select name="owner_user_id" id="ownerSelect">
              <option value="">No owner</option>
              <% (users || []).forEach((user) => { %>
                <option value="<%= user.id %>" <%= experiment.owner_user_id === user.id ? 'selected' : '' %>>
                  <%- formatInline(user.name ? user.name : user.email) %> (<%= user.role ?? 'no-role' %>)
                </option>
              <% }); %>
            </select>
            <div class="small-note" id="ownerSaveStatus">Changes apply immediately.</div>
          </div>
        <% } %>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>

<dialog class="modal-frame" id="doeCreateDialog">
  <div class="modal-header">
    <strong>New Detailed Optimization Study</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/doe" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label>Name</label>
          <input name="name" placeholder="Optimization 1">
        </div>
        <div>
          <label>Design Type</label>
          <select name="design_type">
            <option value="BBD">BBD (Box-Behnken)</option>
            <option value="FFA">FFA (Full Factorial)</option>
            <option value="SCREEN">SCREEN (Sampled Factorial)</option>
            <option value="SIM" selected>SIM (Grid)</option>
          </select>
        </div>
        <div>
          <label>Seed</label>
          <input type="number" name="seed" value="42">
        </div>
        <div>
          <label>Center Points (BBD)</label>
          <input type="number" name="center_points" value="3">
        </div>
        <div>
          <label>Max Runs</label>
          <input type="number" name="max_runs" value="200">
        </div>
        <div>
          <label>Replicates</label>
          <input type="number" name="replicate_count" value="1">
        </div>
        <div>
          <label>Recipe Block</label>
          <label class="pure-checkbox">
            <input type="checkbox" name="recipe_as_block" value="1"> Use recipe as block
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Create Study</button>
    </div>
  </form>
</dialog>

<dialog class="modal-frame" id="taskCreateDialog">
  <div class="modal-header">
    <strong>New Task</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" id="taskCreateForm">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label for="taskTitleInput">Title</label>
          <input id="taskTitleInput" name="title" type="text" required>
        </div>
        <div>
          <label for="taskDueInput">Due date</label>
          <input id="taskDueInput" name="due_at" type="date">
        </div>
        <div class="field-span">
          <label for="taskDescInput">Description</label>
          <textarea id="taskDescInput" name="description" rows="3"></textarea>
        </div>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
          <div class="field-span">
            <label for="taskOwnerSelect">Owner</label>
            <select id="taskOwnerSelect" name="owner_user_id">
              <option value="">No owner</option>
              <% (users || []).forEach((user) => { %>
                <option value="<%= user.id %>" <%= experiment.owner_user_id === user.id ? 'selected' : '' %>>
                  <%- formatInline(user.name ? user.name : user.email) %>
                </option>
              <% }); %>
            </select>
          </div>
        <% } else { %>
          <input type="hidden" name="owner_user_id" value="<%= experiment.owner_user_id ?? '' %>">
        <% } %>
      </div>
      <div class="task-entity-picker">
        <div class="task-entity-card">
          <div class="task-entity-title">Qualification (6 steps)</div>
          <div class="small-note">Select steps to include in task.</div>
          <div class="task-entity-steps">
            <label class="pure-checkbox">
              <input type="checkbox" name="qual_steps" value="1" checked> Step 1
            </label>
            <label class="pure-checkbox">
              <input type="checkbox" name="qual_steps" value="2"> Step 2
            </label>
            <label class="pure-checkbox">
              <input type="checkbox" name="qual_steps" value="3"> Step 3
            </label>
            <label class="pure-checkbox">
              <input type="checkbox" name="qual_steps" value="4" checked> Step 4
            </label>
            <label class="pure-checkbox">
              <input type="checkbox" name="qual_steps" value="5" checked> Step 5
            </label>
            <label class="pure-checkbox">
              <input type="checkbox" name="qual_steps" value="6" checked> Step 6
            </label>
          </div>
        </div>
        <div class="task-entity-card">
          <div class="task-entity-title">DOE studies</div>
          <div class="small-note">Select DOE studies to include.</div>
          <div class="task-entity-steps">
            <% if (!doeStudies || doeStudies.length === 0) { %>
              <div class="small-note">No DOE studies yet.</div>
            <% } else { %>
              <% doeStudies.forEach((study) => { %>
                <label class="pure-checkbox">
                  <input type="checkbox" name="doe_ids" value="<%= study.id %>">
                  <%- formatInline(study.name) %>
                </label>
              <% }); %>
            <% } %>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Create</button>
    </div>
  </form>
</dialog>

<dialog class="modal-frame" id="taskDetailDialog">
  <div class="modal-header">
    <strong id="taskTitle">Task</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <p id="taskDescription" class="small-note"></p>
    <div class="task-meta">
      <div><strong>Owner:</strong> <span id="taskOwner">-</span></div>
      <div><strong>Due:</strong> <span id="taskDue">-</span></div>
      <div><strong>Progress:</strong> <span id="taskProgress">0%</span></div>
      <div><strong>Suggested:</strong> <span id="taskSuggested">-</span></div>
    </div>
    <div class="calendar-actions">
      <button class="pure-button pure-button-secondary" type="button" id="calendarToggle">Add to calendar</button>
      <div class="calendar-menu" id="calendarMenu">
        <a class="pure-button" id="calendarIcsLink" href="#" download>Download .ics</a>
        <a class="pure-button" id="calendarGoogleLink" href="#" target="_blank" rel="noopener">Google Calendar</a>
      </div>
    </div>
    <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
      <div class="task-entity-form">
        <h3 class="card-title" style="margin-top: 1rem;">Attach entity</h3>
        <form class="pure-form" id="taskEntityForm">
          <div class="task-entity-picker">
            <div class="task-entity-card">
              <div class="task-entity-title">Qualification (6 steps)</div>
              <div class="small-note">Pick steps to add (defaults: 1,4,5,6).</div>
              <div class="task-entity-steps">
                <label class="pure-checkbox">
                  <input type="checkbox" name="qual_steps_edit" value="1" checked> Step 1
                </label>
                <label class="pure-checkbox">
                  <input type="checkbox" name="qual_steps_edit" value="2"> Step 2
                </label>
                <label class="pure-checkbox">
                  <input type="checkbox" name="qual_steps_edit" value="3"> Step 3
                </label>
                <label class="pure-checkbox">
                  <input type="checkbox" name="qual_steps_edit" value="4" checked> Step 4
                </label>
                <label class="pure-checkbox">
                  <input type="checkbox" name="qual_steps_edit" value="5" checked> Step 5
                </label>
                <label class="pure-checkbox">
                  <input type="checkbox" name="qual_steps_edit" value="6" checked> Step 6
                </label>
              </div>
            </div>
            <div class="task-entity-card">
              <div class="task-entity-title">DOE studies</div>
              <div class="small-note">Pick DOE studies to attach.</div>
              <div class="task-entity-steps">
                <% if (!doeStudies || doeStudies.length === 0) { %>
                  <div class="small-note">No DOE studies yet.</div>
                <% } else { %>
                  <% doeStudies.forEach((study) => { %>
                    <label class="pure-checkbox">
                      <input type="checkbox" name="doe_ids_edit" value="<%= study.id %>">
                      <%- formatInline(study.name) %>
                    </label>
                  <% }); %>
                <% } %>
              </div>
            </div>
            <div class="task-entity-card">
              <div class="task-entity-title">Reports</div>
              <div class="small-note">Attach reports (signature required).</div>
              <div class="task-entity-steps">
                <% if (!reports || reports.length === 0) { %>
                  <div class="small-note">No reports yet.</div>
                <% } else { %>
                  <% reports.forEach((report) => { %>
                    <label class="pure-checkbox">
                      <input type="checkbox" name="report_ids_edit" value="<%= report.id %>">
                      <%- formatInline(report.name) %>
                    </label>
                  <% }); %>
                <% } %>
              </div>
            </div>
          </div>
          <button class="pure-button pure-button-primary" type="submit">Attach selected</button>
        </form>
      </div>
    <% } %>
    <h3 class="card-title" style="margin-top: 1rem;">Entities</h3>
    <div id="taskEntities"></div>
  </div>
</dialog>

<script>
  const canSignReports = <%= currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer') ? 'true' : 'false' %>;
  const doeCreateDialog = document.getElementById('doeCreateDialog');
  document.getElementById('openDoeCreate')?.addEventListener('click', () => doeCreateDialog?.showModal());
  const machineEditDialog = document.getElementById('machineEditDialog');
  document.getElementById('openMachineEdit')?.addEventListener('click', () => machineEditDialog?.showModal());
  const reportDialog = document.getElementById('reportDialog');
  document.getElementById('openReportDialog')?.addEventListener('click', () => reportDialog?.showModal());
  const taskDetailDialog = document.getElementById('taskDetailDialog');
  const taskCreateDialog = document.getElementById('taskCreateDialog');
  document.getElementById('openTaskCreate')?.addEventListener('click', () => taskCreateDialog?.showModal());
  document.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => {
      doeCreateDialog?.close();
      machineEditDialog?.close();
      reportDialog?.close();
      taskDetailDialog?.close();
      taskCreateDialog?.close();
    });
  });

  const includeDoeToggle = document.getElementById('includeDoeToggle');
  const doePicker = document.getElementById('doePicker');
  includeDoeToggle?.addEventListener('change', (event) => {
    doePicker.style.display = event.target.checked ? 'block' : 'none';
  });

  const reportForm = document.getElementById('reportForm');
  const reportName = document.getElementById('reportName');
  const reportExecutors = document.getElementById('reportExecutors');
  const reportDoe = document.getElementById('reportDoe');
  let editingReportId = null;

  const parseJsonArray = (raw) => {
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  document.querySelectorAll('[data-report-edit]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const include = parseJsonArray(btn.dataset.reportInclude);
      const doe = parseJsonArray(btn.dataset.reportDoe);
      editingReportId = btn.dataset.reportId || null;
      reportName.value = btn.dataset.reportName || '';
      const currentExecutors = btn.dataset.reportExecutors || '';
      reportExecutors.value = currentExecutors || reportExecutors.dataset.defaultExecutors || '';
      reportForm.querySelectorAll('input[name="include"]').forEach((input) => {
        input.checked = include.includes(input.value);
      });
      includeDoeToggle.checked = include.includes('doe');
      doePicker.style.display = includeDoeToggle.checked ? 'block' : 'none';
      if (reportDoe) {
        Array.from(reportDoe.options).forEach((opt) => {
          opt.selected = doe.map(String).includes(opt.value);
        });
      }
      reportDialog?.showModal();
    });
  });

  document.getElementById('openReportDialog')?.addEventListener('click', () => {
    if (reportExecutors && !reportExecutors.value) {
      reportExecutors.value = reportExecutors.dataset.defaultExecutors || '';
    }
  });

  reportDialog?.addEventListener('close', () => {
    editingReportId = null;
    reportForm.reset();
    doePicker.style.display = 'none';
  });
  const generateReportBtn = document.getElementById('generateReportBtn');
  generateReportBtn?.addEventListener('click', async () => {
    if (!reportForm) return;
    const formData = new FormData(reportForm);
    const includes = formData.getAll('include').map((val) => String(val));
    const name = String(formData.get('name') || '').trim();
    const executors = String(formData.get('executors') || '').trim();
    const doeIds = formData.getAll('doe_ids').map((val) => String(val)).filter(Boolean);
    const payload = new URLSearchParams();
    if (name) payload.set('name', name);
    if (executors) payload.set('executors', executors);
    includes.forEach((val) => payload.append('include', val));
    doeIds.forEach((val) => payload.append('doe_ids', val));
    const url = editingReportId
      ? `/experiments/<%= experiment.id %>/reports/${editingReportId}`
      : `/experiments/<%= experiment.id %>/reports`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (data?.url) window.location.href = data.url;
  });

  const ownerSelect = document.getElementById('ownerSelect');
  const ownerSaveStatus = document.getElementById('ownerSaveStatus');
  const setOwnerStatus = (text, tone) => {
    if (!ownerSaveStatus) return;
    ownerSaveStatus.textContent = text;
    ownerSaveStatus.style.color = tone || '';
  };
  ownerSelect?.addEventListener('change', async () => {
    const payload = new URLSearchParams();
    payload.set('owner_user_id', ownerSelect.value || '');
    setOwnerStatus('Saving...', '#8a5a1f');
    try {
      const resp = await fetch(`/experiments/<%= experiment.id %>/owner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      if (!resp.ok) throw new Error('Request failed');
      setOwnerStatus('Owner updated.', '#1f7a4f');
    } catch {
      setOwnerStatus('Failed to update owner.', '#9e2b2b');
    }
  });

  const statusToggle = document.getElementById('experimentStatusToggle');
  const statusPill = document.getElementById('experimentStatusPill');
  statusToggle?.addEventListener('change', async () => {
    const done = statusToggle.checked ? '1' : '0';
    if (statusPill) {
      if (statusToggle.checked) {
        statusPill.classList.remove('status-in_progress', 'status-not_started');
        statusPill.classList.add('status-done');
        statusPill.textContent = 'Done';
      } else {
        const autoStatus = statusPill.dataset.autoStatus || 'not_started';
        const autoLabel = statusPill.dataset.autoLabel || 'Not started';
        statusPill.classList.remove('status-done', 'status-in_progress', 'status-not_started');
        statusPill.classList.add(`status-${autoStatus}`);
        statusPill.textContent = autoLabel;
      }
    }
    try {
      const payload = new URLSearchParams();
      payload.set('done', done);
      const resp = await fetch('/experiments/<%= experiment.id %>/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' },
        body: payload
      });
      if (!resp.ok) throw new Error('Request failed');
    } catch {
      statusToggle.checked = !statusToggle.checked;
      if (statusPill) {
        if (statusToggle.checked) {
          statusPill.classList.remove('status-in_progress', 'status-not_started');
          statusPill.classList.add('status-done');
          statusPill.textContent = 'Done';
        } else {
          const autoStatus = statusPill.dataset.autoStatus || 'not_started';
          const autoLabel = statusPill.dataset.autoLabel || 'Not started';
          statusPill.classList.remove('status-done', 'status-in_progress', 'status-not_started');
          statusPill.classList.add(`status-${autoStatus}`);
          statusPill.textContent = autoLabel;
        }
      }
    }
  });

  // Tasks kanban (read-only).
  const board = document.querySelector('.kanban-board');
  const taskTitle = document.getElementById('taskTitle');
  const taskDescription = document.getElementById('taskDescription');
  const taskOwner = document.getElementById('taskOwner');
  const taskDue = document.getElementById('taskDue');
  const taskProgress = document.getElementById('taskProgress');
  const taskSuggested = document.getElementById('taskSuggested');
  const taskEntities = document.getElementById('taskEntities');
  const calendarToggle = document.getElementById('calendarToggle');
  const calendarMenu = document.getElementById('calendarMenu');
  const calendarIcsLink = document.getElementById('calendarIcsLink');
  const calendarGoogleLink = document.getElementById('calendarGoogleLink');
  const taskEntityForm = document.getElementById('taskEntityForm');
  let currentTaskId = null;

  const setCheckboxState = (selector, existingMap, type) => {
    document.querySelectorAll(selector).forEach((input) => {
      const id = String(input.value);
      const key = `${type}:${id}`;
      if (existingMap.has(key)) {
        input.checked = true;
        input.disabled = true;
        input.closest('label')?.classList.add('is-attached');
      } else {
        if (input.name === 'qual_steps_edit') {
          const defaultOn = ['1', '4', '5', '6'].includes(id);
          input.checked = defaultOn;
        }
        input.disabled = false;
        input.closest('label')?.classList.remove('is-attached');
      }
    });
  };

  async function loadTasks() {
    if (!board) return;
    const experimentId = board.dataset.experimentId;
    const resp = await fetch(`/experiments/${experimentId}/tasks`);
    if (!resp.ok) return;
    const data = await resp.json();
    const lists = new Map();
    board.querySelectorAll('[data-status]').forEach((col) => {
      const status = col.dataset.status;
      const list = col.querySelector('[data-list]');
      if (status && list) {
        list.innerHTML = '';
        lists.set(status, list);
      }
    });
    (data.tasks || []).forEach((task) => {
      const list = lists.get(task.status || 'init');
      if (!list) return;
      const card = document.createElement('button');
      card.type = 'button';
      card.className = 'kanban-card';
      card.draggable = true;
      card.dataset.taskId = String(task.id);
      const owner = task.owner_name || task.owner_email || '-';
      const due = task.due_at ? new Date(task.due_at).toLocaleDateString() : '-';
      const percent = Math.round((task.progress?.percent || 0) * 100);
      card.innerHTML = `
        <div class="kanban-card-title">${task.title}</div>
        <div class="kanban-card-meta">${owner}</div>
        <div class="kanban-card-meta">Due: ${due}</div>
        <div class="kanban-card-progress">${percent}%</div>
      `;
      card.addEventListener('dragstart', (event) => {
        event.dataTransfer?.setData('text/plain', String(task.id));
        card.classList.add('is-dragging');
      });
      card.addEventListener('dragend', () => {
        card.classList.remove('is-dragging');
      });
      card.addEventListener('click', () => openTask(task.id));
      list.appendChild(card);
    });
  }

  async function openTask(taskId) {
    if (!taskDetailDialog) return;
    const resp = await fetch(`/tasks/${taskId}`);
    if (!resp.ok) return;
    const data = await resp.json();
    currentTaskId = taskId;
    if (calendarMenu) calendarMenu.classList.remove('is-open');
    if (calendarIcsLink) calendarIcsLink.href = `/tasks/${taskId}/calendar.ics`;
    if (calendarGoogleLink) calendarGoogleLink.href = `/tasks/${taskId}/calendar/google`;
    taskTitle.textContent = data.task?.title || 'Task';
    taskDescription.textContent = data.task?.description || '';
    const owner = data.owner_name || data.owner_email || '-';
    taskOwner.textContent = owner;
    taskDue.textContent = data.task?.due_at ? new Date(data.task.due_at).toLocaleDateString() : '-';
    taskProgress.textContent = `${Math.round((data.progress?.percent || 0) * 100)}%`;
    taskSuggested.textContent = data.suggestedStatus || '-';
    taskEntities.innerHTML = '';
    const attached = new Set(
      (data.entities || []).map((entity) => `${entity.entity_type}:${entity.entity_id}`)
    );
    setCheckboxState('input[name="qual_steps_edit"]', attached, 'qualification_step');
    setCheckboxState('input[name="doe_ids_edit"]', attached, 'doe');
    setCheckboxState('input[name="report_ids_edit"]', attached, 'report');
    (data.entities || []).forEach((entity) => {
      const row = document.createElement('div');
      row.className = 'task-entity-row';
      const signed = entity.signature_at ? 'signed' : (entity.signature_required ? 'required' : 'no');
      const signButton = canSignReports && entity.entity_type === 'report' && entity.signature_required && !entity.signature_at
        ? `<button class="pure-button pure-button-secondary" type="button" data-entity-sign="${entity.id}">Sign report</button>`
        : '';
      row.innerHTML = `
        <div><strong>${entity.entity_type}</strong> #${entity.entity_id}</div>
        <div>weight: ${entity.weight}</div>
        <div>status: ${entity.status}</div>
        <div>signature: ${signed}</div>
        ${signButton}
        <button class="pure-button pure-button-secondary" type="button" data-entity-delete="${entity.id}">Remove</button>
      `;
      taskEntities.appendChild(row);
    });
    taskEntities.querySelectorAll('[data-entity-sign]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const entityId = btn.getAttribute('data-entity-sign');
        if (!entityId) return;
        const payload = new URLSearchParams();
        payload.set('entity_id', entityId);
        await fetch(`/tasks/${taskId}/sign`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: payload
        });
        openTask(taskId);
        loadTasks();
      });
    });
    taskEntities.querySelectorAll('[data-entity-delete]').forEach((btn) => {
      btn.addEventListener('click', async () => {
        const entityId = btn.getAttribute('data-entity-delete');
        if (!entityId) return;
        await fetch(`/tasks/${taskId}/entities/${entityId}/delete`, { method: 'POST' });
        openTask(taskId);
        loadTasks();
      });
    });
    taskDetailDialog.showModal();
  }

  taskEntityForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!currentTaskId) return;
    const formData = new FormData(taskEntityForm);
    const toAttach = [];
    formData.getAll('qual_steps_edit').forEach((val) => {
      toAttach.push({ type: 'qualification_step', id: String(val) });
    });
    formData.getAll('doe_ids_edit').forEach((val) => {
      toAttach.push({ type: 'doe', id: String(val) });
    });
    formData.getAll('report_ids_edit').forEach((val) => {
      toAttach.push({ type: 'report', id: String(val), signature: '1' });
    });
    if (!toAttach.length) return;
    const requests = toAttach.map((item) => {
      const payload = new URLSearchParams();
      payload.set('entity_type', item.type);
      payload.set('entity_id', item.id);
      if (item.signature) payload.set('signature_required', item.signature);
      return fetch(`/tasks/${currentTaskId}/entities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
    });
    await Promise.allSettled(requests);
    openTask(currentTaskId);
    loadTasks();
  });

  calendarToggle?.addEventListener('click', () => {
    calendarMenu?.classList.toggle('is-open');
  });

  taskDetailDialog?.addEventListener('close', () => {
    calendarMenu?.classList.remove('is-open');
  });

  board?.querySelectorAll('.kanban-column').forEach((column) => {
    column.addEventListener('dragover', (event) => {
      event.preventDefault();
      column.classList.add('is-drop-target');
    });
    column.addEventListener('dragleave', () => {
      column.classList.remove('is-drop-target');
    });
    column.addEventListener('drop', async (event) => {
      event.preventDefault();
      column.classList.remove('is-drop-target');
      const taskId = event.dataTransfer?.getData('text/plain');
      const status = column.dataset.status;
      if (!taskId || !status) return;
      const payload = new URLSearchParams();
      payload.set('status', status);
      const resp = await fetch(`/tasks/${taskId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      if (!resp.ok) return;
      loadTasks();
    });
  });

  const taskCreateForm = document.getElementById('taskCreateForm');
  taskCreateForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!board) return;
    const experimentId = board.dataset.experimentId;
    const formData = new FormData(taskCreateForm);
    const payload = new URLSearchParams(formData);
    const resp = await fetch(`/experiments/${experimentId}/tasks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    if (!resp.ok) return;
    const data = await resp.json();
    const taskId = data?.id;
    if (taskId) {
      const qualSteps = formData.getAll('qual_steps').map((val) => String(val));
      const doeIds = formData.getAll('doe_ids').map((val) => String(val));
      const attaches = [];
      qualSteps.forEach((step) => {
        const attach = new URLSearchParams();
        attach.set('entity_type', 'qualification_step');
        attach.set('entity_id', step);
        attaches.push(fetch(`/tasks/${taskId}/entities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: attach
        }));
      });
      doeIds.forEach((doeId) => {
        const attach = new URLSearchParams();
        attach.set('entity_type', 'doe');
        attach.set('entity_id', doeId);
        attaches.push(fetch(`/tasks/${taskId}/entities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: attach
        }));
      });
      if (attaches.length) {
        await Promise.allSettled(attaches);
      }
    }
    taskCreateForm.reset();
    taskCreateDialog?.close();
    loadTasks();
  });

  loadTasks();
</script>
<%- include('partials/foot') %>
