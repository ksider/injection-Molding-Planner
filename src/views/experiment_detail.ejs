<%- include('partials/head', { title: `IM Planner | ${experiment.name}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="card-header card-header-main">
      <a class="back-link" href="/" aria-label="Back to experiments">
        <span class="material-symbols-rounded" aria-hidden="true">arrow_back</span>
      </a>
      <div>
        <div class="title-row">
          <h1 class="card-title"><%- formatInline(experiment.name) %></h1>
        </div>
      </div>
      <div class="section-actions">
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
          <button class="icon-button" type="button" id="openMachineEdit" title="Edit experiment">
            <span class="material-symbols-rounded" aria-hidden="true">edit</span>
          </button>
        <% } %>
        <span class="status-pill status-<%= status %>" id="experimentStatusPill" data-auto-status="<%= autoStatus %>" data-auto-label="<%= autoStatusLabel %>"><%= statusLabel %></span>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager')) { %>
          <label class="toggle" title="Mark done">
            <input type="checkbox" id="experimentStatusToggle" <%= experiment.status_done_manual === 1 ? 'checked' : '' %>>
            <span class="track"></span>
          </label>
        <% } %>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Experiment</h2>
    </div>
    <div class="setup-summary setup-summary-two">
      <div class="setup-col setup-col-desc">
        <div class="small-note">Description</div>
        <div class="setup-value"><%= experiment.notes ? formatInline(experiment.notes) : '-' %></div>
      </div>
      <div class="setup-col setup-stack">
        <div class="setup-row">
          <div class="small-note">Assigned machine</div>
          <div class="setup-value">
            <%= selectedMachine ? formatInline(selectedMachine.name) : 'No machine selected' %>
          </div>
        </div>
        <div class="setup-row">
          <div class="small-note">Recipe</div>
          <div class="setup-value">
            <% if (recipeNames && recipeNames.length) { %>
              <%= recipeNames.map((name) => formatInline(name)).join(', ') %>
            <% } else { %>
              -
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Research Sections</h2>
    </div>
    <div id="qualification" class="section-list">
      <div class="section-row">
        <div>
          <strong>Qualification</strong>
          <div class="small-note">Six-step Scientific Molding sequence.</div>
        </div>
      </div>
      <div class="qualification-compact-grid">
        <% (qualificationCards || []).forEach((card) => { %>
          <div class="qualification-compact-card">
            <div class="qualification-compact-head">
              <a class="section-title" href="/experiments/<%= experiment.id %>/qualification/<%= card.stepNumber %>">Step <%= card.stepNumber %></a>
              <span class="status-pill status-<%= card.status %>"><%= card.statusLabel %></span>
            </div>
            <div class="qualification-compact-name"><%- formatInline(card.name) %></div>
            <div class="qualification-compact-summary">
              <% if (card.summaryItems && card.summaryItems.length) { %>
                <% card.summaryItems.forEach((item) => { %>
                  <div class="qualification-compact-item">
                    <span class="small-note"><%= item.label %></span>
                    <strong><%= item.value %></strong>
                  </div>
                <% }); %>
              <% } else { %>
                <span class="small-note">No summary yet.</span>
              <% } %>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Detailed Optimization</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="icon-button" type="button" id="openDoeCreate" title="Add DOE">
          <span class="material-symbols-rounded" aria-hidden="true">add</span>
        </button>
      <% } %>
    </div>
    <div class="section-list">
      <% if (!doeStudies || doeStudies.length === 0) { %>
        <div class="small-note">No detailed optimization studies yet. Create one.</div>
      <% } else { %>
        <% doeStudies.forEach((doe) => { %>
          <div class="section-row">
            <div class="section-main">
              <a class="section-title" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=design"><strong><%- formatInline(doe.name) %></strong></a>
              <div class="small-note">Type: <%= doe.design_type %> · Seed: <%= doe.seed %></div>
            </div>
          <div class="section-actions">
            <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=analysis">Analysis</a>
            <a class="pure-button" href="/experiments/<%= experiment.id %>/doe/<%= doe.id %>?tab=runs">Runs</a>
            <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
              <button
                class="icon-button"
                type="button"
                title="Edit DOE name"
                data-doe-edit
                data-doe-id="<%= doe.id %>"
                data-doe-name="<%= doe.name %>"
              >
                <span class="material-symbols-rounded" aria-hidden="true">edit</span>
              </button>
              <form class="pure-form icon-action" action="/experiments/<%= experiment.id %>/doe/<%= doe.id %>/clone" method="post">
                <button class="icon-button" type="submit" title="Clone detailed optimization">
                  <span class="material-symbols-rounded" aria-hidden="true">content_copy</span>
                </button>
              </form>
              <form class="pure-form icon-action" action="/experiments/<%= experiment.id %>/doe/<%= doe.id %>/delete" method="post" onsubmit="return confirm('Delete this detailed optimization study?');">
                <button class="icon-button danger" type="submit" title="Delete detailed optimization">
                  <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                </button>
              </form>
            <% } %>
          </div>
          </div>
        <% }); %>
      <% } %>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Reports</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="icon-button" type="button" id="openReportDialog" title="Generate report">
          <span class="material-symbols-rounded" aria-hidden="true">add</span>
        </button>
      <% } %>
    </div>
    <p class="small-note">Generate report variants for this experiment (qualification/DOE/outputs).</p>
    <div class="section-list">
      <% if (!reports || reports.length === 0) { %>
        <div class="small-note">No reports yet. Create one.</div>
      <% } else { %>
        <% reports.forEach((report) => { 
             let includeList = [];
             let doeList = [];
             if (report.include_json) {
               try { includeList = JSON.parse(report.include_json); } catch {}
             }
             if (report.doe_ids_json) {
               try { doeList = JSON.parse(report.doe_ids_json); } catch {}
             }
        %>
          <div class="section-row">
            <div>
              <a class="section-title" href="/reports/<%= report.id %>"><strong><%- formatInline(report.name) %></strong></a>
              <div class="small-note">Created: <%= new Date(report.created_at).toLocaleString() %></div>
            </div>
            <div class="section-actions">
              <a class="pure-button pure-button-secondary" href="/reports/<%= report.id %>">Open</a>
              <% if (report.signed_at) { %>
                <span class="status-pill status-done">Signed</span>
              <% } %>
              <% if (!report.signed_at && currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
                <button
                  class="icon-button"
                  type="button"
                  title="Edit report"
                  data-report-edit
                  data-report-id="<%= report.id %>"
                  data-report-name="<%= report.name %>"
                  data-report-executors="<%= report.executors || '' %>"
                  data-report-include="<%= JSON.stringify(includeList) %>"
                  data-report-doe="<%= JSON.stringify(doeList) %>"
                >
                  <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                </button>
                <form class="pure-form icon-action" action="/reports/<%= report.id %>/delete" method="post" onsubmit="return confirm('Delete this report?');">
                  <button class="icon-button danger" type="submit" title="Delete report">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                </form>
              <% } %>
            </div>
          </div>
        <% }); %>
      <% } %>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h2 class="card-title">Tasks</h2>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="icon-button" type="button" id="openTaskCreate" title="New task">
          <span class="material-symbols-rounded" aria-hidden="true">add</span>
        </button>
      <% } %>
    </div>
    <div class="kanban-board" data-experiment-id="<%= experiment.id %>">
      <div class="kanban-column" data-status="init">
        <div class="kanban-title">Init</div>
        <div class="kanban-list" data-list></div>
      </div>
      <div class="kanban-column" data-status="in_progress">
        <div class="kanban-title">In progress</div>
        <div class="kanban-list" data-list></div>
      </div>
      <div class="kanban-column" data-status="done">
        <div class="kanban-title">Done</div>
        <div class="kanban-list" data-list></div>
      </div>
      <div class="kanban-column" data-status="failed">
        <div class="kanban-title">Failed</div>
        <div class="kanban-list" data-list></div>
      </div>
    </div>
  </div>

</div>

<% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
  <a
    class="icon-button notes-journal-toggle"
    id="notesJournalToggle"
    href="/experiments/<%= experiment.id %>/journal"
    title="Open journal"
  >
    <span class="material-symbols-rounded" aria-hidden="true">menu_book</span>
  </a>
  <button
    class="icon-button notes-drawer-toggle"
    type="button"
    id="notesDrawerToggle"
    aria-expanded="false"
    title="Notes"
  >
    <span class="material-symbols-rounded" aria-hidden="true">expand_less</span>
  </button>

  <aside class="notes-drawer" id="notesDrawer" aria-label="Experiment notes">
    <div class="notes-drawer-head notes-drawer-head-inline">
      <strong>Notes</strong>
      <label class="toggle" title="Only current context">
        <input type="checkbox" id="notesOnlyCurrentToggle">
        <span class="track"></span>
        <span>Only current context</span>
      </label>
      <span class="small-note">Context: Experiment #<%= experiment.id %></span>
      <input class="notes-search" type="date" id="notesDateInput" title="Filter by date">
      <input class="notes-search" type="search" id="notesSearchInput" placeholder="Search notes">
      <div class="section-actions">
        <a class="icon-button" href="/experiments/<%= experiment.id %>/journal" title="Open journal">
          <span class="material-symbols-rounded" aria-hidden="true">menu_book</span>
        </a>
        <button class="icon-button" type="button" id="notesDrawerClose" title="Hide notes">
          <span class="material-symbols-rounded" aria-hidden="true">expand_more</span>
        </button>
      </div>
    </div>
    <div class="notes-drawer-body">
      <aside class="journal-rail" id="notesRail"></aside>
      <section class="notes-pane notes-pane-compose">
        <div class="notes-compose">
          <div class="editor-toolbar notes-editor-toolbar" data-notes-toolbar role="toolbar" aria-label="Notes formatting">
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="undo" title="Undo"><span class="material-symbols-rounded">undo</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="redo" title="Redo"><span class="material-symbols-rounded">redo</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <select class="toolbar-select" data-notes-font-family title="Font family">
              <option value="">Font</option>
              <option value="Trebuchet MS">Trebuchet</option>
              <option value="Georgia">Georgia</option>
              <option value="Arial">Arial</option>
              <option value="Courier New">Courier</option>
            </select>
            <select class="toolbar-select" data-notes-font-size title="Font size">
              <option value="">Size</option>
              <option value="12px">12</option>
              <option value="14px">14</option>
              <option value="16px">16</option>
              <option value="18px">18</option>
              <option value="20px">20</option>
              <option value="24px">24</option>
              <option value="28px">28</option>
            </select>
            <select class="toolbar-select" data-notes-line-height title="Line height">
              <option value="">Line</option>
              <option value="1.2">1.2</option>
              <option value="1.35">1.35</option>
              <option value="1.5">1.5</option>
              <option value="1.65">1.65</option>
              <option value="1.8">1.8</option>
              <option value="2">2</option>
            </select>
            <select class="toolbar-select" data-notes-preset title="Text style preset">
              <option value="">Preset</option>
              <option value="body">Body</option>
              <option value="subtitle">Subtitle</option>
              <option value="note">Note</option>
              <option value="emphasis">Emphasis</option>
            </select>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm" type="button" data-notes-cmd="h1">H1</button>
            <button class="pure-button button-sm" type="button" data-notes-cmd="h2">H2</button>
            <button class="pure-button button-sm" type="button" data-notes-cmd="h3">H3</button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="bold" title="Bold"><span class="material-symbols-rounded">format_bold</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="italic" title="Italic"><span class="material-symbols-rounded">format_italic</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="underline" title="Underline"><span class="material-symbols-rounded">format_underlined</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="strike" title="Strike"><span class="material-symbols-rounded">strikethrough_s</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="highlight" title="Highlight"><span class="material-symbols-rounded">ink_highlighter</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="superscript" title="Superscript"><span class="material-symbols-rounded">superscript</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="subscript" title="Subscript"><span class="material-symbols-rounded">subscript</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="bullet" title="Bullet list"><span class="material-symbols-rounded">format_list_bulleted</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="ordered" title="Ordered list"><span class="material-symbols-rounded">format_list_numbered</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="checklist" title="Checklist"><span class="material-symbols-rounded">checklist</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="quote" title="Quote"><span class="material-symbols-rounded">format_quote</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="code" title="Code block"><span class="material-symbols-rounded">code_blocks</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="hr" title="Divider"><span class="material-symbols-rounded">horizontal_rule</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="math-inline" title="Inline formula"><span class="material-symbols-rounded">functions</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="math-block" title="Block formula"><span class="material-symbols-rounded">calculate</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="align-left" title="Align left"><span class="material-symbols-rounded">format_align_left</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="align-center" title="Align center"><span class="material-symbols-rounded">format_align_center</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="align-right" title="Align right"><span class="material-symbols-rounded">format_align_right</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="align-justify" title="Justify"><span class="material-symbols-rounded">format_align_justify</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="link" title="Link"><span class="material-symbols-rounded">link</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-notes-cmd="image" title="Image"><span class="material-symbols-rounded">image</span></button>
            <div class="image-tools toolbar-conditional" data-notes-image-tools title="Image tools">
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-width-25" title="Image width 25%">25%</button>
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-width-50" title="Image width 50%">50%</button>
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-width-75" title="Image width 75%">75%</button>
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-width-100" title="Image width 100%">100%</button>
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-align-left" title="Align image left">L</button>
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-align-center" title="Align image center">C</button>
              <button class="pure-button button-sm image-op" type="button" data-notes-cmd="image-align-right" title="Align image right">R</button>
              <button class="pure-button button-sm image-op danger" type="button" data-notes-cmd="image-delete" title="Delete image">Del</button>
            </div>
            <div class="table-tools" title="Table tools">
              <button class="pure-button button-sm icon-only" type="button" data-notes-table-picker-toggle title="Insert table">
                <span class="material-symbols-rounded">table</span>
              </button>
              <div class="table-picker" data-notes-table-picker hidden>
                <div class="table-picker-label" data-notes-table-picker-label>3 x 3</div>
                <div class="table-picker-grid" data-notes-table-picker-grid></div>
              </div>
              <div class="table-ops toolbar-conditional" data-notes-table-ops>
                <button class="pure-button button-sm table-op" type="button" data-notes-cmd="table-row-add" title="Add row">R+</button>
                <button class="pure-button button-sm table-op" type="button" data-notes-cmd="table-row-del" title="Delete row">R-</button>
                <button class="pure-button button-sm table-op" type="button" data-notes-cmd="table-col-add" title="Add column">C+</button>
                <button class="pure-button button-sm table-op" type="button" data-notes-cmd="table-col-del" title="Delete column">C-</button>
                <button class="pure-button button-sm table-op danger" type="button" data-notes-cmd="table-del" title="Delete table">Del</button>
              </div>
            </div>
          </div>
          <div id="notesInput" class="journal-editor" contenteditable="true" data-placeholder="Write note for current experiment context..."></div>
          <div class="notes-compose-footer">
            <span class="small-note">Ctrl/Cmd+Enter: append today · Ctrl/Cmd+Shift+Enter: new note</span>
            <button class="pure-button pure-button-primary" type="button" id="notesSendBtn">Add note</button>
          </div>
        </div>
      </section>
      <section class="notes-pane notes-pane-feed">
        <section class="notes-feed-scroll">
          <div class="journal-feed" id="notesFeed">
            <div class="small-note notes-empty" id="notesEmptyState">No notes yet.</div>
          </div>
        </section>
      </section>
    </div>
  </aside>
<% } %>

<dialog class="modal-frame" id="reportDialog">
  <div class="modal-header">
    <strong>Generate Report</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <form class="pure-form form-grid" id="reportForm">
      <div>
        <label for="reportName">Report name</label>
        <input id="reportName" name="name" type="text" placeholder="Report 1">
      </div>
      <div>
        <label for="reportExecutors">Executors</label>
        <input id="reportExecutors" name="executors" type="text" placeholder="e.g. Ivan Petrov, Anna Lee" data-default-executors="<%- formatInline(ownerName || '') %>">
      </div>
      <div>
        <div class="small-note">Include sections</div>
        <div class="form-row">
          <label class="toggle">
            <input type="checkbox" name="include" value="qualification" checked>
            <span class="track"></span>
            <span>Qualification (6 steps)</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="doe" id="includeDoeToggle">
            <span class="track"></span>
            <span>DOE</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="outputs">
            <span class="track"></span>
            <span>Outputs</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="defects">
            <span class="track"></span>
            <span>Defects</span>
          </label>
          <label class="toggle">
            <input type="checkbox" name="include" value="raw">
            <span class="track"></span>
            <span>Raw runs</span>
          </label>
        </div>
      </div>
      <div id="doePicker" style="display: none;">
        <label for="reportDoe">DOE studies</label>
        <select id="reportDoe" name="doe_ids" multiple size="4">
          <% doeStudies.forEach((study) => { %>
            <option value="<%= study.id %>"><%- formatInline(study.name) %> (<%= study.design_type %>)</option>
          <% }); %>
        </select>
        <div class="small-note">Select one or more DOE studies to include.</div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button class="pure-button pure-button-primary" type="button" id="generateReportBtn">Generate</button>
  </div>
</dialog>

<dialog class="modal-frame" id="machineEditDialog">
  <div class="modal-header">
    <strong>Edit experiment</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/update" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label>Experiment name</label>
          <input type="text" name="name" value="<%- formatInline(experiment.name) %>">
        </div>
        <div>
          <label>Assigned machine</label>
          <select name="machine_id">
            <option value="">No machine</option>
            <% (machines || []).forEach((machine) => { %>
              <option value="<%= machine.id %>" <%= experiment.machine_id === machine.id ? 'selected' : '' %>>
                <%- formatInline(machine.name) %>
              </option>
            <% }); %>
          </select>
        </div>
        <div class="field-span">
          <label>Description</label>
          <textarea name="notes" rows="4" placeholder="Optional description"><%- formatInline(experiment.notes || '') %></textarea>
        </div>
        <% if (canManageOwner) { %>
          <div class="field-span">
            <label>Owner (admin/manager only)</label>
            <select name="owner_user_id" id="ownerSelect">
              <option value="">No owner</option>
              <% (users || []).forEach((user) => { %>
                <option value="<%= user.id %>" <%= experiment.owner_user_id === user.id ? 'selected' : '' %>>
                  <%- formatInline(user.name ? user.name : user.email) %> (<%= user.role ?? 'no-role' %>)
                </option>
              <% }); %>
            </select>
            <div class="small-note" id="ownerSaveStatus">Changes apply immediately.</div>
          </div>
        <% } %>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>

<dialog class="modal-frame" id="doeCreateDialog">
  <div class="modal-header">
    <strong>New Detailed Optimization Study</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/doe" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label>Name</label>
          <input name="name" placeholder="Optimization 1">
        </div>
        <div>
          <label>Design Type</label>
          <select name="design_type">
            <option value="BBD">BBD (Box-Behnken)</option>
            <option value="FFA">FFA (Full Factorial)</option>
            <option value="SCREEN">SCREEN (Sampled Factorial)</option>
            <option value="SIM" selected>SIM (Grid)</option>
          </select>
        </div>
        <div>
          <label>Seed</label>
          <input type="number" name="seed" value="42">
        </div>
        <div>
          <label>Center Points (BBD)</label>
          <input type="number" name="center_points" value="3">
        </div>
        <div>
          <label>Max Runs</label>
          <input type="number" name="max_runs" value="200">
        </div>
        <div>
          <label>Replicates</label>
          <input type="number" name="replicate_count" value="1">
        </div>
        <div>
          <label>Recipe Block</label>
          <label class="pure-checkbox">
            <input type="checkbox" name="recipe_as_block" value="1"> Use recipe as block
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Create Study</button>
    </div>
  </form>
</dialog>

<dialog class="modal-frame" id="taskCreateDialog">
  <div class="modal-header">
    <strong>New Task</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" id="taskCreateForm">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label for="taskTitleInput">Title</label>
          <input id="taskTitleInput" name="title" type="text" required>
        </div>
        <div>
          <label for="taskDueInput">Due date</label>
          <input id="taskDueInput" name="due_at" type="date">
        </div>
        <div class="field-span">
          <label for="taskDescInput">Description</label>
          <textarea id="taskDescInput" name="description" rows="3"></textarea>
        </div>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
          <div class="field-span">
            <label for="taskOwnerSelect">Owner</label>
            <select id="taskOwnerSelect" name="owner_user_id">
              <option value="">No owner</option>
              <% (users || []).forEach((user) => { %>
                <option value="<%= user.id %>" <%= experiment.owner_user_id === user.id ? 'selected' : '' %>>
                  <%- formatInline(user.name ? user.name : user.email) %>
                </option>
              <% }); %>
            </select>
          </div>
        <% } else { %>
          <input type="hidden" name="owner_user_id" value="<%= experiment.owner_user_id ?? '' %>">
        <% } %>
      </div>
      <button class="link-muted collapsible-toggle" type="button" id="toggleTaskCreateEntities">
        Add entities
      </button>
      <div class="collapsible is-open" id="taskCreateEntitiesPanel">
        <div class="task-entity-picker">
          <div class="task-entity-card">
            <div class="task-entity-title">Qualification (6 steps)</div>
            <div class="small-note">Select steps to include in task.</div>
            <div class="task-entity-steps">
              <label class="pure-checkbox">
                <input type="checkbox" name="qual_steps" value="1" checked> Step 1
              </label>
              <label class="pure-checkbox">
                <input type="checkbox" name="qual_steps" value="2"> Step 2
              </label>
              <label class="pure-checkbox">
                <input type="checkbox" name="qual_steps" value="3"> Step 3
              </label>
              <label class="pure-checkbox">
                <input type="checkbox" name="qual_steps" value="4" checked> Step 4
              </label>
              <label class="pure-checkbox">
                <input type="checkbox" name="qual_steps" value="5" checked> Step 5
              </label>
              <label class="pure-checkbox">
                <input type="checkbox" name="qual_steps" value="6" checked> Step 6
              </label>
            </div>
          </div>
          <div class="task-entity-card">
            <div class="task-entity-title">DOE studies</div>
            <div class="small-note">Select DOE studies to include.</div>
            <div class="task-entity-steps">
              <% if (!doeStudies || doeStudies.length === 0) { %>
                <div class="small-note">No DOE studies yet.</div>
              <% } else { %>
                <% doeStudies.forEach((study) => { %>
                  <label class="pure-checkbox">
                    <input type="checkbox" name="doe_ids" value="<%= study.id %>">
                    <%- formatInline(study.name) %>
                  </label>
                <% }); %>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Create</button>
    </div>
  </form>
</dialog>

<dialog class="modal-frame" id="taskDetailDialog">
  <div class="modal-header">
    <strong id="taskTitle">Task</strong>
    <div class="modal-actions">
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <button class="icon-btn icon-only" type="button" id="openTaskEdit" title="Edit task">
          <span class="material-symbols-rounded" aria-hidden="true">edit</span>
        </button>
      <% } %>
      <button class="icon-btn icon-only" type="button" data-close title="Close">
        <span class="material-symbols-rounded" aria-hidden="true">close</span>
      </button>
    </div>
  </div>
  <div class="modal-body">
    <p id="taskDescription" class="small-note"></p>
    <div class="task-meta">
      <div><strong>Owner:</strong> <span id="taskOwner">-</span></div>
      <div class="task-due">
        <strong>Due:</strong>
        <span class="task-due-icon material-symbols-rounded" aria-hidden="true">calendar_today</span>
        <div class="calendar-menu" id="calendarMenu">
          <a class="pure-button" id="calendarIcsLink" href="#" download>Download .ics</a>
          <a class="pure-button" id="calendarGoogleLink" href="#" target="_blank" rel="noopener">Google Calendar</a>
        </div>
        <span id="taskDue">-</span>
      </div>
      <div><strong>Progress:</strong> <span id="taskProgress">0%</span></div>
      <div><strong>Suggested:</strong> <span id="taskSuggested">-</span></div>
    </div>
    <div class="calendar-actions"></div>
    <h3 class="card-title" style="margin-top: 1rem;">Entities</h3>
    <div id="taskEntities"></div>
  </div>
</dialog>

<% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
  <dialog class="modal-frame" id="taskEditDialog">
    <div class="modal-header">
      <strong>Edit Task</strong>
      <button class="pure-button" type="button" data-close>Close</button>
    </div>
    <div class="modal-body">
      <form class="pure-form form-grid" id="taskEditForm">
        <div>
          <label for="taskEditTitle">Title</label>
          <input id="taskEditTitle" name="title" type="text" required>
        </div>
        <div>
          <label for="taskEditDue">Due date</label>
          <input id="taskEditDue" name="due_at" type="date">
        </div>
        <div class="field-span">
          <label for="taskEditDesc">Description</label>
          <textarea id="taskEditDesc" name="description" rows="3"></textarea>
        </div>
      </form>
      <div class="task-entity-form">
        <button class="link-muted collapsible-toggle" type="button" id="toggleTaskEditEntities">
          Attach entities
        </button>
        <div class="collapsible" id="taskEditEntitiesPanel">
          <form class="pure-form" id="taskEditEntityForm">
            <div class="task-entity-picker">
              <div class="task-entity-card">
                <div class="task-entity-title">Qualification (6 steps)</div>
                <div class="small-note">Pick steps to add.</div>
                <div class="task-entity-steps">
                  <label class="pure-checkbox">
                    <input type="checkbox" name="qual_steps_edit" value="1"> Step 1
                  </label>
                  <label class="pure-checkbox">
                    <input type="checkbox" name="qual_steps_edit" value="2"> Step 2
                  </label>
                  <label class="pure-checkbox">
                    <input type="checkbox" name="qual_steps_edit" value="3"> Step 3
                  </label>
                  <label class="pure-checkbox">
                    <input type="checkbox" name="qual_steps_edit" value="4"> Step 4
                  </label>
                  <label class="pure-checkbox">
                    <input type="checkbox" name="qual_steps_edit" value="5"> Step 5
                  </label>
                  <label class="pure-checkbox">
                    <input type="checkbox" name="qual_steps_edit" value="6"> Step 6
                  </label>
                </div>
              </div>
              <div class="task-entity-card">
                <div class="task-entity-title">DOE studies</div>
                <div class="small-note">Pick DOE studies to attach.</div>
                <div class="task-entity-steps">
                  <% if (!doeStudies || doeStudies.length === 0) { %>
                    <div class="small-note">No DOE studies yet.</div>
                  <% } else { %>
                    <% doeStudies.forEach((study) => { %>
                      <label class="pure-checkbox">
                        <input type="checkbox" name="doe_ids_edit" value="<%= study.id %>">
                        <%- formatInline(study.name) %>
                      </label>
                    <% }); %>
                  <% } %>
                </div>
              </div>
              <div class="task-entity-card">
                <div class="task-entity-title">Reports</div>
                <div class="small-note">Attach reports (signature required).</div>
                <div class="task-entity-steps">
                  <% if (!reports || reports.length === 0) { %>
                    <div class="small-note">No reports yet.</div>
                  <% } else { %>
                    <% reports.forEach((report) => { %>
                      <label class="pure-checkbox">
                        <input type="checkbox" name="report_ids_edit" value="<%= report.id %>">
                        <%- formatInline(report.name) %>
                      </label>
                    <% }); %>
                  <% } %>
                </div>
              </div>
            </div>
            <button class="pure-button pure-button-primary attach-entities-btn" type="submit">Attach selected</button>
          </form>
        </div>
      </div>
      <h3 class="card-title" style="margin-top: 1rem;">Entities</h3>
      <div id="taskEditEntities"></div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="button" id="taskEditSave">Save changes</button>
    </div>
  </dialog>
<% } %>

<dialog class="modal-frame" id="doeEditDialog">
  <div class="modal-header">
    <strong>Edit DOE name</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" id="doeEditForm" method="post">
    <div class="modal-body">
      <label for="doeEditName">DOE name</label>
      <input id="doeEditName" name="name" type="text" required>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>

<script>
  const canSignReports = <%= currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer') ? 'true' : 'false' %>;
  const doeCreateDialog = document.getElementById('doeCreateDialog');
  document.getElementById('openDoeCreate')?.addEventListener('click', () => doeCreateDialog?.showModal());
  const machineEditDialog = document.getElementById('machineEditDialog');
  document.getElementById('openMachineEdit')?.addEventListener('click', () => machineEditDialog?.showModal());
  const reportDialog = document.getElementById('reportDialog');
  document.getElementById('openReportDialog')?.addEventListener('click', () => reportDialog?.showModal());
  const doeEditDialog = document.getElementById('doeEditDialog');
  const doeEditForm = document.getElementById('doeEditForm');
  const doeEditName = document.getElementById('doeEditName');
  document.querySelectorAll('[data-doe-edit]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const doeId = btn.dataset.doeId;
      const doeName = btn.dataset.doeName || '';
      if (!doeEditDialog || !doeEditForm || !doeEditName || !doeId) return;
      doeEditForm.setAttribute('action', `/experiments/<%= experiment.id %>/doe/${doeId}/name`);
      doeEditName.value = doeName;
      doeEditDialog.showModal();
    });
  });
  const taskDetailDialog = document.getElementById('taskDetailDialog');
  const taskEditDialog = document.getElementById('taskEditDialog');
  const openTaskEdit = document.getElementById('openTaskEdit');
  const taskCreateDialog = document.getElementById('taskCreateDialog');
  document.getElementById('openTaskCreate')?.addEventListener('click', () => taskCreateDialog?.showModal());
  document.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => {
      doeCreateDialog?.close();
      doeEditDialog?.close();
      machineEditDialog?.close();
      reportDialog?.close();
      taskDetailDialog?.close();
      taskEditDialog?.close();
      taskCreateDialog?.close();
    });
  });

  const includeDoeToggle = document.getElementById('includeDoeToggle');
  const doePicker = document.getElementById('doePicker');
  includeDoeToggle?.addEventListener('change', (event) => {
    doePicker.style.display = event.target.checked ? 'block' : 'none';
  });

  const reportForm = document.getElementById('reportForm');
  const reportName = document.getElementById('reportName');
  const reportExecutors = document.getElementById('reportExecutors');
  const reportDoe = document.getElementById('reportDoe');
  let editingReportId = null;

  const parseJsonArray = (raw) => {
    if (!raw) return [];
    try {
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  };

  document.querySelectorAll('[data-report-edit]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const include = parseJsonArray(btn.dataset.reportInclude);
      const doe = parseJsonArray(btn.dataset.reportDoe);
      editingReportId = btn.dataset.reportId || null;
      reportName.value = btn.dataset.reportName || '';
      const currentExecutors = btn.dataset.reportExecutors || '';
      reportExecutors.value = currentExecutors || reportExecutors.dataset.defaultExecutors || '';
      reportForm.querySelectorAll('input[name="include"]').forEach((input) => {
        input.checked = include.includes(input.value);
      });
      includeDoeToggle.checked = include.includes('doe');
      doePicker.style.display = includeDoeToggle.checked ? 'block' : 'none';
      if (reportDoe) {
        Array.from(reportDoe.options).forEach((opt) => {
          opt.selected = doe.map(String).includes(opt.value);
        });
      }
      reportDialog?.showModal();
    });
  });

  document.getElementById('openReportDialog')?.addEventListener('click', () => {
    if (reportExecutors && !reportExecutors.value) {
      reportExecutors.value = reportExecutors.dataset.defaultExecutors || '';
    }
  });

  reportDialog?.addEventListener('close', () => {
    editingReportId = null;
    reportForm.reset();
    doePicker.style.display = 'none';
  });
  const generateReportBtn = document.getElementById('generateReportBtn');
  generateReportBtn?.addEventListener('click', async () => {
    if (!reportForm) return;
    const formData = new FormData(reportForm);
    const includes = formData.getAll('include').map((val) => String(val));
    const name = String(formData.get('name') || '').trim();
    const executors = String(formData.get('executors') || '').trim();
    const doeIds = formData.getAll('doe_ids').map((val) => String(val)).filter(Boolean);
    const payload = new URLSearchParams();
    if (name) payload.set('name', name);
    if (executors) payload.set('executors', executors);
    includes.forEach((val) => payload.append('include', val));
    doeIds.forEach((val) => payload.append('doe_ids', val));
    const url = editingReportId
      ? `/experiments/<%= experiment.id %>/reports/${editingReportId}`
      : `/experiments/<%= experiment.id %>/reports`;
    const resp = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    if (!resp.ok) return;
    const data = await resp.json();
    if (data?.url) window.location.href = data.url;
  });

  const ownerSelect = document.getElementById('ownerSelect');
  const ownerSaveStatus = document.getElementById('ownerSaveStatus');
  const setOwnerStatus = (text, tone) => {
    if (!ownerSaveStatus) return;
    ownerSaveStatus.textContent = text;
    ownerSaveStatus.style.color = tone || '';
  };
  ownerSelect?.addEventListener('change', async () => {
    const payload = new URLSearchParams();
    payload.set('owner_user_id', ownerSelect.value || '');
    setOwnerStatus('Saving...', '#8a5a1f');
    try {
      const resp = await fetch(`/experiments/<%= experiment.id %>/owner`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      if (!resp.ok) throw new Error('Request failed');
      setOwnerStatus('Owner updated.', '#1f7a4f');
    } catch {
      setOwnerStatus('Failed to update owner.', '#9e2b2b');
    }
  });

  const statusToggle = document.getElementById('experimentStatusToggle');
  const statusPill = document.getElementById('experimentStatusPill');
  statusToggle?.addEventListener('change', async () => {
    const done = statusToggle.checked ? '1' : '0';
    if (statusPill) {
      if (statusToggle.checked) {
        statusPill.classList.remove('status-in_progress', 'status-not_started');
        statusPill.classList.add('status-done');
        statusPill.textContent = 'Done';
      } else {
        const autoStatus = statusPill.dataset.autoStatus || 'not_started';
        const autoLabel = statusPill.dataset.autoLabel || 'Not started';
        statusPill.classList.remove('status-done', 'status-in_progress', 'status-not_started');
        statusPill.classList.add(`status-${autoStatus}`);
        statusPill.textContent = autoLabel;
      }
    }
    try {
      const payload = new URLSearchParams();
      payload.set('done', done);
      const resp = await fetch('/experiments/<%= experiment.id %>/status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'fetch' },
        body: payload
      });
      if (!resp.ok) throw new Error('Request failed');
    } catch {
      statusToggle.checked = !statusToggle.checked;
      if (statusPill) {
        if (statusToggle.checked) {
          statusPill.classList.remove('status-in_progress', 'status-not_started');
          statusPill.classList.add('status-done');
          statusPill.textContent = 'Done';
        } else {
          const autoStatus = statusPill.dataset.autoStatus || 'not_started';
          const autoLabel = statusPill.dataset.autoLabel || 'Not started';
          statusPill.classList.remove('status-done', 'status-in_progress', 'status-not_started');
          statusPill.classList.add(`status-${autoStatus}`);
          statusPill.textContent = autoLabel;
        }
      }
    }
  });

  // Tasks kanban (read-only).
  const board = document.querySelector('.kanban-board');
  const taskTitle = document.getElementById('taskTitle');
  const taskDescription = document.getElementById('taskDescription');
  const taskOwner = document.getElementById('taskOwner');
  const taskDue = document.getElementById('taskDue');
  const taskDueWrap = document.querySelector('.task-due');
  const taskProgress = document.getElementById('taskProgress');
  const taskSuggested = document.getElementById('taskSuggested');
  const taskEntities = document.getElementById('taskEntities');
  const taskEditForm = document.getElementById('taskEditForm');
  const taskEditTitle = document.getElementById('taskEditTitle');
  const taskEditDue = document.getElementById('taskEditDue');
  const taskEditDesc = document.getElementById('taskEditDesc');
  const taskEditEntities = document.getElementById('taskEditEntities');
  const taskEditSave = document.getElementById('taskEditSave');
  const taskEditEntityForm = document.getElementById('taskEditEntityForm');
  const calendarMenu = document.getElementById('calendarMenu');
  const calendarIcsLink = document.getElementById('calendarIcsLink');
  const calendarGoogleLink = document.getElementById('calendarGoogleLink');
  const toggleTaskEditEntities = document.getElementById('toggleTaskEditEntities');
  const taskEditEntitiesPanel = document.getElementById('taskEditEntitiesPanel');
  const toggleTaskCreateEntities = document.getElementById('toggleTaskCreateEntities');
  const taskCreateEntitiesPanel = document.getElementById('taskCreateEntitiesPanel');
  let currentTaskId = null;
  const notesDrawer = document.getElementById('notesDrawer');
  const notesDrawerToggle = document.getElementById('notesDrawerToggle');
  const notesJournalToggle = document.getElementById('notesJournalToggle');
  const notesDrawerClose = document.getElementById('notesDrawerClose');
  const notesOnlyCurrentToggle = document.getElementById('notesOnlyCurrentToggle');
  const notesFeed = document.getElementById('notesFeed');
  const notesFeedScroll = document.querySelector('.notes-drawer .notes-feed-scroll');
  const notesRail = document.getElementById('notesRail');
  const notesEmptyState = document.getElementById('notesEmptyState');
  const notesInput = document.getElementById('notesInput');
  const notesSendBtn = document.getElementById('notesSendBtn');
  const notesDateInput = document.getElementById('notesDateInput');
  const notesSearchInput = document.getElementById('notesSearchInput');
  const notesToolbar = notesDrawer?.querySelector('[data-notes-toolbar]') || null;
  const notesFontFamilySelect = notesToolbar?.querySelector('[data-notes-font-family]') || null;
  const notesFontSizeSelect = notesToolbar?.querySelector('[data-notes-font-size]') || null;
  const notesLineHeightSelect = notesToolbar?.querySelector('[data-notes-line-height]') || null;
  const notesPresetSelect = notesToolbar?.querySelector('[data-notes-preset]') || null;
  const notesImageToolsGroup = notesToolbar?.querySelector('[data-notes-image-tools]') || null;
  const notesTableOpsGroup = notesToolbar?.querySelector('[data-notes-table-ops]') || null;
  const notesTablePickerToggle = notesToolbar?.querySelector('[data-notes-table-picker-toggle]') || null;
  const notesTablePicker = notesToolbar?.querySelector('[data-notes-table-picker]') || null;
  const notesTablePickerGrid = notesToolbar?.querySelector('[data-notes-table-picker-grid]') || null;
  const notesTablePickerLabel = notesToolbar?.querySelector('[data-notes-table-picker-label]') || null;
  let notesEditor = null;
  let notesEditorReady = null;
  let editingNoteId = null;
  let railTooltipEl = null;
  let mathRenderer = null;
  let mathRendererLoader = null;
  let notesPickerRows = 3;
  let notesPickerCols = 3;

  function ensureRailTooltip() {
    if (railTooltipEl && document.body.contains(railTooltipEl)) return railTooltipEl;
    railTooltipEl = document.getElementById('railTooltip');
    if (!railTooltipEl) {
      railTooltipEl = document.createElement('div');
      railTooltipEl.id = 'railTooltip';
      railTooltipEl.className = 'rail-tooltip';
      document.body.appendChild(railTooltipEl);
    }
    return railTooltipEl;
  }

  function bindRailTooltip(dot, text) {
    const tip = ensureRailTooltip();
    const showAt = (x, y) => {
      tip.textContent = text;
      tip.classList.add('is-visible');
      const rect = tip.getBoundingClientRect();
      const left = Math.max(8, x - rect.width - 14);
      const top = Math.min(window.innerHeight - rect.height - 8, Math.max(8, y - rect.height / 2));
      tip.style.left = `${left}px`;
      tip.style.top = `${top}px`;
    };
    dot.addEventListener('mouseenter', (event) => showAt(event.clientX, event.clientY));
    dot.addEventListener('mousemove', (event) => showAt(event.clientX, event.clientY));
    dot.addEventListener('mouseleave', () => tip.classList.remove('is-visible'));
    dot.addEventListener('focus', () => {
      const r = dot.getBoundingClientRect();
      showAt(r.left, r.top + r.height / 2);
    });
    dot.addEventListener('blur', () => tip.classList.remove('is-visible'));
  }

  function notesEscapeHtml(value) {
    return String(value || '').replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char]));
  }

  function ensureKatexCss() {
    if (document.getElementById('katex-css')) return;
    const link = document.createElement('link');
    link.id = 'katex-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css';
    document.head.appendChild(link);
  }

  async function ensureMathRenderer() {
    if (mathRenderer) return mathRenderer;
    if (mathRendererLoader) return mathRendererLoader;
    ensureKatexCss();
    mathRendererLoader = import('https://esm.sh/katex@0.16.11/contrib/auto-render.mjs')
      .then((mod) => {
        mathRenderer = mod.default || mod.renderMathInElement || null;
        return mathRenderer;
      })
      .catch(() => null);
    return mathRendererLoader;
  }

  function renderMathInElement(el) {
    if (!el || el.dataset.mathRendered === '1') return;
    ensureMathRenderer().then((renderFn) => {
      if (!renderFn) return;
      renderFn(el, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\\\[', right: '\\\\]', display: true },
          { left: '$', right: '$', display: false },
          { left: '\\\\(', right: '\\\\)', display: false }
        ],
        throwOnError: false
      });
      el.dataset.mathRendered = '1';
    });
  }

  const setSelectValueSafe = (selectEl, value) => {
    if (!selectEl) return;
    if (!value) {
      selectEl.value = '';
      return;
    }
    const options = Array.from(selectEl.options).map((opt) => opt.value);
    selectEl.value = options.includes(value) ? value : '';
  };

  const normalizeFontFamily = (raw) => {
    if (!raw) return '';
    const first = String(raw).split(',')[0]?.trim().replace(/^['"]|['"]$/g, '') || '';
    const map = {
      'Trebuchet MS': 'Trebuchet MS',
      Georgia: 'Georgia',
      Arial: 'Arial',
      'Courier New': 'Courier New'
    };
    return map[first] || '';
  };

  const normalizeLineHeight = (raw, fontSizePx) => {
    if (!raw) return '';
    const text = String(raw).trim().toLowerCase();
    if (!text || text === 'normal') return '';
    if (text.endsWith('px') && Number.isFinite(fontSizePx) && fontSizePx > 0) {
      const px = Number.parseFloat(text);
      if (!Number.isFinite(px)) return '';
      const ratio = px / fontSizePx;
      const allowed = ['1.2', '1.35', '1.5', '1.65', '1.8', '2'];
      const nearest = allowed
        .map((v) => Number(v))
        .reduce((best, cur) => (Math.abs(cur - ratio) < Math.abs(best - ratio) ? cur : best), 1.5);
      return String(nearest);
    }
    return text;
  };

  const readSelectionComputedStyle = () => {
    const sel = window.getSelection();
    const node = sel?.anchorNode || null;
    const el = node && node.nodeType === Node.ELEMENT_NODE ? node : node?.parentElement;
    if (!el || !(el instanceof Element)) return null;
    const style = window.getComputedStyle(el);
    const fontSizeRaw = style.fontSize || '';
    const fontSizeNum = fontSizeRaw.endsWith('px') ? Number.parseFloat(fontSizeRaw) : Number.NaN;
    return {
      fontFamily: normalizeFontFamily(style.fontFamily),
      fontSize: fontSizeRaw && fontSizeRaw.endsWith('px') ? `${Math.round(fontSizeNum)}px` : '',
      lineHeight: normalizeLineHeight(style.lineHeight, fontSizeNum)
    };
  };

  async function ensureNotesEditor() {
    if (!notesInput) return null;
    if (notesEditor) return notesEditor;
    if (notesEditorReady) return notesEditorReady;
    notesEditorReady = (async () => {
      ensureKatexCss();
      const [{ Editor }, { default: StarterKit }, { default: Underline }, { default: Link }, { default: Image }, { default: TextAlign }, { Table }, { default: TableRow }, { default: TableHeader }, { default: TableCell }, { default: TaskList }, { default: TaskItem }, { default: Superscript }, { default: Subscript }, { default: Highlight }, textStyleModule, { FontFamily }, mathModule] = await Promise.all([
        import('https://esm.sh/@tiptap/core@3.19.0'),
        import('https://esm.sh/@tiptap/starter-kit@3.19.0'),
        import('https://esm.sh/@tiptap/extension-underline@3.19.0'),
        import('https://esm.sh/@tiptap/extension-link@3.19.0'),
        import('https://esm.sh/@tiptap/extension-image@3.19.0'),
        import('https://esm.sh/@tiptap/extension-text-align@3.19.0'),
        import('https://esm.sh/@tiptap/extension-table@3.19.0'),
        import('https://esm.sh/@tiptap/extension-table-row@3.19.0'),
        import('https://esm.sh/@tiptap/extension-table-header@3.19.0'),
        import('https://esm.sh/@tiptap/extension-table-cell@3.19.0'),
        import('https://esm.sh/@tiptap/extension-task-list@3.19.0'),
        import('https://esm.sh/@tiptap/extension-task-item@3.19.0'),
        import('https://esm.sh/@tiptap/extension-superscript@3.19.0'),
        import('https://esm.sh/@tiptap/extension-subscript@3.19.0'),
        import('https://esm.sh/@tiptap/extension-highlight@3.19.0'),
        import('https://esm.sh/@tiptap/extension-text-style@3.19.0'),
        import('https://esm.sh/@tiptap/extension-font-family@3.19.0'),
        import('https://esm.sh/@aarkue/tiptap-math-extension@1.4.0').catch(() => null)
      ]);
      const { TextStyle, FontSize, LineHeight } = textStyleModule;
      const MathExtension = mathModule?.default || null;
      notesEditor = new Editor({
        element: notesInput,
        editable: true,
        extensions: [
          StarterKit.configure({
            heading: { levels: [1, 2, 3] },
            link: false,
            underline: false
          }),
          Underline,
          TextStyle,
          FontFamily,
          FontSize,
          LineHeight,
          Superscript,
          Subscript,
          Highlight.configure({ multicolor: true }),
          Link.configure({ openOnClick: false }),
          Image.configure({ allowBase64: true }),
          TextAlign.configure({ types: ['heading', 'paragraph'] }),
          TaskList,
          TaskItem.configure({ nested: true }),
          Table.configure({ resizable: true }),
          TableRow,
          TableHeader,
          TableCell,
          ...(MathExtension ? [MathExtension.configure({ addInlineMath: true, evaluation: false })] : [])
        ],
        content: '<p></p>'
      });
      const syncTextControlsFromSelection = () => {
        if (!notesEditor) return;
        const textStyleAttrs = notesEditor.getAttributes('textStyle') || {};
        const paragraphAttrs = notesEditor.getAttributes('paragraph') || {};
        const headingAttrs = notesEditor.getAttributes('heading') || {};
        const computed = readSelectionComputedStyle();
        const fontFamily = textStyleAttrs.fontFamily || computed?.fontFamily || '';
        const fontSize = textStyleAttrs.fontSize || computed?.fontSize || '';
        const lineHeight = textStyleAttrs.lineHeight || paragraphAttrs.lineHeight || headingAttrs.lineHeight || computed?.lineHeight || '';
        setSelectValueSafe(notesFontFamilySelect, fontFamily);
        setSelectValueSafe(notesFontSizeSelect, fontSize);
        setSelectValueSafe(notesLineHeightSelect, lineHeight);
      };
      const syncContextToolsVisibility = () => {
        if (!notesEditor) return;
        notesImageToolsGroup?.classList.toggle('is-visible', notesEditor.isActive('image'));
        notesTableOpsGroup?.classList.toggle('is-visible', notesEditor.isActive('table'));
      };
      notesEditor.on('selectionUpdate', syncTextControlsFromSelection);
      notesEditor.on('transaction', syncTextControlsFromSelection);
      notesEditor.on('selectionUpdate', syncContextToolsVisibility);
      notesEditor.on('transaction', syncContextToolsVisibility);
      syncTextControlsFromSelection();
      syncContextToolsVisibility();
      notesEditor.view.dom.addEventListener('keydown', (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
          event.preventDefault();
          submitNoteFromDrawer(Boolean(event.shiftKey));
        }
      }, true);
        return notesEditor;
      })();
    return notesEditorReady;
  }

  const closeNotesTablePicker = () => {
    if (!notesTablePicker) return;
    notesTablePicker.hidden = true;
  };

  const paintNotesTablePicker = () => {
    if (!notesTablePickerGrid) return;
    notesTablePickerGrid.querySelectorAll('.table-picker-cell').forEach((cell) => {
      const row = Number(cell.getAttribute('data-row') || '0');
      const col = Number(cell.getAttribute('data-col') || '0');
      cell.classList.toggle('active', row <= notesPickerRows && col <= notesPickerCols);
    });
    if (notesTablePickerLabel) notesTablePickerLabel.textContent = `${notesPickerRows} x ${notesPickerCols}`;
  };

  const initNotesTablePicker = () => {
    if (!notesTablePickerGrid || notesTablePickerGrid.childElementCount > 0) return;
    for (let r = 1; r <= 10; r += 1) {
      for (let c = 1; c <= 10; c += 1) {
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'table-picker-cell';
        cell.setAttribute('data-row', String(r));
        cell.setAttribute('data-col', String(c));
        cell.setAttribute('aria-label', `Insert ${r} by ${c} table`);
        cell.addEventListener('mouseenter', () => {
          notesPickerRows = r;
          notesPickerCols = c;
          paintNotesTablePicker();
        });
        cell.addEventListener('click', async () => {
          await notesExecCommand('table', { rows: r, cols: c });
          closeNotesTablePicker();
        });
        notesTablePickerGrid.appendChild(cell);
      }
    }
    paintNotesTablePicker();
    notesTablePickerToggle?.addEventListener('click', (event) => {
      event.stopPropagation();
      if (!notesTablePicker) return;
      notesTablePicker.hidden = !notesTablePicker.hidden;
    });
    notesTablePicker?.addEventListener('click', (event) => event.stopPropagation());
    document.addEventListener('click', closeNotesTablePicker);
  };

  async function notesExecCommand(command, options = {}) {
    const editor = await ensureNotesEditor();
    if (!editor) return;
    const chain = editor.chain().focus();
    if (command === 'h1') chain.toggleHeading({ level: 1 }).run();
    if (command === 'h2') chain.toggleHeading({ level: 2 }).run();
    if (command === 'h3') chain.toggleHeading({ level: 3 }).run();
    if (command === 'bold') chain.toggleBold().run();
    if (command === 'italic') chain.toggleItalic().run();
    if (command === 'underline') chain.toggleUnderline().run();
    if (command === 'strike') chain.toggleStrike().run();
    if (command === 'highlight') chain.toggleHighlight().run();
    if (command === 'superscript') chain.toggleSuperscript().run();
    if (command === 'subscript') chain.toggleSubscript().run();
    if (command === 'bullet') chain.toggleBulletList().run();
    if (command === 'ordered') chain.toggleOrderedList().run();
    if (command === 'checklist') chain.toggleTaskList().run();
    if (command === 'quote') chain.toggleBlockquote().run();
    if (command === 'code') chain.toggleCodeBlock().run();
    if (command === 'align-left') chain.setTextAlign('left').run();
    if (command === 'align-center') chain.setTextAlign('center').run();
    if (command === 'align-right') chain.setTextAlign('right').run();
    if (command === 'align-justify') chain.setTextAlign('justify').run();
    if (command === 'hr') chain.setHorizontalRule().run();
    if (command === 'undo') chain.undo().run();
    if (command === 'redo') chain.redo().run();
    if (command === 'table') chain.insertTable({ rows: Number(options.rows) || 3, cols: Number(options.cols) || 3, withHeaderRow: true }).run();
    if (command === 'table-row-add') chain.addRowAfter().run();
    if (command === 'table-row-del') chain.deleteRow().run();
    if (command === 'table-col-add') chain.addColumnAfter().run();
    if (command === 'table-col-del') chain.deleteColumn().run();
    if (command === 'table-del') chain.deleteTable().run();
    if (command === 'link') {
      const previous = editor.getAttributes('link').href || '';
      const href = window.prompt('Link URL', previous);
      if (href === null) return;
      if (href.trim() === '') chain.extendMarkRange('link').unsetLink().run();
      else chain.extendMarkRange('link').setLink({ href: href.trim() }).run();
    }
    if (command === 'image') {
      const src = window.prompt('Image URL');
      if (!src) return;
      chain.setImage({ src: src.trim() }).run();
    }
    if (command === 'image-width-25') chain.updateAttributes('image', { width: '25%' }).run();
    if (command === 'image-width-50') chain.updateAttributes('image', { width: '50%' }).run();
    if (command === 'image-width-75') chain.updateAttributes('image', { width: '75%' }).run();
    if (command === 'image-width-100') chain.updateAttributes('image', { width: '100%' }).run();
    if (command === 'image-align-left') chain.updateAttributes('image', { align: 'left' }).run();
    if (command === 'image-align-center') chain.updateAttributes('image', { align: 'center' }).run();
    if (command === 'image-align-right') chain.updateAttributes('image', { align: 'right' }).run();
    if (command === 'image-delete' && editor.isActive('image')) chain.deleteSelection().run();
    if (command === 'math-inline') {
      const latex = window.prompt('Formula (inline)', 'x^2');
      if (!latex) return;
      chain.insertContent({ type: 'inlineMath', attrs: { latex: latex.trim(), evaluate: 'no', display: 'no' } }).run();
    }
    if (command === 'math-block') {
      const latex = window.prompt('Formula (block)', '\\\\sum_{i=1}^{n} x_i');
      if (!latex) return;
      chain.insertContent({ type: 'inlineMath', attrs: { latex: latex.trim(), evaluate: 'no', display: 'yes' } }).run();
    }
  }

  function renderNoteCard(note) {
    const entity = String(note.entity_type || 'experiment');
    const article = document.createElement('article');
    article.className = 'journal-item';
    article.dataset.noteId = String(note.id);
    article.dataset.entityType = entity;
    article.dataset.createdAt = String(note.activity_at || note.updated_at || note.created_at || '');
    article.dataset.entityHref = String(note.entity_href || '/experiments/<%= experiment.id %>');
    article.innerHTML = `
      <header class="journal-item-head">
        <a class="journal-item-title-link" href="${notesEscapeHtml(note.entity_href || '/experiments/<%= experiment.id %>')}">${notesEscapeHtml(note.display_title || note.title || '')}</a>
        <div class="journal-item-head-actions">
          <span class="small-note">${notesEscapeHtml(note.timestamp || '')}</span>
          ${note.can_edit ? '<button class="icon-button tiny" type="button" data-note-edit title="Edit note"><span class="material-symbols-rounded" aria-hidden="true">edit</span></button>' : ''}
          ${note.can_delete ? '<button class="icon-button danger tiny" type="button" data-note-delete title="Delete note"><span class="material-symbols-rounded" aria-hidden="true">delete</span></button>' : ''}
        </div>
      </header>
      <div class="journal-item-entity small-note"><span class="entity-pill entity-${notesEscapeHtml(entity)}">${notesEscapeHtml(entity)}</span> #${notesEscapeHtml(note.entity_id || '<%= experiment.id %>')}</div>
      <div class="journal-item-body">${note.body_html || ''}</div>
    `;
    renderMathInElement(article.querySelector('.journal-item-body'));
    return article;
  }

  function rebuildNotesRail() {
    if (!notesRail || !notesFeed) return;
    notesRail.innerHTML = '';
    const items = notesFeed.querySelectorAll('.journal-item:not([style*="display: none"])');
    items.forEach((item, index) => {
      const entity = item.dataset.entityType || 'experiment';
      const dot = document.createElement('button');
      dot.type = 'button';
      dot.dataset.noteId = String(item.dataset.noteId || '');
      dot.className = `journal-rail-dot entity-${entity}`;
      const title = item.querySelector('.journal-item-title-link')?.textContent?.trim() || `Note ${index + 1}`;
      const stamp = item.querySelector('.journal-item-head .small-note')?.textContent?.trim() || '';
      const tooltip = stamp ? `${title} · ${stamp}` : title;
      dot.dataset.tooltip = tooltip;
      dot.title = tooltip;
      dot.setAttribute('aria-label', tooltip);
      bindRailTooltip(dot, tooltip);
      dot.addEventListener('click', () => item.scrollIntoView({ behavior: 'smooth', block: 'start' }));
      notesRail.appendChild(dot);
    });
    updateActiveNotesRailDot();
  }

  function updateActiveNotesRailDot() {
    if (!notesRail || !notesFeed) return;
    const dots = Array.from(notesRail.querySelectorAll('.journal-rail-dot'));
    if (!dots.length) return;
    const items = Array.from(notesFeed.querySelectorAll('.journal-item')).filter((item) => item.style.display !== 'none');
    if (!items.length) {
      dots.forEach((dot) => dot.classList.remove('is-active'));
      return;
    }
    const container = notesFeedScroll;
    const viewportTop = container ? container.getBoundingClientRect().top : 0;
    const viewportHeight = container ? container.getBoundingClientRect().height : window.innerHeight;
    const anchorY = viewportTop + Math.min(viewportHeight * 0.35, 260);
    let bestItem = null;
    let bestDistance = Number.POSITIVE_INFINITY;
    for (const item of items) {
      const rect = item.getBoundingClientRect();
      if (rect.bottom <= viewportTop || rect.top >= viewportTop + viewportHeight) continue;
      if (rect.top <= anchorY && rect.bottom >= anchorY) {
        bestItem = item;
        break;
      }
      const distance = Math.abs(rect.top - anchorY);
      if (distance < bestDistance) {
        bestDistance = distance;
        bestItem = item;
      }
    }
    if (!bestItem) {
      dots.forEach((dot) => dot.classList.remove('is-active'));
      return;
    }
    const activeNoteId = String(bestItem.dataset.noteId || '');
    dots.forEach((dot) => dot.classList.toggle('is-active', String(dot.dataset.noteId || '') === activeNoteId));
  }

  async function loadNotes() {
    if (!notesFeed) return;
    const onlyCurrent = notesOnlyCurrentToggle?.checked ? '1' : '0';
    const url = `/experiments/<%= experiment.id %>/notes.json?only_current=${onlyCurrent}&entity_type=experiment&entity_id=<%= experiment.id %>`;
    const resp = await fetch(url);
    if (!resp.ok) return;
    const data = await resp.json();
    notesFeed.innerHTML = '';
    const notes = Array.isArray(data.notes) ? data.notes : [];
    if (!notes.length) {
      const empty = document.createElement('div');
      empty.className = 'small-note notes-empty';
      empty.id = 'notesEmptyState';
      empty.textContent = 'No notes yet.';
      notesFeed.appendChild(empty);
      rebuildNotesRail();
      return;
    }
    notes
      .slice()
      .sort((a, b) => new Date(b.activity_at || b.updated_at || b.created_at || 0).getTime() - new Date(a.activity_at || a.updated_at || a.created_at || 0).getTime())
      .forEach((note) => notesFeed.appendChild(renderNoteCard(note)));
    applyNotesFilters(notesSearchInput?.value || '', notesDateInput?.value || '');
    rebuildNotesRail();
    if (notesFeedScroll) {
      notesFeedScroll.scrollTop = 0;
    }
  }

  function applyNotesFilters(query, dateValue) {
    if (!notesFeed) return;
    const q = String(query || '').trim().toLowerCase();
    const date = String(dateValue || '').trim();
    notesFeed.querySelectorAll('.journal-item').forEach((item) => {
      const text = item.textContent?.toLowerCase() || '';
      const createdAt = item.dataset.createdAt || '';
      const itemDate = createdAt ? new Date(createdAt).toISOString().slice(0, 10) : '';
      const byText = !q || text.includes(q);
      const byDate = !date || date === itemDate;
      item.style.display = byText && byDate ? '' : 'none';
    });
    rebuildNotesRail();
  }

  async function submitNoteFromDrawer(forceNew = false) {
    if (!notesInput || !notesSendBtn) return;
    const editor = await ensureNotesEditor();
    if (!editor) return;
    const bodyHtml = editor.getHTML().trim();
    const bodyText = editor.getText().trim();
    if (!bodyHtml || !bodyText) return;
    notesSendBtn.disabled = true;
    const payload = new URLSearchParams();
    payload.set('body_html', bodyHtml);
    payload.set('entity_type', 'experiment');
    payload.set('entity_id', '<%= experiment.id %>');
    if (forceNew) payload.set('force_new', '1');
    const isEdit = Boolean(editingNoteId);
    const url = isEdit
      ? `/experiments/<%= experiment.id %>/notes/${editingNoteId}/update`
      : `/experiments/<%= experiment.id %>/notes`;
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      const data = await resp.json();
      if (!resp.ok || !data?.note) return;
      editor.commands.clearContent(true);
      editingNoteId = null;
      if (notesSendBtn) notesSendBtn.textContent = 'Add note';
      await loadNotes();
    } finally {
      notesSendBtn.disabled = false;
    }
  }

  notesDrawerToggle?.addEventListener('click', async () => {
    const willOpen = !notesDrawer?.classList.contains('is-open');
    notesDrawer?.classList.toggle('is-open', willOpen);
    notesDrawerToggle.setAttribute('aria-expanded', String(willOpen));
    document.body.classList.toggle('notes-drawer-open', willOpen);
    if (willOpen) {
      await loadNotes();
      if (notesFeedScroll) {
        notesFeedScroll.scrollTop = 0;
      }
      notesDrawerToggle.style.display = 'none';
      if (notesJournalToggle) notesJournalToggle.style.display = 'none';
    }
  });

  notesDrawerClose?.addEventListener('click', () => {
    notesDrawer?.classList.remove('is-open');
    notesDrawerToggle?.setAttribute('aria-expanded', 'false');
    if (notesDrawerToggle) notesDrawerToggle.style.display = '';
    if (notesJournalToggle) notesJournalToggle.style.display = '';
    document.body.classList.remove('notes-drawer-open');
  });

  notesOnlyCurrentToggle?.addEventListener('change', loadNotes);
  notesSearchInput?.addEventListener('input', () => applyNotesFilters(notesSearchInput.value, notesDateInput?.value || ''));
  notesDateInput?.addEventListener('change', () => applyNotesFilters(notesSearchInput?.value || '', notesDateInput.value));
  notesFeedScroll?.addEventListener('scroll', updateActiveNotesRailDot, { passive: true });
  window.addEventListener('resize', updateActiveNotesRailDot);
  notesFeed?.addEventListener('click', async (event) => {
    const target = event.target;
    const editButton = target && target.closest ? target.closest('[data-note-edit]') : null;
    if (editButton) {
      const card = editButton.closest('.journal-item');
      const noteId = card?.dataset?.noteId;
      if (!noteId) return;
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const body = card.querySelector('.journal-item-body');
      editor.commands.setContent(body?.innerHTML || '<p></p>', { emitUpdate: true });
      editingNoteId = noteId;
      if (notesSendBtn) notesSendBtn.textContent = 'Update note';
      editor.commands.focus('end');
      return;
    }
    const button = target && target.closest ? target.closest('[data-note-delete]') : null;
    if (!button) return;
    const card = button.closest('.journal-item');
    const noteId = card?.dataset?.noteId;
    if (!noteId) return;
    if (!window.confirm('Delete this note?')) return;
    const resp = await fetch(`/experiments/<%= experiment.id %>/notes/${noteId}/delete`, { method: 'POST' });
    if (!resp.ok) return;
    card.remove();
    if (!notesFeed.querySelector('.journal-item')) {
      notesFeed.innerHTML = '<div class="small-note">No notes yet.</div>';
    }
    rebuildNotesRail();
  });
  notesFeed?.addEventListener('change', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLInputElement) || target.type !== 'checkbox') return;
    const card = target.closest('.journal-item');
    if (!card) return;
    const noteId = card.dataset.noteId;
    if (!noteId) return;
    const items = Array.from(card.querySelectorAll('.md-checklist input[type="checkbox"]'));
    const itemIndex = items.indexOf(target);
    if (itemIndex < 0) return;
    const payload = new URLSearchParams();
    payload.set('item_index', String(itemIndex));
    payload.set('checked', target.checked ? '1' : '0');
    const resp = await fetch(`/experiments/<%= experiment.id %>/notes/${noteId}/checklist`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    const data = await resp.json().catch(() => null);
    if (!resp.ok || !data?.note) {
      target.checked = !target.checked;
      return;
    }
    await loadNotes();
  });
  notesSendBtn?.addEventListener('click', submitNoteFromDrawer);
  notesFontFamilySelect?.addEventListener('change', async () => {
    const editor = await ensureNotesEditor();
    if (!editor) return;
    const value = notesFontFamilySelect.value;
    const chain = editor.chain().focus();
    if (!value) chain.unsetFontFamily().run();
    else chain.setFontFamily(value).run();
  });
  notesFontSizeSelect?.addEventListener('change', async () => {
    const editor = await ensureNotesEditor();
    if (!editor) return;
    const value = notesFontSizeSelect.value;
    const chain = editor.chain().focus();
    if (!value) chain.unsetFontSize().run();
    else chain.setFontSize(value).run();
  });
  notesLineHeightSelect?.addEventListener('change', async () => {
    const editor = await ensureNotesEditor();
    if (!editor) return;
    const value = notesLineHeightSelect.value;
    const chain = editor.chain().focus();
    if (!value) chain.unsetLineHeight().run();
    else chain.setLineHeight(value).run();
  });
  notesPresetSelect?.addEventListener('change', async () => {
    const editor = await ensureNotesEditor();
    if (!editor) return;
    const preset = notesPresetSelect.value;
    if (preset === 'body') editor.chain().focus().setParagraph().setFontSize('16px').setLineHeight('1.5').unsetBold().unsetItalic().unsetUnderline().unsetHighlight().run();
    if (preset === 'subtitle') editor.chain().focus().setHeading({ level: 3 }).setFontSize('20px').setLineHeight('1.35').setBold().unsetItalic().unsetUnderline().unsetHighlight().run();
    if (preset === 'note') editor.chain().focus().setParagraph().setFontSize('15px').setLineHeight('1.65').unsetBold().setItalic().unsetUnderline().unsetHighlight().run();
    if (preset === 'emphasis') editor.chain().focus().setParagraph().setFontSize('18px').setLineHeight('1.5').setBold().unsetItalic().setUnderline().setHighlight().run();
    notesPresetSelect.value = '';
  });
  document.addEventListener('keydown', (event) => {
    if (!(event.ctrlKey || event.metaKey) || event.key !== 'Enter') return;
    const target = event.target;
    if (!(target instanceof Element)) return;
    if (!notesInput) return;
    const active = document.activeElement;
    const insideEditor = notesInput.contains(target) || (active instanceof Element && notesInput.contains(active));
    if (!insideEditor) return;
    event.preventDefault();
    submitNoteFromDrawer(Boolean(event.shiftKey));
  }, true);
  ensureNotesEditor();
  initNotesTablePicker();
  updateActiveNotesRailDot();
  document.querySelectorAll('[data-notes-cmd]').forEach((btn) => {
    btn.addEventListener('click', () => notesExecCommand(btn.getAttribute('data-notes-cmd') || ''));
  });

  const setCheckboxState = (selector, existingMap, type) => {
    document.querySelectorAll(selector).forEach((input) => {
      const id = String(input.value);
      const key = `${type}:${id}`;
      if (existingMap.has(key)) {
        input.checked = true;
        input.disabled = true;
        input.closest('label')?.classList.add('is-attached');
      } else {
        input.disabled = false;
        input.closest('label')?.classList.remove('is-attached');
      }
    });
  };

  async function loadTasks() {
    if (!board) return;
    const experimentId = board.dataset.experimentId;
    const resp = await fetch(`/experiments/${experimentId}/tasks`);
    if (!resp.ok) return;
    const data = await resp.json();
    const lists = new Map();
    board.querySelectorAll('[data-status]').forEach((col) => {
      const status = col.dataset.status;
      const list = col.querySelector('[data-list]');
      if (status && list) {
        list.innerHTML = '';
        lists.set(status, list);
      }
    });
    (data.tasks || []).forEach((task) => {
      const list = lists.get(task.status || 'init');
      if (!list) return;
      const card = document.createElement('button');
      card.type = 'button';
      card.className = 'kanban-card';
      card.draggable = true;
      card.dataset.taskId = String(task.id);
      const owner = task.owner_name || task.owner_email || '-';
      const due = task.due_at ? new Date(task.due_at).toLocaleDateString() : '-';
      const percent = Math.round((task.progress?.percent || 0) * 100);
      card.innerHTML = `
        <div class="kanban-card-title">${task.title}</div>
        <div class="kanban-card-meta">${owner}</div>
        <div class="kanban-card-meta">Due: ${due}</div>
        <div class="kanban-card-progress">${percent}%</div>
      `;
      card.addEventListener('dragstart', (event) => {
        event.dataTransfer?.setData('text/plain', String(task.id));
        card.classList.add('is-dragging');
      });
      card.addEventListener('dragend', () => {
        card.classList.remove('is-dragging');
      });
      card.addEventListener('click', () => openTask(task.id));
      list.appendChild(card);
    });
  }

  async function openTask(taskId) {
    if (!taskDetailDialog) return;
    const resp = await fetch(`/tasks/${taskId}`);
    if (!resp.ok) return;
    const data = await resp.json();
    currentTaskId = taskId;
    if (calendarMenu) calendarMenu.classList.remove('is-open');
    if (calendarIcsLink) calendarIcsLink.href = `/tasks/${taskId}/calendar.ics`;
    if (calendarGoogleLink) calendarGoogleLink.href = `/tasks/${taskId}/calendar/google`;
    taskTitle.textContent = data.task?.title || 'Task';
    taskDescription.textContent = data.task?.description || '';
    const owner = data.owner_name || data.owner_email || '-';
    taskOwner.textContent = owner;
    taskDue.textContent = data.task?.due_at ? new Date(data.task.due_at).toLocaleDateString() : '-';
    taskProgress.textContent = `${Math.round((data.progress?.percent || 0) * 100)}%`;
    taskSuggested.textContent = data.suggestedStatus || '-';
    taskEntities.innerHTML = '';
    (data.entities || []).forEach((entity) => {
      const row = document.createElement('div');
      row.className = 'task-entity-row';
      const signed = entity.signature_at ? 'signed' : (entity.signature_required ? 'required' : 'no');
      row.innerHTML = `
        <div>
          <strong>${entity.display_label || `#${entity.entity_id}`}</strong>
          <span class="entity-type">${entity.entity_type}</span>
        </div>
        <div>weight: ${entity.weight}</div>
        <div>status: ${entity.status}</div>
        <div>signature: ${signed}</div>
      `;
      taskEntities.appendChild(row);
    });
    taskDetailDialog.showModal();
  }

  function fillEditDialog(data) {
    if (!taskEditTitle || !taskEditDue || !taskEditDesc) return;
    taskEditTitle.value = data.task?.title || '';
    taskEditDesc.value = data.task?.description || '';
    if (data.task?.due_at) {
      const date = new Date(data.task.due_at);
      taskEditDue.value = Number.isNaN(date.getTime()) ? '' : date.toISOString().slice(0, 10);
    } else {
      taskEditDue.value = '';
    }
    const attached = new Set(
      (data.entities || []).map((entity) => `${entity.entity_type}:${entity.entity_id}`)
    );
    setCheckboxState('input[name="qual_steps_edit"]', attached, 'qualification_step');
    setCheckboxState('input[name="doe_ids_edit"]', attached, 'doe');
    setCheckboxState('input[name="report_ids_edit"]', attached, 'report');
    if (taskEditEntities) {
      taskEditEntities.innerHTML = '';
      (data.entities || []).forEach((entity) => {
        const row = document.createElement('div');
        row.className = 'task-entity-row';
        const signed = entity.signature_at ? 'signed' : (entity.signature_required ? 'required' : 'no');
        const signButton = canSignReports && entity.entity_type === 'report' && entity.signature_required && !entity.signature_at
          ? `<button class="pure-button pure-button-secondary" type="button" data-entity-sign="${entity.id}">Sign report</button>`
          : '';
        row.innerHTML = `
          <div>
            <strong>${entity.display_label || `#${entity.entity_id}`}</strong>
            <span class="entity-type">${entity.entity_type}</span>
          </div>
          <div>
            <label>weight</label>
            <input type="number" min="0" step="1" value="${entity.weight}" data-entity-weight="${entity.id}">
          </div>
          <div>status: ${entity.status}</div>
          <div>signature: ${signed}</div>
          ${signButton}
          <button class="pure-button pure-button-secondary" type="button" data-entity-delete="${entity.id}">Remove</button>
        `;
        taskEditEntities.appendChild(row);
      });
      taskEditEntities.querySelectorAll('[data-entity-sign]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const entityId = btn.getAttribute('data-entity-sign');
          if (!entityId || !currentTaskId) return;
          const payload = new URLSearchParams();
          payload.set('entity_id', entityId);
          await fetch(`/tasks/${currentTaskId}/sign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: payload
          });
          openTask(currentTaskId);
        });
      });
      taskEditEntities.querySelectorAll('[data-entity-delete]').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const entityId = btn.getAttribute('data-entity-delete');
          if (!entityId || !currentTaskId) return;
          await fetch(`/tasks/${currentTaskId}/entities/${entityId}/delete`, { method: 'POST' });
          const refreshed = await fetch(`/tasks/${currentTaskId}`);
          if (refreshed.ok) {
            const data = await refreshed.json();
            fillEditDialog(data);
          }
          loadTasks();
        });
      });
    }
  }

  openTaskEdit?.addEventListener('click', async () => {
    if (!currentTaskId || !taskEditDialog) return;
    const resp = await fetch(`/tasks/${currentTaskId}`);
    if (!resp.ok) return;
    const data = await resp.json();
    fillEditDialog(data);
    taskEditDialog.showModal();
  });

  taskEditSave?.addEventListener('click', async () => {
    if (!currentTaskId || !taskEditTitle || !taskEditDesc || !taskEditDue) return;
    const payload = new URLSearchParams();
    payload.set('title', taskEditTitle.value.trim());
    payload.set('description', taskEditDesc.value.trim());
    payload.set('due_at', taskEditDue.value || '');
    const resp = await fetch(`/tasks/${currentTaskId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    if (!resp.ok) return;
    const weightInputs = taskEditEntities?.querySelectorAll('[data-entity-weight]') || [];
    const updates = Array.from(weightInputs).map((input) => {
      const id = input.getAttribute('data-entity-weight');
      const weight = input.value;
      if (!id) return null;
      const body = new URLSearchParams();
      body.set('weight', weight);
      return fetch(`/tasks/${currentTaskId}/entities/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body
      });
    }).filter(Boolean);
    if (updates.length) await Promise.allSettled(updates);
    taskEditDialog?.close();
    openTask(currentTaskId);
    loadTasks();
  });

  taskEditEntityForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!currentTaskId) return;
    const formData = new FormData(taskEditEntityForm);
    const toAttach = [];
    formData.getAll('qual_steps_edit').forEach((val) => {
      toAttach.push({ type: 'qualification_step', id: String(val) });
    });
    formData.getAll('doe_ids_edit').forEach((val) => {
      toAttach.push({ type: 'doe', id: String(val) });
    });
    formData.getAll('report_ids_edit').forEach((val) => {
      toAttach.push({ type: 'report', id: String(val), signature: '1' });
    });
    if (!toAttach.length) return;
    const requests = toAttach.map((item) => {
      const payload = new URLSearchParams();
      payload.set('entity_type', item.type);
      payload.set('entity_id', item.id);
      if (item.signature) payload.set('signature_required', item.signature);
      return fetch(`/tasks/${currentTaskId}/entities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
    });
    await Promise.allSettled(requests);
    const refreshed = await fetch(`/tasks/${currentTaskId}`);
    if (refreshed.ok) {
      const data = await refreshed.json();
      fillEditDialog(data);
    }
    loadTasks();
  });

  taskDueWrap?.addEventListener('click', (event) => {
    const target = event.target;
    if (target && target.closest('.task-due-icon')) {
      calendarMenu?.classList.toggle('is-open');
    }
  });

  toggleTaskEditEntities?.addEventListener('click', () => {
    taskEditEntitiesPanel?.classList.toggle('is-open');
  });

  toggleTaskCreateEntities?.addEventListener('click', () => {
    taskCreateEntitiesPanel?.classList.toggle('is-open');
  });

  taskDetailDialog?.addEventListener('close', () => {
    calendarMenu?.classList.remove('is-open');
  });
  taskEditDialog?.addEventListener('close', () => {
    taskEditEntitiesPanel?.classList.remove('is-open');
  });

  board?.querySelectorAll('.kanban-column').forEach((column) => {
    column.addEventListener('dragover', (event) => {
      event.preventDefault();
      column.classList.add('is-drop-target');
    });
    column.addEventListener('dragleave', () => {
      column.classList.remove('is-drop-target');
    });
    column.addEventListener('drop', async (event) => {
      event.preventDefault();
      column.classList.remove('is-drop-target');
      const taskId = event.dataTransfer?.getData('text/plain');
      const status = column.dataset.status;
      if (!taskId || !status) return;
      const payload = new URLSearchParams();
      payload.set('status', status);
      const resp = await fetch(`/tasks/${taskId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      if (!resp.ok) return;
      loadTasks();
    });
  });

  const taskCreateForm = document.getElementById('taskCreateForm');
  taskCreateForm?.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (!board) return;
    const experimentId = board.dataset.experimentId;
    const formData = new FormData(taskCreateForm);
    const payload = new URLSearchParams(formData);
    const resp = await fetch(`/experiments/${experimentId}/tasks`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    if (!resp.ok) return;
    const data = await resp.json();
    const taskId = data?.id;
    if (taskId) {
      const qualSteps = formData.getAll('qual_steps').map((val) => String(val));
      const doeIds = formData.getAll('doe_ids').map((val) => String(val));
      const attaches = [];
      qualSteps.forEach((step) => {
        const attach = new URLSearchParams();
        attach.set('entity_type', 'qualification_step');
        attach.set('entity_id', step);
        attaches.push(fetch(`/tasks/${taskId}/entities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: attach
        }));
      });
      doeIds.forEach((doeId) => {
        const attach = new URLSearchParams();
        attach.set('entity_type', 'doe');
        attach.set('entity_id', doeId);
        attaches.push(fetch(`/tasks/${taskId}/entities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: attach
        }));
      });
      if (attaches.length) {
        await Promise.allSettled(attaches);
      }
    }
    taskCreateForm.reset();
    taskCreateEntitiesPanel?.classList.remove('is-open');
    taskCreateDialog?.close();
    loadTasks();
  });

  loadTasks();
</script>
<%- include('partials/foot') %>
