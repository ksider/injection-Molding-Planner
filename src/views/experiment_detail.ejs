<%- include('partials/head', { title: `IM Planner | ${experiment.name}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <h1 class="card-title"><%= experiment.name %></h1>
    <p class="small-note">Design: <%= experiment.design_type %> | Seed: <%= experiment.seed %></p>
    <div class="tabs">
      <a class="<%= tab === 'design' ? 'active' : '' %>" href="/experiments/<%= experiment.id %>?tab=design">Design</a>
      <a class="<%= tab === 'runs' ? 'active' : '' %>" href="/experiments/<%= experiment.id %>?tab=runs">Runs</a>
      <a class="<%= tab === 'analysis' ? 'active' : '' %>" href="/experiments/<%= experiment.id %>?tab=analysis">Analysis</a>
    </div>
  </div>

  <% if (tab === 'design') { %>
    <div class="card">
      <h2 class="card-title">Factor Setup</h2>
      <p class="small-note">Manage all parameters and custom fields from the popup.</p>
      <% if (errorMessage) { %>
        <p class="small-note"><strong><%= errorMessage %></strong></p>
      <% } %>
      <% const configMap = new Map(); configs.forEach(c => configMap.set(c.param_def_id, c)); %>
      <% const activeParams = inputParams.filter((param) => (configMap.get(param.id)?.active ?? 0) === 1); %>
      <table class="pure-table table-compact" style="margin-top: 0.75rem;">
        <thead>
          <tr>
            <th>Parameter</th>
            <th>Group</th>
            <th>Mode</th>
            <th>Values</th>
          </tr>
        </thead>
        <tbody>
          <% if (activeParams.length === 0) { %>
            <tr><td colspan="4">No active factors selected.</td></tr>
          <% } %>
          <% activeParams.forEach((param) => { const config = configMap.get(param.id); const groupKey = (param.group_label || 'General').toLowerCase().replace(/[^a-z0-9]+/g, '-'); const valuesText = config?.mode === 'RANGE' ? `${formatNumber(config?.range_min_real)} .. ${formatNumber(config?.range_max_real)}` : config?.mode === 'LIST' ? (config?.list_json ? JSON.parse(config.list_json).map((val) => formatNumber(val)).join(', ') : '-') : formatNumber(config?.fixed_value_real); %>
            <tr class="row-active">
              <td><%= param.label %></td>
              <td class="group-cell group-<%= groupKey %>"><%= param.group_label || 'General' %></td>
              <td><span class="badge"><%= config?.mode || 'FIXED' %></span></td>
              <td><%= valuesText %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
      <div style="margin-top: 1rem;">
        <button class="pure-button pure-button-secondary" type="button" id="openFactorDialog">Edit All Parameters</button>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Generate Runs</h2>
      <p class="small-note">Generation will replace existing runs for this experiment.</p>
      <p class="small-note">
        Preview: <strong><%= runPreview.totalRuns %></strong> runs
        = base <%= runPreview.baseRuns %>
        × recipes <%= runPreview.recipeMultiplier %>
        × replicates <%= runPreview.replicateMultiplier %>
      </p>
      <p class="small-note"><%= runPreview.formula %></p>
      <% if (runPreview.warning) { %>
        <p class="small-note"><strong><%= runPreview.warning %></strong></p>
      <% } %>
      <form class="pure-form" action="/experiments/<%= experiment.id %>/generate" method="post">
        <button class="pure-button pure-button-primary" type="submit">Generate Runlist</button>
      </form>
    </div>

    <dialog id="factorDialog" class="modal-frame">
      <div class="modal-header">
        <strong>All Parameters</strong>
        <button class="pure-button" type="button" data-close>Close</button>
      </div>
      <div class="modal-body">
        <% if (errorMessage) { %>
          <p class="small-note"><strong><%= errorMessage %></strong></p>
        <% } %>
        <form class="pure-form" action="/experiments/<%= experiment.id %>/configs" method="post" id="factorForm">
          <table class="pure-table table-compact">
            <thead>
              <tr>
                <th>Active</th>
                <th>Group</th>
                <th>Parameter</th>
                <th>Mode</th>
                <th>Min</th>
                <th>Max</th>
                <th>Values (Fixed/List)</th>
                <% if (experiment.design_type !== 'BBD') { %>
                  <th>Levels</th>
                <% } %>
              </tr>
            </thead>
            <tbody>
              <% inputParams.forEach((param) => { const config = configMap.get(param.id); const groupKey = (param.group_label || 'General').toLowerCase().replace(/[^a-z0-9]+/g, '-'); %>
                <% const valueText = config?.mode === 'LIST' && config?.list_json ? JSON.parse(config.list_json).join(', ') : (config?.fixed_value_real ?? ''); %>
                <tr data-param-row class="<%= config?.active ? 'row-active' : '' %>">
                  <td>
                    <input type="checkbox" name="param_<%= param.id %>_active" data-active-toggle <%= config?.active ? 'checked' : '' %>>
                  </td>
                  <td class="group-cell group-<%= groupKey %>"><%= param.group_label || 'General' %></td>
                  <td><%= param.label %> <span class="small-note">(<%= param.code %>)</span></td>
                  <td class="mode-cell mode-<%= (config?.mode || 'FIXED').toLowerCase() %>">
                    <select name="param_<%= param.id %>_mode" data-mode-select>
                      <option value="FIXED" <%= config?.mode === 'FIXED' ? 'selected' : '' %>>FIXED</option>
                      <option value="RANGE" <%= config?.mode === 'RANGE' ? 'selected' : '' %>>RANGE</option>
                      <option value="LIST" <%= config?.mode === 'LIST' ? 'selected' : '' %>>LIST</option>
                    </select>
                  </td>
                  <td><input type="number" step="any" name="param_<%= param.id %>_min" data-range value="<%= config?.range_min_real ?? '' %>"></td>
                  <td><input type="number" step="any" name="param_<%= param.id %>_max" data-range value="<%= config?.range_max_real ?? '' %>"></td>
                  <td><input type="text" name="param_<%= param.id %>_values" data-values value="<%= valueText %>"></td>
                  <% if (experiment.design_type !== 'BBD') { %>
                    <td>
                      <select name="param_<%= param.id %>_levels" data-levels>
                        <option value="2" <%= (config?.level_count || 2) === 2 ? 'selected' : '' %>>2</option>
                        <option value="3" <%= config?.level_count === 3 ? 'selected' : '' %>>3</option>
                      </select>
                    </td>
                  <% } %>
                </tr>
              <% }); %>
            </tbody>
          </table>
          <div style="margin-top: 1rem;">
            <button class="pure-button pure-button-primary" type="submit">Save Factors</button>
          </div>
        </form>

        <div class="card" style="margin-top: 1rem;">
          <h2 class="card-title">Custom Fields</h2>
          <form class="pure-form pure-form-stacked" action="/experiments/<%= experiment.id %>/params" method="post">
            <div class="grid-two">
              <div>
                <label>Code</label>
                <input type="text" name="code" placeholder="custom_param" required>
              </div>
              <div>
                <label>Label</label>
                <input type="text" name="label" placeholder="Custom Parameter" required>
              </div>
              <div>
                <label>Unit</label>
                <input type="text" name="unit">
              </div>
              <div>
                <label>Group</label>
                <input type="text" name="group_label" placeholder="Outputs">
              </div>
              <div>
                <label>Kind</label>
                <select name="field_kind">
                  <option value="INPUT">Input</option>
                  <option value="OUTPUT">Output</option>
                </select>
              </div>
              <div>
                <label>Type</label>
                <select name="field_type">
                  <option value="number">Number</option>
                  <option value="text">Text</option>
                  <option value="tag">Tag</option>
                </select>
              </div>
              <div>
                <label>Allowed Tags (comma-separated)</label>
                <input type="text" name="allowed_values" placeholder="good, ok, fail">
              </div>
            </div>
            <button class="pure-button pure-button-secondary" type="submit">Add Field</button>
          </form>
        </div>

        <div class="card" style="margin-top: 1rem;">
          <h2 class="card-title">Defect Tags</h2>
          <p class="small-note">Update allowed tags for tag fields (including defects).</p>
          <% const tagFields = outputParams.filter((param) => param.field_type === 'tag'); %>
          <% tagFields.forEach((param) => { %>
            <form class="pure-form" action="/experiments/<%= experiment.id %>/tags" method="post" style="margin-bottom: 1rem;">
              <input type="hidden" name="param_id" value="<%= param.id %>">
              <label><%= param.label %></label>
              <input type="text" name="allowed_values" value="<%= param.allowed_values_json ? JSON.parse(param.allowed_values_json).join(', ') : '' %>">
              <button class="pure-button" type="submit">Update Tags</button>
            </form>
          <% }); %>
        </div>
      </div>
      <div class="modal-footer">
        <button class="pure-button" type="button" data-close>Close</button>
      </div>
    </dialog>

    <script>
      const factorDialog = document.getElementById('factorDialog');
      const openFactorDialog = document.getElementById('openFactorDialog');
      if (openFactorDialog && factorDialog) {
        openFactorDialog.addEventListener('click', () => factorDialog.showModal());
      }
      if (factorDialog && "<%= errorMessage ? '1' : '' %>") {
        factorDialog.showModal();
      }
      document.querySelectorAll('[data-close]').forEach((btn) => {
        btn.addEventListener('click', () => factorDialog.close());
      });

      function updateRow(row) {
        const modeSelect = row.querySelector('[data-mode-select]');
        const rangeInputs = row.querySelectorAll('[data-range]');
        const valuesInput = row.querySelector('[data-values]');
        const levelsSelect = row.querySelector('[data-levels]');
        const modeCell = row.querySelector('.mode-cell');
        if (!modeSelect) return;
        const mode = modeSelect.value;
        rangeInputs.forEach((input) => { input.disabled = mode !== 'RANGE'; });
        if (valuesInput) valuesInput.disabled = mode === 'RANGE';
        if (levelsSelect) levelsSelect.disabled = mode !== 'RANGE';
        if (modeCell) {
          modeCell.classList.remove('mode-fixed', 'mode-range', 'mode-list');
          modeCell.classList.add(`mode-${mode.toLowerCase()}`);
        }
      }

      document.querySelectorAll('[data-param-row]').forEach((row) => {
        updateRow(row);
        const modeSelect = row.querySelector('[data-mode-select]');
        if (modeSelect) {
          modeSelect.addEventListener('change', () => updateRow(row));
        }
        const activeToggle = row.querySelector('[data-active-toggle]');
        if (activeToggle) {
          activeToggle.addEventListener('change', () => {
            row.classList.toggle('row-active', activeToggle.checked);
          });
        }
      });
    </script>
  <% } %>

  <% if (tab === 'runs') { %>
    <div class="card">
      <h2 class="card-title">Runs</h2>
      <div class="run-controls">
        <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/export/runs">Export Runs CSV</a>
        <a class="pure-button" href="/experiments/<%= experiment.id %>/export/wide">Export Wide CSV</a>
      </div>
      <% const recipeMap = new Map(); recipes.forEach(r => recipeMap.set(r.id, r.name)); %>
      <% const activeMap = new Map(); activeInputParams.forEach(p => activeMap.set(p.id, p)); %>
      <table class="pure-table table-compact" style="margin-top: 1rem;">
        <thead>
          <tr>
            <th>Run</th>
            <th>Recipe</th>
            <th>Done</th>
            <th>Exclude</th>
            <% activeInputParams.forEach((param) => { %>
              <th><%= param.label %> <span class="small-note"><%= param.unit || '' %></span></th>
            <% }); %>
          </tr>
        </thead>
        <tbody>
          <% if (runs.length === 0) { %>
            <tr><td colspan="<%= 4 + activeInputParams.length %>">No runs yet. Generate a runlist.</td></tr>
          <% } %>
          <% runRows.forEach((run) => { %>
            <tr class="<%= run.done ? 'run-done' : '' %> <%= run.exclude_from_analysis ? 'run-excluded' : '' %>">
              <td><a href="/runs/<%= run.id %>"><%= run.run_code %></a></td>
              <td><%= run.recipe_id ? recipeMap.get(run.recipe_id) : '-' %></td>
              <td><%= run.done ? 'Yes' : 'No' %></td>
              <td><%= run.exclude_from_analysis ? 'Yes' : 'No' %></td>
              <% activeInputParams.forEach((param) => { %>
                <td><%= formatNumber(run.values[param.id]) %></td>
              <% }); %>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>

  <% if (tab === 'analysis') { %>
    <div class="card">
      <h2 class="card-title">Analysis Controls</h2>
      <form class="pure-form pure-form-stacked" method="get" action="/experiments/<%= experiment.id %>">
        <input type="hidden" name="tab" value="analysis">
        <div class="grid-two">
          <div>
            <label>Output</label>
            <select name="output_param">
              <% outputNumericParams.forEach((param) => { %>
                <option value="<%= param.id %>" <%= analysis?.outputParamId === param.id ? 'selected' : '' %>><%= param.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>X Factor</label>
            <select name="x_param">
              <% activeInputParams.forEach((param) => { %>
                <option value="<%= param.id %>" <%= analysis?.xParamId === param.id ? 'selected' : '' %>><%= param.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Y Factor (Heatmap)</label>
            <select name="y_param">
              <% activeInputParams.forEach((param) => { %>
                <option value="<%= param.id %>" <%= analysis?.yParamId === param.id ? 'selected' : '' %>><%= param.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Recipe Filter</label>
            <select name="recipe_id">
              <option value="">All</option>
              <% recipes.forEach((recipe) => { %>
                <option value="<%= recipe.id %>" <%= analysis?.recipeId === recipe.id ? 'selected' : '' %>><%= recipe.name %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Defect Tag Filter</label>
            <input type="text" name="defect_tag" placeholder="flash" value="<%= analysis?.defectTag || '' %>">
          </div>
        </div>
        <button class="pure-button pure-button-primary" type="submit">Update Analysis</button>
      </form>
    </div>

    <div class="grid-two">
      <div class="card chart-card" id="lineChart"></div>
      <div class="card chart-card" id="heatmapChart"></div>
      <div class="card chart-card" id="scatterChart"></div>
      <div class="card chart-card" id="scatter3d"></div>
    </div>

    <div class="card">
      <h2 class="card-title">Decision Notes</h2>
      <p class="small-note">
        Trends are descriptive. Low replicate counts and missing data reduce confidence.
      </p>
      <div>
        <strong>Model (linear) R2:</strong> <%= analysis?.regression?.r2?.toFixed ? analysis.regression.r2.toFixed(3) : 'n/a' %>
      </div>
      <div>
        <strong>Overall:</strong>
        <%= Number.isFinite(analysis?.overall?.mean) ? analysis.overall.mean.toFixed(3) : 'n/a' %>
        (SD <%= Number.isFinite(analysis?.overall?.sd) ? analysis.overall.sd.toFixed(3) : 'n/a' %>,
        n=<%= analysis?.overall?.n ?? 0 %>)
      </div>
      <table class="pure-table table-compact" style="margin-top: 1rem;">
        <thead>
          <tr>
            <th>Factor Level</th>
            <th>Mean</th>
            <th>SD</th>
            <th>N</th>
          </tr>
        </thead>
        <tbody>
          <% if ((analysis?.summary || []).length === 0) { %>
            <tr><td colspan="4">No summary available.</td></tr>
          <% } %>
          <% (analysis?.summary || []).forEach((row) => { %>
            <tr>
              <td><%= row.factor %></td>
              <td><%= Number.isFinite(row.mean) ? row.mean.toFixed(3) : '-' %></td>
              <td><%= Number.isFinite(row.sd) ? row.sd.toFixed(3) : '-' %></td>
              <td><%= row.n %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <script src="/vendor/echarts/dist/echarts.min.js"></script>
    <script src="/vendor/echarts-gl/dist/echarts-gl.min.js"></script>
    <script>
      const summary = <%- JSON.stringify(analysis?.summary || []) %>;
      const heatmap = <%- JSON.stringify(analysis?.heatmap || []) %>;
      const scatter = <%- JSON.stringify(analysis?.scatter || []) %>;
      const scatter3dData = <%- JSON.stringify(analysis?.scatter3d || []) %>;

      const lineChart = echarts.init(document.getElementById('lineChart'));
      const upper = summary.map(s => s.mean + (s.sd || 0));
      const lower = summary.map(s => s.mean - (s.sd || 0));
      lineChart.setOption({
        title: { text: 'Mean vs Factor' },
        tooltip: {},
        xAxis: { type: 'category', data: summary.map(s => s.factor) },
        yAxis: { type: 'value' },
        series: [
          { type: 'line', data: summary.map(s => s.mean), smooth: true, name: 'Mean' },
          { type: 'line', data: upper, smooth: true, lineStyle: { type: 'dashed' }, name: '+SD' },
          { type: 'line', data: lower, smooth: true, lineStyle: { type: 'dashed' }, name: '-SD' }
        ]
      });

      const heatmapChart = echarts.init(document.getElementById('heatmapChart'));
      const xVals = [...new Set(heatmap.map(h => h.x))].sort((a,b) => a-b);
      const yVals = [...new Set(heatmap.map(h => h.y))].sort((a,b) => a-b);
      const heatmapData = heatmap.map(h => [xVals.indexOf(h.x), yVals.indexOf(h.y), h.mean, h.sd, h.n]);
      heatmapChart.setOption({
        title: { text: 'Heatmap' },
        tooltip: {
          formatter: (params) => {
            const [x, y, mean, sd, n] = params.data;
            return `Mean: ${mean?.toFixed ? mean.toFixed(3) : mean}<br>SD: ${sd?.toFixed ? sd.toFixed(3) : sd}<br>N: ${n}`;
          }
        },
        xAxis: { type: 'category', data: xVals },
        yAxis: { type: 'category', data: yVals },
        visualMap: { min: 0, max: 100, calculable: true, orient: 'horizontal' },
        series: [{ type: 'heatmap', data: heatmapData }]
      });

      const scatterChart = echarts.init(document.getElementById('scatterChart'));
      const recipes = [...new Set(scatter.map(s => s.recipe_id))];
      scatterChart.setOption({
        title: { text: 'Scatter' },
        tooltip: {},
        xAxis: { type: 'value' },
        yAxis: { type: 'value' },
        visualMap: {
          type: 'piecewise',
          dimension: 2,
          categories: recipes,
          inRange: { color: ['#e05f2b', '#2c7ea0', '#6a5acd', '#2f9c74'] },
          top: 30,
          right: 10
        },
        series: [{ type: 'scatter', data: scatter.map(s => [s.x, s.y, s.recipe_id]) }]
      });

      const scatter3d = echarts.init(document.getElementById('scatter3d'));
      const has3d = scatter3dData.length > 12;
      scatter3d.setOption({
        title: { text: has3d ? '3D Surface Preview' : '3D (insufficient data)' },
        tooltip: {},
        xAxis3D: { type: 'value' },
        yAxis3D: { type: 'value' },
        zAxis3D: { type: 'value' },
        grid3D: { viewControl: { projection: 'perspective' } },
        series: [
          {
            type: 'scatter3D',
            data: scatter3dData.map(h => [h.x, h.y, h.z])
          }
        ]
      });
    </script>
  <% } %>
</div>
<%- include('partials/foot') %>
