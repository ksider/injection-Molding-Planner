<%- include('partials/head', { title: `IM Planner | Journal | ${experiment.name}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="card-header card-header-main">
      <div>
        <h1 class="card-title">Lab Journal</h1>
        <div class="small-note"><a href="/experiments/<%= experiment.id %>"><%- formatInline(experiment.name) %></a></div>
      </div>
      <div class="section-actions">
        <a class="pure-button" href="/experiments/<%= experiment.id %>">Back to experiment</a>
      </div>
    </div>

    <% if (canWrite) { %>
      <div class="journal-compose" id="journalCompose">
        <div class="journal-toolbar" role="toolbar" aria-label="Markdown helpers">
          <button class="pure-button" type="button" data-wysiwyg-cmd="undo" title="Undo">↶</button>
          <button class="pure-button" type="button" data-wysiwyg-cmd="redo" title="Redo">↷</button>
          <button class="pure-button" type="button" data-wysiwyg-cmd="bold" title="Bold">B</button>
          <button class="pure-button" type="button" data-wysiwyg-cmd="italic" title="Italic">I</button>
          <button class="pure-button" type="button" data-wysiwyg-cmd="underline" title="Underline">U</button>
          <button class="pure-button" type="button" data-wysiwyg-cmd="insertUnorderedList" title="Bullet list">List</button>
          <button class="pure-button" type="button" data-wysiwyg-link title="Link">Link</button>
          <button class="pure-button" type="button" data-wysiwyg-code title="Code">Code</button>
        </div>
        <div id="journalBody" class="journal-editor" contenteditable="true" data-placeholder="Write note for this experiment..."></div>
        <div class="journal-compose-footer">
          <span class="small-note">Ctrl/Cmd+Enter: append today · Ctrl/Cmd+Shift+Enter: new note</span>
          <button class="pure-button" id="journalCancelEdit" type="button" style="display:none;">Cancel edit</button>
          <button class="pure-button pure-button-primary" id="journalSend" type="button">Add note</button>
        </div>
      </div>
    <% } %>

    <div class="journal-layout">
      <aside class="journal-rail" id="journalRail"></aside>
      <section class="journal-feed" id="journalFeed">
        <div class="notes-drawer-toolbar" style="padding:0 0 0.5rem 0; border-bottom:0;">
          <div class="journal-entity-filters" id="journalEntityFilters"></div>
          <input class="notes-search" type="date" id="journalDateFilter" title="Filter by date">
          <input class="notes-search" type="search" id="journalSearch" placeholder="Search notes">
        </div>
        <% if (!notes || notes.length === 0) { %>
          <div class="small-note notes-empty" id="journalEmpty">No notes yet.</div>
        <% } %>
        <% (notes || []).forEach((note) => { %>
          <% const noteEntityType = note.entity_type || 'experiment'; %>
          <article class="journal-item entity-<%= noteEntityType %>" data-note-id="<%= note.id %>" data-entity-type="<%= noteEntityType %>" data-created-at="<%= note.activity_at || note.updated_at || note.created_at %>" data-entity-label="<%= note.entity_label || '' %>" data-entity-href="<%= note.entity_href || `/experiments/${experiment.id}` %>">
            <header class="journal-item-head">
              <a class="journal-item-title-link" href="<%= note.entity_href || `/experiments/${experiment.id}` %>"><%- formatInline(note.display_title || note.title) %></a>
              <div class="journal-item-head-actions">
                <span class="small-note"><%= note.timestamp %></span>
                <% if (note.can_edit) { %>
                  <button class="icon-button tiny" type="button" data-note-edit title="Edit note">
                    <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                  </button>
                <% } %>
                <% if (note.can_delete) { %>
                  <button class="icon-button danger tiny" type="button" data-note-delete title="Delete note">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                <% } %>
              </div>
            </header>
            <div class="journal-item-body"><%- note.body_html %></div>
          </article>
        <% }) %>
      </section>
    </div>
  </div>
</div>

<script>
  const experimentId = <%= experiment.id %>;
  const feed = document.getElementById('journalFeed');
  const rail = document.getElementById('journalRail');
  const empty = document.getElementById('journalEmpty');
  const bodyInput = document.getElementById('journalBody');
  const sendBtn = document.getElementById('journalSend');
  const searchInput = document.getElementById('journalSearch');
  const dateInput = document.getElementById('journalDateFilter');
  const entityFilters = document.getElementById('journalEntityFilters');
  const cancelEditBtn = document.getElementById('journalCancelEdit');
  let railTooltipEl = null;
  let mathRenderer = null;
  let mathRendererLoader = null;
  let selectedEntityTypes = new Set();
  let editingNoteId = null;
  const ENTITY_TYPE_LABELS = {
    experiment: 'Experiment',
    qualification_step: 'Qualification',
    doe: 'DOE',
    run: 'Run',
    report: 'Report',
    task: 'Task'
  };

  function ensureKatexCss() {
    if (document.getElementById('katex-css')) return;
    const link = document.createElement('link');
    link.id = 'katex-css';
    link.rel = 'stylesheet';
    link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css';
    document.head.appendChild(link);
  }

  async function ensureMathRenderer() {
    if (mathRenderer) return mathRenderer;
    if (mathRendererLoader) return mathRendererLoader;
    ensureKatexCss();
    mathRendererLoader = import('https://esm.sh/katex@0.16.11/contrib/auto-render.mjs')
      .then((mod) => {
        mathRenderer = mod.default || mod.renderMathInElement || null;
        return mathRenderer;
      })
      .catch(() => null);
    return mathRendererLoader;
  }

  function renderMathInElement(el) {
    if (!el || el.dataset.mathRendered === '1') return;
    ensureMathRenderer().then((renderFn) => {
      if (!renderFn) return;
      renderFn(el, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\\\[', right: '\\\\]', display: true },
          { left: '$', right: '$', display: false },
          { left: '\\\\(', right: '\\\\)', display: false }
        ],
        throwOnError: false
      });
      el.dataset.mathRendered = '1';
    });
  }

  function ensureRailTooltip() {
    if (railTooltipEl && document.body.contains(railTooltipEl)) return railTooltipEl;
    railTooltipEl = document.getElementById('railTooltip');
    if (!railTooltipEl) {
      railTooltipEl = document.createElement('div');
      railTooltipEl.id = 'railTooltip';
      railTooltipEl.className = 'rail-tooltip';
      document.body.appendChild(railTooltipEl);
    }
    return railTooltipEl;
  }

  function bindRailTooltip(dot, text) {
    const tip = ensureRailTooltip();
    const showAt = (x, y) => {
      tip.textContent = text;
      tip.classList.add('is-visible');
      const rect = tip.getBoundingClientRect();
      const left = Math.max(8, x - rect.width - 14);
      const top = Math.min(window.innerHeight - rect.height - 8, Math.max(8, y - rect.height / 2));
      tip.style.left = `${left}px`;
      tip.style.top = `${top}px`;
    };
    dot.addEventListener('mouseenter', (event) => showAt(event.clientX, event.clientY));
    dot.addEventListener('mousemove', (event) => showAt(event.clientX, event.clientY));
    dot.addEventListener('mouseleave', () => tip.classList.remove('is-visible'));
    dot.addEventListener('focus', () => {
      const r = dot.getBoundingClientRect();
      showAt(r.left, r.top + r.height / 2);
    });
    dot.addEventListener('blur', () => tip.classList.remove('is-visible'));
  }

  function escapeHtml(value) {
    return String(value || '').replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char]));
  }

  function renderNote(note) {
    const entity = String(note.entity_type || 'experiment');
    const article = document.createElement('article');
    article.className = `journal-item entity-${entity}`;
    article.dataset.noteId = String(note.id);
    article.dataset.entityType = entity;
    article.dataset.createdAt = String(note.activity_at || note.updated_at || note.created_at || '');
    article.dataset.entityLabel = String(note.entity_label || '');
    article.dataset.entityHref = String(note.entity_href || `/experiments/${experimentId}`);
    article.innerHTML = `
      <header class="journal-item-head">
        <a class="journal-item-title-link" href="${escapeHtml(note.entity_href || `/experiments/${experimentId}`)}">${escapeHtml(note.display_title || note.title)}</a>
        <div class="journal-item-head-actions">
          <span class="small-note">${escapeHtml(note.timestamp)}</span>
          ${note.can_edit ? '<button class="icon-button tiny" type="button" data-note-edit title="Edit note"><span class="material-symbols-rounded" aria-hidden="true">edit</span></button>' : ''}
          ${note.can_delete ? '<button class="icon-button danger tiny" type="button" data-note-delete title="Delete note"><span class="material-symbols-rounded" aria-hidden="true">delete</span></button>' : ''}
        </div>
      </header>
      <div class="journal-item-entity small-note"><span class="entity-pill entity-${escapeHtml(entity)}">${escapeHtml(entity)}</span> #${escapeHtml(note.entity_id || experimentId)}</div>
      <div class="journal-item-body">${note.body_html || ''}</div>
    `;
    renderMathInElement(article.querySelector('.journal-item-body'));
    return article;
  }

  function normalizeEntitySelection() {
    if (!feed) return;
    const available = new Set(
      Array.from(feed.querySelectorAll('.journal-item'))
        .map((item) => String(item.dataset.entityType || 'experiment'))
    );
    if (!available.size) {
      selectedEntityTypes = new Set();
      return;
    }
    if (!selectedEntityTypes.size) {
      selectedEntityTypes = new Set(available);
      return;
    }
    selectedEntityTypes = new Set(Array.from(selectedEntityTypes).filter((type) => available.has(type)));
    if (!selectedEntityTypes.size) {
      selectedEntityTypes = new Set(available);
    }
  }

  function buildEntityFilters() {
    if (!entityFilters || !feed) return;
    normalizeEntitySelection();
    const entries = new Map();
    feed.querySelectorAll('.journal-item').forEach((item) => {
      const type = String(item.dataset.entityType || 'experiment');
      if (entries.has(type)) return;
      entries.set(type, ENTITY_TYPE_LABELS[type] || type);
    });
    entityFilters.innerHTML = '';
    const allBtn = document.createElement('button');
    allBtn.type = 'button';
    allBtn.className = `journal-filter-chip${selectedEntityTypes.size === entries.size ? ' is-active' : ''}`;
    allBtn.textContent = 'All';
    allBtn.addEventListener('click', () => {
      selectedEntityTypes = new Set(entries.keys());
      applyFilters(searchInput?.value || '', dateInput?.value || '');
      buildEntityFilters();
    });
    entityFilters.appendChild(allBtn);
    entries.forEach((label, type) => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className = `journal-filter-chip entity-${type}${selectedEntityTypes.has(type) ? ' is-active' : ''}`;
      button.textContent = label;
      button.title = `Toggle ${label}`;
      button.addEventListener('click', () => {
        if (selectedEntityTypes.has(type) && selectedEntityTypes.size > 1) {
          selectedEntityTypes.delete(type);
        } else if (!selectedEntityTypes.has(type)) {
          selectedEntityTypes.add(type);
        }
        applyFilters(searchInput?.value || '', dateInput?.value || '');
        buildEntityFilters();
      });
      entityFilters.appendChild(button);
    });
  }

  function buildRail() {
    if (!rail || !feed) return;
    rail.innerHTML = '';
    const notes = feed.querySelectorAll('.journal-item:not([style*="display: none"])');
    notes.forEach((item, index) => {
      const dot = document.createElement('button');
      dot.type = 'button';
      dot.dataset.noteId = String(item.dataset.noteId || '');
      const entity = item.dataset.entityType || 'experiment';
      dot.className = `journal-rail-dot entity-${entity}`;
      const title = item.querySelector('.journal-item-title-link')?.textContent?.trim() || `Note ${index + 1}`;
      const stamp = item.querySelector('.journal-item-head .small-note')?.textContent?.trim() || '';
      const tooltip = stamp ? `${title} · ${stamp}` : title;
      dot.dataset.tooltip = tooltip;
      dot.title = tooltip;
      dot.setAttribute('aria-label', tooltip);
      bindRailTooltip(dot, tooltip);
      dot.addEventListener('click', () => item.scrollIntoView({ behavior: 'smooth', block: 'start' }));
      rail.appendChild(dot);
    });
    updateActiveRailDot();
  }

  function updateActiveRailDot() {
    if (!rail || !feed) return;
    const dots = Array.from(rail.querySelectorAll('.journal-rail-dot'));
    if (!dots.length) return;
    const items = Array.from(feed.querySelectorAll('.journal-item')).filter((item) => item.style.display !== 'none');
    if (!items.length) {
      dots.forEach((dot) => dot.classList.remove('is-active'));
      return;
    }
    const anchorY = window.innerHeight * 0.35;
    let bestItem = null;
    let bestDistance = Number.POSITIVE_INFINITY;
    for (const item of items) {
      const rect = item.getBoundingClientRect();
      if (rect.bottom <= 0 || rect.top >= window.innerHeight) continue;
      if (rect.top <= anchorY && rect.bottom >= anchorY) {
        bestItem = item;
        break;
      }
      const distance = Math.abs(rect.top - anchorY);
      if (distance < bestDistance) {
        bestDistance = distance;
        bestItem = item;
      }
    }
    if (!bestItem) {
      dots.forEach((dot) => dot.classList.remove('is-active'));
      return;
    }
    const activeNoteId = String(bestItem.dataset.noteId || '');
    dots.forEach((dot) => dot.classList.toggle('is-active', String(dot.dataset.noteId || '') === activeNoteId));
  }

  function applyFilters(query, dateValue) {
    if (!feed) return;
    const q = String(query || '').trim().toLowerCase();
    const date = String(dateValue || '').trim();
    feed.querySelectorAll('.journal-item').forEach((item) => {
      const text = item.textContent?.toLowerCase() || '';
      const createdAt = item.dataset.createdAt || '';
      const entityType = String(item.dataset.entityType || 'experiment');
      const itemDate = createdAt ? new Date(createdAt).toISOString().slice(0, 10) : '';
      const byText = !q || text.includes(q);
      const byDate = !date || date === itemDate;
      const byEntity = selectedEntityTypes.has(entityType);
      item.style.display = byText && byDate && byEntity ? '' : 'none';
    });
    buildRail();
  }

  function sortFeedByActivityDesc() {
    if (!feed) return;
    const cards = Array.from(feed.querySelectorAll('.journal-item'));
    cards.sort((a, b) => {
      const at = new Date(a.dataset.createdAt || 0).getTime();
      const bt = new Date(b.dataset.createdAt || 0).getTime();
      return bt - at;
    });
    cards.forEach((card) => feed.appendChild(card));
  }

  function upsertNoteInFeed(note) {
    if (!feed) return;
    feed.querySelectorAll('.notes-empty').forEach((el) => el.remove());
    const existing = feed.querySelector(`.journal-item[data-note-id="${String(note.id)}"]`);
    const next = renderNote(note);
    if (existing) {
      existing.replaceWith(next);
    } else {
      feed.appendChild(next);
    }
    sortFeedByActivityDesc();
    buildEntityFilters();
  }

  async function submitNote(forceNew = false) {
    if (!bodyInput || !sendBtn) return;
    const bodyHtml = bodyInput.innerHTML.trim();
    if (!bodyHtml || bodyInput.textContent.trim().length === 0) return;
    sendBtn.disabled = true;
    const payload = new URLSearchParams();
    payload.set('body_html', bodyHtml);
    payload.set('entity_type', 'experiment');
    payload.set('entity_id', String(experimentId));
    if (forceNew) payload.set('force_new', '1');
    const isEdit = Boolean(editingNoteId);
    const url = isEdit
      ? `/experiments/${experimentId}/notes/${editingNoteId}/update`
      : `/experiments/${experimentId}/notes`;
    try {
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      const data = await resp.json();
      if (!resp.ok || !data?.note) return;
      upsertNoteInFeed(data.note);
      if (empty) empty.remove();
      bodyInput.innerHTML = '';
      editingNoteId = null;
      if (sendBtn) sendBtn.textContent = 'Add note';
      if (cancelEditBtn) cancelEditBtn.style.display = 'none';
      applyFilters(searchInput?.value || '', dateInput?.value || '');
      buildRail();
    } finally {
      sendBtn.disabled = false;
    }
  }

  sendBtn?.addEventListener('click', submitNote);
  cancelEditBtn?.addEventListener('click', () => {
    editingNoteId = null;
    if (bodyInput) bodyInput.innerHTML = '';
    if (sendBtn) sendBtn.textContent = 'Add note';
    if (cancelEditBtn) cancelEditBtn.style.display = 'none';
  });
  bodyInput?.addEventListener('keydown', (event) => {
    if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
      event.preventDefault();
      submitNote(Boolean(event.shiftKey));
    }
  });

  function exec(cmd, val) {
    bodyInput?.focus();
    document.execCommand(cmd, false, val);
  }

  function applyCode() {
    if (!bodyInput) return;
    const selection = window.getSelection();
    const text = selection && selection.rangeCount ? selection.toString() : '';
    exec('insertHTML', `<code>${escapeHtml(text || 'code')}</code>`);
    bodyInput.focus();
  }

  function applyLink() {
    if (!bodyInput) return;
    const url = window.prompt('Enter URL', 'https://');
    if (!url) return;
    exec('createLink', url);
  }

  document.querySelectorAll('[data-wysiwyg-cmd]').forEach((btn) => {
    btn.addEventListener('click', () => exec(btn.getAttribute('data-wysiwyg-cmd') || 'bold'));
  });
  document.querySelectorAll('[data-wysiwyg-link]').forEach((btn) => {
    btn.addEventListener('click', applyLink);
  });
  document.querySelectorAll('[data-wysiwyg-code]').forEach((btn) => {
    btn.addEventListener('click', applyCode);
  });
  feed?.addEventListener('click', async (event) => {
    const target = event.target;
    const editButton = target && target.closest ? target.closest('[data-note-edit]') : null;
    if (editButton) {
      const card = editButton.closest('.journal-item');
      const noteId = card?.dataset?.noteId;
      if (!noteId || !bodyInput) return;
      const body = card.querySelector('.journal-item-body');
      bodyInput.innerHTML = body?.innerHTML || '';
      editingNoteId = noteId;
      if (sendBtn) sendBtn.textContent = 'Update note';
      if (cancelEditBtn) cancelEditBtn.style.display = '';
      bodyInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
      bodyInput.focus();
      return;
    }
    const button = target && target.closest ? target.closest('[data-note-delete]') : null;
    if (!button) return;
    const card = button.closest('.journal-item');
    const noteId = card?.dataset?.noteId;
    if (!noteId) return;
    if (!window.confirm('Delete this note?')) return;
    const resp = await fetch(`/experiments/${experimentId}/notes/${noteId}/delete`, { method: 'POST' });
    if (!resp.ok) return;
    card.remove();
    if (!feed.querySelector('.journal-item')) {
      feed.innerHTML = '<div class="small-note notes-empty" id="journalEmpty">No notes yet.</div>';
    }
    buildEntityFilters();
    applyFilters(searchInput?.value || '', dateInput?.value || '');
  });
  feed?.addEventListener('change', async (event) => {
    const target = event.target;
    if (!(target instanceof HTMLInputElement) || target.type !== 'checkbox') return;
    const card = target.closest('.journal-item');
    if (!card) return;
    const noteId = card.dataset.noteId;
    if (!noteId) return;
    const items = Array.from(card.querySelectorAll('.md-checklist input[type="checkbox"]'));
    const itemIndex = items.indexOf(target);
    if (itemIndex < 0) return;
    const payload = new URLSearchParams();
    payload.set('item_index', String(itemIndex));
    payload.set('checked', target.checked ? '1' : '0');
    const resp = await fetch(`/experiments/${experimentId}/notes/${noteId}/checklist`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: payload
    });
    const data = await resp.json().catch(() => null);
    if (!resp.ok || !data?.note) {
      target.checked = !target.checked;
      return;
    }
    upsertNoteInFeed(data.note);
    applyFilters(searchInput?.value || '', dateInput?.value || '');
  });

  searchInput?.addEventListener('input', () => applyFilters(searchInput.value, dateInput?.value || ''));
  dateInput?.addEventListener('change', () => applyFilters(searchInput?.value || '', dateInput.value));
  window.addEventListener('scroll', updateActiveRailDot, { passive: true });
  window.addEventListener('resize', updateActiveRailDot);

  sortFeedByActivityDesc();
  buildEntityFilters();
  feed?.querySelectorAll('.journal-item-body').forEach((el) => renderMathInElement(el));
  buildRail();
  updateActiveRailDot();
</script>
<%- include('partials/foot') %>
