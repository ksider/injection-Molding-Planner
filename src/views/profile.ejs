<%- include('partials/head', { title: title }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card profile-hero">
    <div class="profile-hero-row">
      <div>
        <h1 class="card-title profile-name" id="profileName">
          <%= currentUser?.name || currentUser?.email || 'Profile' %>
        </h1>
        <div class="small-note profile-meta" id="profileMeta">
          <%= (currentUser?.role || 'user') %> · <%= currentUser?.email || '-' %>
        </div>
      </div>
      <button class="icon-btn icon-only" type="button" id="openProfileDialog" title="Edit profile">
        <span class="material-symbols-rounded">edit</span>
      </button>
    </div>
  </div>

  <dialog class="modal-frame" id="profileDialog">
    <div class="modal-header">
      <strong>Profile settings</strong>
      <button class="icon-btn icon-only" type="button" data-close title="Close">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    <div class="modal-body">
      <% if (error) { %>
        <div class="auth-error"><%= error %></div>
      <% } %>
      <% if (notice) { %>
        <div class="auth-error"><%= notice %></div>
      <% } %>
      <form class="pure-form pure-form-stacked" action="/me/name" method="post">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" value="<%= currentUser?.name ?? '' %>" placeholder="Your name">
        <button class="pure-button pure-button-primary" type="submit">Update name</button>
      </form>
      <form class="pure-form pure-form-stacked" action="/me/password" method="post" style="margin-top: 1rem;">
        <label for="current_password">Current password</label>
        <input id="current_password" name="current_password" type="password" autocomplete="current-password" required>
        <label for="new_password">New password</label>
        <input id="new_password" name="new_password" type="password" autocomplete="new-password" required>
        <label for="confirm_password">Confirm password</label>
        <input id="confirm_password" name="confirm_password" type="password" autocomplete="new-password" required>
        <button class="pure-button pure-button-primary" type="submit">Update password</button>
      </form>
    </div>
  </dialog>

  <div class="card">
    <h2 class="card-title">My Tasks</h2>
    <table class="pure-table table-compact">
      <thead>
        <tr>
          <th>Task</th>
          <th>Experiment</th>
          <th>Status</th>
          <th>Due</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody>
        <% if (!tasks || tasks.length === 0) { %>
          <tr>
            <td colspan="5">No tasks assigned.</td>
          </tr>
        <% } %>
        <% tasks.forEach((task) => { %>
          <tr>
            <td><%= task.title %></td>
            <td><a href="/experiments/<%= task.experiment_id %>"><%- formatInline(task.experiment_name) %></a></td>
            <td><%= task.status %></td>
            <td><%= task.due_at ? new Date(task.due_at).toLocaleDateString() : '-' %></td>
            <td><%= typeof task.progress_percent === 'number' ? `${task.progress_percent}%` : '-' %></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2 class="card-title">Assigned Entities</h2>
    <table class="pure-table table-compact">
      <thead>
        <tr>
          <th>Entity</th>
          <th>Experiment</th>
          <th>Assigned at</th>
          <th>Assigned by</th>
        </tr>
      </thead>
      <tbody>
        <% if (!assignedEntities || assignedEntities.length === 0) { %>
          <tr>
            <td colspan="4">No entity assignments.</td>
          </tr>
        <% } %>
        <% assignedEntities.forEach((item) => { %>
          <tr>
            <td><a href="<%= item.entityPath %>"><%- formatInline(item.entityTitle) %></a></td>
            <td><a href="/experiments/<%= item.experiment_id %>"><%- formatInline(item.experiment_name) %></a></td>
            <td><%= new Date(item.updated_at || item.assigned_at).toLocaleString() %></td>
            <td><%- formatInline(item.assigned_by_name || item.assigned_by_email || '-') %></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <div class="card" id="notifications">
    <div class="card-header">
      <h2 class="card-title">Notifications</h2>
      <form class="pure-form" action="/me/notifications/read-all" method="post">
        <button class="pure-button" type="submit">Mark all as read</button>
      </form>
    </div>
    <table class="pure-table table-compact">
      <thead>
        <tr>
          <th>Status</th>
          <th>Message</th>
          <th>Time</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <% if (!notifications || notifications.length === 0) { %>
          <tr>
            <td colspan="4">No notifications.</td>
          </tr>
        <% } %>
        <% notifications.forEach((note) => { %>
          <tr>
            <td><span class="status-pill status-<%= note.status === 'unread' ? 'in_progress' : 'done' %>"><%= note.status %></span></td>
            <td>
              <strong><%- formatInline(note.title) %></strong>
              <% if (note.body) { %>
                <div class="small-note"><%- formatInline(note.body) %></div>
              <% } %>
              <% if (note.path) { %>
                <div><a href="<%= note.path %>">Open</a></div>
              <% } %>
            </td>
            <td><%= new Date(note.created_at).toLocaleString() %></td>
            <td>
              <% if (note.status === 'unread') { %>
                <form class="pure-form" action="/me/notifications/<%= note.id %>/read" method="post">
                  <button class="pure-button pure-button-secondary" type="submit">Mark read</button>
                </form>
              <% } %>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>

  <div class="card">
    <h2 class="card-title">My Experiments</h2>
    <table class="pure-table table-compact">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Status</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        <% if (experiments.length === 0) { %>
          <tr>
            <td colspan="4">No experiments assigned.</td>
          </tr>
        <% } %>
        <% experiments.forEach((exp) => { %>
          <tr>
            <td><%= exp.id %></td>
            <td><a href="/experiments/<%= exp.id %>"><%- formatInline(exp.name) %></a></td>
            <td><span class="status-pill status-<%= exp.status %>"><%= exp.statusLabel %></span></td>
            <td><%= new Date(exp.created_at).toLocaleDateString() %></td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</div>
<%- include('partials/foot') %>
<script>
  const profileDialog = document.getElementById('profileDialog');
  const openProfileDialog = document.getElementById('openProfileDialog');
  if (openProfileDialog && profileDialog) {
    openProfileDialog.addEventListener('click', () => profileDialog.showModal());
  }
  profileDialog?.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => profileDialog.close());
  });

  const nameInput = document.getElementById('name');
  const nameOutput = document.getElementById('profileName');
  const metaOutput = document.getElementById('profileMeta');
  const emailValue = "<%= (currentUser?.email ?? '').replace(/\"/g, '&quot;') %>";
  const roleValue = "<%= (currentUser?.role ?? 'user').replace(/\"/g, '&quot;') %>";
  const syncProfile = () => {
    if (!nameInput || !nameOutput || !metaOutput) return;
    const nextName = nameInput.value.trim();
    nameOutput.textContent = nextName || emailValue || 'Profile';
    metaOutput.textContent = `${roleValue} · ${emailValue || '-'}`;
  };
  nameInput?.addEventListener('input', syncProfile);
  syncProfile();

  if ("<%= error ? '1' : '' %>" || "<%= notice ? '1' : '' %>") {
    profileDialog?.showModal();
  }
</script>
