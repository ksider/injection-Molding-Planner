<a
  class="icon-button notes-journal-toggle"
  href="/experiments/<%= experimentId %>/journal"
  title="Open journal"
>
  <span class="material-symbols-rounded" aria-hidden="true">menu_book</span>
</a>
<button
  class="icon-button notes-drawer-toggle"
  type="button"
  data-entity-notes-toggle
  aria-expanded="false"
  title="Notes"
>
  <span class="material-symbols-rounded" aria-hidden="true">expand_less</span>
</button>

<aside
  class="notes-drawer"
  data-entity-notes-drawer
  data-experiment-id="<%= experimentId %>"
  data-entity-type="<%= entityType %>"
  data-entity-id="<%= entityId %>"
  aria-label="Entity notes"
>
  <div class="notes-drawer-head notes-drawer-head-inline">
    <strong><%= title || 'Notes' %></strong>
    <label class="toggle" title="Filter notes by this entity">
      <input type="checkbox" data-entity-only-current checked>
      <span class="track"></span>
      <span>Only this entity</span>
    </label>
    <span class="small-note"><%= entityType %> #<%= entityId %></span>
    <input class="notes-search" type="date" data-entity-notes-date title="Filter by date">
    <input class="notes-search" type="search" data-entity-notes-search placeholder="Search notes">
    <div class="section-actions">
      <a class="icon-button" href="/experiments/<%= experimentId %>/journal" title="Open journal">
        <span class="material-symbols-rounded" aria-hidden="true">menu_book</span>
      </a>
      <button class="icon-button" type="button" data-entity-notes-close title="Hide notes">
        <span class="material-symbols-rounded" aria-hidden="true">expand_more</span>
      </button>
    </div>
  </div>

  <div class="notes-drawer-body <%= canWrite ? 'has-compose' : 'no-compose' %>">
    <aside class="journal-rail" data-entity-notes-rail></aside>
    <% if (canWrite) { %>
      <section class="notes-pane notes-pane-compose">
        <div class="notes-compose">
          <div class="editor-toolbar notes-editor-toolbar" data-entity-notes-toolbar role="toolbar" aria-label="Notes formatting">
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="undo" title="Undo"><span class="material-symbols-rounded">undo</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="redo" title="Redo"><span class="material-symbols-rounded">redo</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <select class="toolbar-select" data-entity-notes-font-family title="Font family">
              <option value="">Font</option>
              <option value="Trebuchet MS">Trebuchet</option>
              <option value="Georgia">Georgia</option>
              <option value="Arial">Arial</option>
              <option value="Courier New">Courier</option>
            </select>
            <select class="toolbar-select" data-entity-notes-font-size title="Font size">
              <option value="">Size</option>
              <option value="12px">12</option>
              <option value="14px">14</option>
              <option value="16px">16</option>
              <option value="18px">18</option>
              <option value="20px">20</option>
              <option value="24px">24</option>
              <option value="28px">28</option>
            </select>
            <select class="toolbar-select" data-entity-notes-line-height title="Line height">
              <option value="">Line</option>
              <option value="1.2">1.2</option>
              <option value="1.35">1.35</option>
              <option value="1.5">1.5</option>
              <option value="1.65">1.65</option>
              <option value="1.8">1.8</option>
              <option value="2">2</option>
            </select>
            <select class="toolbar-select" data-entity-notes-preset title="Text style preset">
              <option value="">Preset</option>
              <option value="body">Body</option>
              <option value="subtitle">Subtitle</option>
              <option value="note">Note</option>
              <option value="emphasis">Emphasis</option>
            </select>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm" type="button" data-entity-notes-cmd="h1">H1</button>
            <button class="pure-button button-sm" type="button" data-entity-notes-cmd="h2">H2</button>
            <button class="pure-button button-sm" type="button" data-entity-notes-cmd="h3">H3</button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="bold" title="Bold"><span class="material-symbols-rounded">format_bold</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="italic" title="Italic"><span class="material-symbols-rounded">format_italic</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="underline" title="Underline"><span class="material-symbols-rounded">format_underlined</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="strike" title="Strike"><span class="material-symbols-rounded">strikethrough_s</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="highlight" title="Highlight"><span class="material-symbols-rounded">ink_highlighter</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="superscript" title="Superscript"><span class="material-symbols-rounded">superscript</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="subscript" title="Subscript"><span class="material-symbols-rounded">subscript</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="bullet" title="Bullet list"><span class="material-symbols-rounded">format_list_bulleted</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="ordered" title="Ordered list"><span class="material-symbols-rounded">format_list_numbered</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="checklist" title="Checklist"><span class="material-symbols-rounded">checklist</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="quote" title="Quote"><span class="material-symbols-rounded">format_quote</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="code" title="Code block"><span class="material-symbols-rounded">code_blocks</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="hr" title="Divider"><span class="material-symbols-rounded">horizontal_rule</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="math-inline" title="Inline formula"><span class="material-symbols-rounded">functions</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="math-block" title="Block formula"><span class="material-symbols-rounded">calculate</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="align-left" title="Align left"><span class="material-symbols-rounded">format_align_left</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="align-center" title="Align center"><span class="material-symbols-rounded">format_align_center</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="align-right" title="Align right"><span class="material-symbols-rounded">format_align_right</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="align-justify" title="Justify"><span class="material-symbols-rounded">format_align_justify</span></button>
            <span class="toolbar-sep" aria-hidden="true"></span>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="link" title="Link"><span class="material-symbols-rounded">link</span></button>
            <button class="pure-button button-sm icon-only" type="button" data-entity-notes-cmd="image" title="Image"><span class="material-symbols-rounded">image</span></button>
            <div class="image-tools toolbar-conditional" data-entity-notes-image-tools title="Image tools">
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-width-25" title="Image width 25%">25%</button>
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-width-50" title="Image width 50%">50%</button>
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-width-75" title="Image width 75%">75%</button>
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-width-100" title="Image width 100%">100%</button>
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-align-left" title="Align image left">L</button>
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-align-center" title="Align image center">C</button>
              <button class="pure-button button-sm image-op" type="button" data-entity-notes-cmd="image-align-right" title="Align image right">R</button>
              <button class="pure-button button-sm image-op danger" type="button" data-entity-notes-cmd="image-delete" title="Delete image">Del</button>
            </div>
            <div class="table-tools" title="Table tools">
              <button class="pure-button button-sm icon-only" type="button" data-entity-notes-table-picker-toggle title="Insert table">
                <span class="material-symbols-rounded">table</span>
              </button>
              <div class="table-picker" data-entity-notes-table-picker hidden>
                <div class="table-picker-label" data-entity-notes-table-picker-label>3 x 3</div>
                <div class="table-picker-grid" data-entity-notes-table-picker-grid></div>
              </div>
              <div class="table-ops toolbar-conditional" data-entity-notes-table-ops>
                <button class="pure-button button-sm table-op" type="button" data-entity-notes-cmd="table-row-add" title="Add row">R+</button>
                <button class="pure-button button-sm table-op" type="button" data-entity-notes-cmd="table-row-del" title="Delete row">R-</button>
                <button class="pure-button button-sm table-op" type="button" data-entity-notes-cmd="table-col-add" title="Add column">C+</button>
                <button class="pure-button button-sm table-op" type="button" data-entity-notes-cmd="table-col-del" title="Delete column">C-</button>
                <button class="pure-button button-sm table-op danger" type="button" data-entity-notes-cmd="table-del" title="Delete table">Del</button>
              </div>
            </div>
          </div>
          <div class="journal-editor" contenteditable="true" data-entity-notes-input data-placeholder="Write note for this entity..."></div>
          <div class="notes-compose-footer">
            <span class="small-note">Ctrl/Cmd+Enter: append today · Ctrl/Cmd+Shift+Enter: new note</span>
            <button class="pure-button pure-button-primary" type="button" data-entity-notes-send>Add note</button>
          </div>
        </div>
      </section>
    <% } %>
    <section class="notes-pane notes-pane-feed">
      <section class="notes-feed-scroll">
        <div class="journal-feed" data-entity-notes-feed>
          <div class="small-note">Loading...</div>
        </div>
      </section>
    </section>
  </div>
</aside>

<script>
  (() => {
    const drawer = document.currentScript?.previousElementSibling;
    const toggle = drawer?.previousElementSibling;
    const journalToggle = toggle?.previousElementSibling && toggle.previousElementSibling.matches('.notes-journal-toggle')
      ? toggle.previousElementSibling
      : null;
    if (!drawer || !drawer.matches('[data-entity-notes-drawer]')) return;
    const experimentId = drawer.getAttribute('data-experiment-id');
    const entityType = drawer.getAttribute('data-entity-type') || 'experiment';
    const entityId = drawer.getAttribute('data-entity-id') || experimentId;

    const closeBtn = drawer.querySelector('[data-entity-notes-close]');
    const onlyCurrent = drawer.querySelector('[data-entity-only-current]');
    const searchInput = drawer.querySelector('[data-entity-notes-search]');
    const dateInput = drawer.querySelector('[data-entity-notes-date]');
    const rail = drawer.querySelector('[data-entity-notes-rail]');
    const feed = drawer.querySelector('[data-entity-notes-feed]');
    const feedScroll = drawer.querySelector('.notes-feed-scroll');
    const input = drawer.querySelector('[data-entity-notes-input]');
    const sendBtn = drawer.querySelector('[data-entity-notes-send]');
    const toolbar = drawer.querySelector('[data-entity-notes-toolbar]');
    const fontFamilySelect = toolbar?.querySelector('[data-entity-notes-font-family]') || null;
    const fontSizeSelect = toolbar?.querySelector('[data-entity-notes-font-size]') || null;
    const lineHeightSelect = toolbar?.querySelector('[data-entity-notes-line-height]') || null;
    const presetSelect = toolbar?.querySelector('[data-entity-notes-preset]') || null;
    const imageToolsGroup = toolbar?.querySelector('[data-entity-notes-image-tools]') || null;
    const tableOpsGroup = toolbar?.querySelector('[data-entity-notes-table-ops]') || null;
    const tablePickerToggle = toolbar?.querySelector('[data-entity-notes-table-picker-toggle]') || null;
    const tablePicker = toolbar?.querySelector('[data-entity-notes-table-picker]') || null;
    const tablePickerGrid = toolbar?.querySelector('[data-entity-notes-table-picker-grid]') || null;
    const tablePickerLabel = toolbar?.querySelector('[data-entity-notes-table-picker-label]') || null;
    let notesEditor = null;
    let notesEditorReady = null;
    let railTooltipEl = null;
    let mathRenderer = null;
    let mathRendererLoader = null;
    let pickerRows = 3;
    let pickerCols = 3;
    let editingNoteId = null;

    const ensureRailTooltip = () => {
      if (railTooltipEl && document.body.contains(railTooltipEl)) return railTooltipEl;
      railTooltipEl = document.getElementById('railTooltip');
      if (!railTooltipEl) {
        railTooltipEl = document.createElement('div');
        railTooltipEl.id = 'railTooltip';
        railTooltipEl.className = 'rail-tooltip';
        document.body.appendChild(railTooltipEl);
      }
      return railTooltipEl;
    };

    const bindRailTooltip = (dot, text) => {
      const tip = ensureRailTooltip();
      const showAt = (x, y) => {
        tip.textContent = text;
        tip.classList.add('is-visible');
        const rect = tip.getBoundingClientRect();
        const left = Math.max(8, x - rect.width - 14);
        const top = Math.min(window.innerHeight - rect.height - 8, Math.max(8, y - rect.height / 2));
        tip.style.left = `${left}px`;
        tip.style.top = `${top}px`;
      };
      dot.addEventListener('mouseenter', (event) => showAt(event.clientX, event.clientY));
      dot.addEventListener('mousemove', (event) => showAt(event.clientX, event.clientY));
      dot.addEventListener('mouseleave', () => tip.classList.remove('is-visible'));
      dot.addEventListener('focus', () => {
        const r = dot.getBoundingClientRect();
        showAt(r.left, r.top + r.height / 2);
      });
      dot.addEventListener('blur', () => tip.classList.remove('is-visible'));
    };

    const esc = (value) =>
      String(value || '').replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char]));

    const setSelectValueSafe = (selectEl, value) => {
      if (!selectEl) return;
      if (!value) {
        selectEl.value = '';
        return;
      }
      const options = Array.from(selectEl.options).map((opt) => opt.value);
      selectEl.value = options.includes(value) ? value : '';
    };

    const normalizeFontFamily = (raw) => {
      if (!raw) return '';
      const first = String(raw).split(',')[0]?.trim().replace(/^['"]|['"]$/g, '') || '';
      const map = { 'Trebuchet MS': 'Trebuchet MS', Georgia: 'Georgia', Arial: 'Arial', 'Courier New': 'Courier New' };
      return map[first] || '';
    };

    const normalizeLineHeight = (raw, fontSizePx) => {
      if (!raw) return '';
      const text = String(raw).trim().toLowerCase();
      if (!text || text === 'normal') return '';
      if (text.endsWith('px') && Number.isFinite(fontSizePx) && fontSizePx > 0) {
        const px = Number.parseFloat(text);
        if (!Number.isFinite(px)) return '';
        const ratio = px / fontSizePx;
        const allowed = ['1.2', '1.35', '1.5', '1.65', '1.8', '2'];
        const nearest = allowed.map((v) => Number(v)).reduce((best, cur) => (Math.abs(cur - ratio) < Math.abs(best - ratio) ? cur : best), 1.5);
        return String(nearest);
      }
      return text;
    };

    const readSelectionComputedStyle = () => {
      const sel = window.getSelection();
      const node = sel?.anchorNode || null;
      const el = node && node.nodeType === Node.ELEMENT_NODE ? node : node?.parentElement;
      if (!el || !(el instanceof Element)) return null;
      const style = window.getComputedStyle(el);
      const fontSizeRaw = style.fontSize || '';
      const fontSizeNum = fontSizeRaw.endsWith('px') ? Number.parseFloat(fontSizeRaw) : Number.NaN;
      return {
        fontFamily: normalizeFontFamily(style.fontFamily),
        fontSize: fontSizeRaw && fontSizeRaw.endsWith('px') ? `${Math.round(fontSizeNum)}px` : '',
        lineHeight: normalizeLineHeight(style.lineHeight, fontSizeNum)
      };
    };

    const ensureKatexCss = () => {
      if (document.getElementById('katex-css')) return;
      const link = document.createElement('link');
      link.id = 'katex-css';
      link.rel = 'stylesheet';
      link.href = 'https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css';
      document.head.appendChild(link);
    };

    const ensureMathRenderer = async () => {
      if (mathRenderer) return mathRenderer;
      if (mathRendererLoader) return mathRendererLoader;
      ensureKatexCss();
      mathRendererLoader = import('https://esm.sh/katex@0.16.11/contrib/auto-render.mjs')
        .then((mod) => {
          mathRenderer = mod.default || mod.renderMathInElement || null;
          return mathRenderer;
        })
        .catch(() => null);
      return mathRendererLoader;
    };

    const renderMathInElement = (el) => {
      if (!el || el.dataset.mathRendered === '1') return;
      ensureMathRenderer().then((renderFn) => {
        if (!renderFn) return;
        renderFn(el, {
          delimiters: [
            { left: '$$', right: '$$', display: true },
            { left: '\\\\[', right: '\\\\]', display: true },
            { left: '$', right: '$', display: false },
            { left: '\\\\(', right: '\\\\)', display: false }
          ],
          throwOnError: false
        });
        el.dataset.mathRendered = '1';
      });
    };

    const ensureNotesEditor = async () => {
      if (!input) return null;
      if (notesEditor) return notesEditor;
      if (notesEditorReady) return notesEditorReady;
      notesEditorReady = (async () => {
        ensureKatexCss();
        const [{ Editor }, { default: StarterKit }, { default: Underline }, { default: Link }, { default: Image }, { default: TextAlign }, { Table }, { default: TableRow }, { default: TableHeader }, { default: TableCell }, { default: TaskList }, { default: TaskItem }, { default: Superscript }, { default: Subscript }, { default: Highlight }, textStyleModule, { FontFamily }, mathModule] = await Promise.all([
          import('https://esm.sh/@tiptap/core@3.19.0'),
          import('https://esm.sh/@tiptap/starter-kit@3.19.0'),
          import('https://esm.sh/@tiptap/extension-underline@3.19.0'),
          import('https://esm.sh/@tiptap/extension-link@3.19.0'),
          import('https://esm.sh/@tiptap/extension-image@3.19.0'),
          import('https://esm.sh/@tiptap/extension-text-align@3.19.0'),
          import('https://esm.sh/@tiptap/extension-table@3.19.0'),
          import('https://esm.sh/@tiptap/extension-table-row@3.19.0'),
          import('https://esm.sh/@tiptap/extension-table-header@3.19.0'),
          import('https://esm.sh/@tiptap/extension-table-cell@3.19.0'),
          import('https://esm.sh/@tiptap/extension-task-list@3.19.0'),
          import('https://esm.sh/@tiptap/extension-task-item@3.19.0'),
          import('https://esm.sh/@tiptap/extension-superscript@3.19.0'),
          import('https://esm.sh/@tiptap/extension-subscript@3.19.0'),
          import('https://esm.sh/@tiptap/extension-highlight@3.19.0'),
          import('https://esm.sh/@tiptap/extension-text-style@3.19.0'),
          import('https://esm.sh/@tiptap/extension-font-family@3.19.0'),
          import('https://esm.sh/@aarkue/tiptap-math-extension@1.4.0').catch(() => null)
        ]);
        const { TextStyle, FontSize, LineHeight } = textStyleModule;
        const MathExtension = mathModule?.default || null;
        notesEditor = new Editor({
          element: input,
          editable: true,
          extensions: [
            StarterKit.configure({
              heading: { levels: [1, 2, 3] },
              link: false,
              underline: false
            }),
            Underline,
            TextStyle,
            FontFamily,
            FontSize,
            LineHeight,
            Superscript,
            Subscript,
            Highlight.configure({ multicolor: true }),
            Link.configure({ openOnClick: false }),
            Image.configure({ allowBase64: true }),
            TextAlign.configure({ types: ['heading', 'paragraph'] }),
            TaskList,
            TaskItem.configure({ nested: true }),
            Table.configure({ resizable: true }),
            TableRow,
            TableHeader,
            TableCell,
            ...(MathExtension ? [MathExtension.configure({ addInlineMath: true, evaluation: false })] : [])
          ],
          content: '<p></p>'
        });
        const syncTextControlsFromSelection = () => {
          if (!notesEditor) return;
          const textStyleAttrs = notesEditor.getAttributes('textStyle') || {};
          const paragraphAttrs = notesEditor.getAttributes('paragraph') || {};
          const headingAttrs = notesEditor.getAttributes('heading') || {};
          const computed = readSelectionComputedStyle();
          const fontFamily = textStyleAttrs.fontFamily || computed?.fontFamily || '';
          const fontSize = textStyleAttrs.fontSize || computed?.fontSize || '';
          const lineHeight = textStyleAttrs.lineHeight || paragraphAttrs.lineHeight || headingAttrs.lineHeight || computed?.lineHeight || '';
          setSelectValueSafe(fontFamilySelect, fontFamily);
          setSelectValueSafe(fontSizeSelect, fontSize);
          setSelectValueSafe(lineHeightSelect, lineHeight);
        };
        const syncContextToolsVisibility = () => {
          if (!notesEditor) return;
          imageToolsGroup?.classList.toggle('is-visible', notesEditor.isActive('image'));
          tableOpsGroup?.classList.toggle('is-visible', notesEditor.isActive('table'));
        };
        notesEditor.on('selectionUpdate', syncTextControlsFromSelection);
        notesEditor.on('transaction', syncTextControlsFromSelection);
        notesEditor.on('selectionUpdate', syncContextToolsVisibility);
        notesEditor.on('transaction', syncContextToolsVisibility);
        syncTextControlsFromSelection();
        syncContextToolsVisibility();
        notesEditor.view.dom.addEventListener('keydown', (event) => {
          if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
            event.preventDefault();
            submit(Boolean(event.shiftKey));
          }
        }, true);
        return notesEditor;
      })();
      return notesEditorReady;
    };

    const closeTablePicker = () => {
      if (!tablePicker) return;
      tablePicker.hidden = true;
    };

    const paintTablePicker = () => {
      if (!tablePickerGrid) return;
      tablePickerGrid.querySelectorAll('.table-picker-cell').forEach((cell) => {
        const row = Number(cell.getAttribute('data-row') || '0');
        const col = Number(cell.getAttribute('data-col') || '0');
        cell.classList.toggle('active', row <= pickerRows && col <= pickerCols);
      });
      if (tablePickerLabel) tablePickerLabel.textContent = `${pickerRows} x ${pickerCols}`;
    };

    const initTablePicker = () => {
      if (!tablePickerGrid || tablePickerGrid.childElementCount > 0) return;
      for (let r = 1; r <= 10; r += 1) {
        for (let c = 1; c <= 10; c += 1) {
          const cell = document.createElement('button');
          cell.type = 'button';
          cell.className = 'table-picker-cell';
          cell.setAttribute('data-row', String(r));
          cell.setAttribute('data-col', String(c));
          cell.setAttribute('aria-label', `Insert ${r} by ${c} table`);
          cell.addEventListener('mouseenter', () => {
            pickerRows = r;
            pickerCols = c;
            paintTablePicker();
          });
          cell.addEventListener('click', async () => {
            await execEditorCommand('table', { rows: r, cols: c });
            closeTablePicker();
          });
          tablePickerGrid.appendChild(cell);
        }
      }
      paintTablePicker();
      tablePickerToggle?.addEventListener('click', (event) => {
        event.stopPropagation();
        if (!tablePicker) return;
        tablePicker.hidden = !tablePicker.hidden;
      });
      tablePicker?.addEventListener('click', (event) => event.stopPropagation());
      document.addEventListener('click', closeTablePicker);
    };

    const execEditorCommand = async (command, options = {}) => {
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const chain = editor.chain().focus();
      if (command === 'h1') chain.toggleHeading({ level: 1 }).run();
      if (command === 'h2') chain.toggleHeading({ level: 2 }).run();
      if (command === 'h3') chain.toggleHeading({ level: 3 }).run();
      if (command === 'bold') chain.toggleBold().run();
      if (command === 'italic') chain.toggleItalic().run();
      if (command === 'underline') chain.toggleUnderline().run();
      if (command === 'strike') chain.toggleStrike().run();
      if (command === 'highlight') chain.toggleHighlight().run();
      if (command === 'superscript') chain.toggleSuperscript().run();
      if (command === 'subscript') chain.toggleSubscript().run();
      if (command === 'bullet') chain.toggleBulletList().run();
      if (command === 'ordered') chain.toggleOrderedList().run();
      if (command === 'checklist') chain.toggleTaskList().run();
      if (command === 'quote') chain.toggleBlockquote().run();
      if (command === 'code') chain.toggleCodeBlock().run();
      if (command === 'align-left') chain.setTextAlign('left').run();
      if (command === 'align-center') chain.setTextAlign('center').run();
      if (command === 'align-right') chain.setTextAlign('right').run();
      if (command === 'align-justify') chain.setTextAlign('justify').run();
      if (command === 'hr') chain.setHorizontalRule().run();
      if (command === 'undo') chain.undo().run();
      if (command === 'redo') chain.redo().run();
      if (command === 'table') chain.insertTable({ rows: Number(options.rows) || 3, cols: Number(options.cols) || 3, withHeaderRow: true }).run();
      if (command === 'table-row-add') chain.addRowAfter().run();
      if (command === 'table-row-del') chain.deleteRow().run();
      if (command === 'table-col-add') chain.addColumnAfter().run();
      if (command === 'table-col-del') chain.deleteColumn().run();
      if (command === 'table-del') chain.deleteTable().run();
      if (command === 'link') {
        const previous = editor.getAttributes('link').href || '';
        const href = window.prompt('Link URL', previous);
        if (href === null) return;
        if (href.trim() === '') chain.extendMarkRange('link').unsetLink().run();
        else chain.extendMarkRange('link').setLink({ href: href.trim() }).run();
      }
      if (command === 'image') {
        const src = window.prompt('Image URL');
        if (!src) return;
        chain.setImage({ src: src.trim() }).run();
      }
      if (command === 'image-width-25') chain.updateAttributes('image', { width: '25%' }).run();
      if (command === 'image-width-50') chain.updateAttributes('image', { width: '50%' }).run();
      if (command === 'image-width-75') chain.updateAttributes('image', { width: '75%' }).run();
      if (command === 'image-width-100') chain.updateAttributes('image', { width: '100%' }).run();
      if (command === 'image-align-left') chain.updateAttributes('image', { align: 'left' }).run();
      if (command === 'image-align-center') chain.updateAttributes('image', { align: 'center' }).run();
      if (command === 'image-align-right') chain.updateAttributes('image', { align: 'right' }).run();
      if (command === 'image-delete' && editor.isActive('image')) chain.deleteSelection().run();
      if (command === 'math-inline') {
        const latex = window.prompt('Formula (inline)', 'x^2');
        if (!latex) return;
        chain.insertContent({ type: 'inlineMath', attrs: { latex: latex.trim(), evaluate: 'no', display: 'no' } }).run();
      }
      if (command === 'math-block') {
        const latex = window.prompt('Formula (block)', '\\\\sum_{i=1}^{n} x_i');
        if (!latex) return;
        chain.insertContent({ type: 'inlineMath', attrs: { latex: latex.trim(), evaluate: 'no', display: 'yes' } }).run();
      }
    };

    const renderNote = (note) => {
      const entity = String(note.entity_type || 'experiment');
      const article = document.createElement('article');
      article.className = 'journal-item';
      article.dataset.noteId = String(note.id || '');
      article.dataset.entityType = entity;
      article.dataset.createdAt = String(note.activity_at || note.updated_at || note.created_at || '');
      article.dataset.entityHref = String(note.entity_href || `/experiments/${experimentId}`);
      article.innerHTML = `
        <header class="journal-item-head">
          <a class="journal-item-title-link" href="${esc(note.entity_href || `/experiments/${experimentId}`)}">${esc(note.display_title || note.title || '')}</a>
          <div class="journal-item-head-actions">
            <span class="small-note">${esc(note.timestamp || '')}</span>
            ${note.can_edit ? '<button class="icon-button tiny" type="button" data-note-edit title="Edit note"><span class="material-symbols-rounded" aria-hidden="true">edit</span></button>' : ''}
            ${note.can_delete ? '<button class="icon-button danger tiny" type="button" data-note-delete title="Delete note"><span class="material-symbols-rounded" aria-hidden="true">delete</span></button>' : ''}
          </div>
        </header>
        <div class="journal-item-entity small-note">
          <span class="entity-pill entity-${esc(entity)}">${esc(entity)}</span> #${esc(note.entity_id || experimentId)}
        </div>
        <div class="journal-item-body">${note.body_html || ''}</div>
      `;
      renderMathInElement(article.querySelector('.journal-item-body'));
      return article;
    };

    const rebuildRail = () => {
      if (!rail || !feed) return;
      rail.innerHTML = '';
      const items = feed.querySelectorAll('.journal-item:not([style*="display: none"])');
      items.forEach((item, index) => {
        const entity = item.dataset.entityType || 'experiment';
        const dot = document.createElement('button');
        dot.type = 'button';
        dot.dataset.noteId = String(item.dataset.noteId || '');
        dot.className = `journal-rail-dot entity-${entity}`;
        const title = item.querySelector('.journal-item-title-link')?.textContent?.trim() || `Note ${index + 1}`;
        const stamp = item.querySelector('.journal-item-head .small-note')?.textContent?.trim() || '';
        const tooltip = stamp ? `${title} · ${stamp}` : title;
        dot.dataset.tooltip = tooltip;
        dot.title = tooltip;
        dot.setAttribute('aria-label', tooltip);
        bindRailTooltip(dot, tooltip);
        dot.addEventListener('click', () => item.scrollIntoView({ behavior: 'smooth', block: 'start' }));
        rail.appendChild(dot);
      });
      updateActiveRailDot();
    };

    const updateActiveRailDot = () => {
      if (!rail || !feed) return;
      const dots = Array.from(rail.querySelectorAll('.journal-rail-dot'));
      if (!dots.length) return;
      const items = Array.from(feed.querySelectorAll('.journal-item')).filter((item) => item.style.display !== 'none');
      if (!items.length) {
        dots.forEach((dot) => dot.classList.remove('is-active'));
        return;
      }
      const container = feedScroll;
      const viewportTop = container ? container.getBoundingClientRect().top : 0;
      const viewportHeight = container ? container.getBoundingClientRect().height : window.innerHeight;
      const anchorY = viewportTop + Math.min(viewportHeight * 0.35, 260);
      let bestItem = null;
      let bestDistance = Number.POSITIVE_INFINITY;
      for (const item of items) {
        const rect = item.getBoundingClientRect();
        if (rect.bottom <= viewportTop || rect.top >= viewportTop + viewportHeight) continue;
        if (rect.top <= anchorY && rect.bottom >= anchorY) {
          bestItem = item;
          break;
        }
        const distance = Math.abs(rect.top - anchorY);
        if (distance < bestDistance) {
          bestDistance = distance;
          bestItem = item;
        }
      }
      if (!bestItem) {
        dots.forEach((dot) => dot.classList.remove('is-active'));
        return;
      }
      const activeNoteId = String(bestItem.dataset.noteId || '');
      dots.forEach((dot) => dot.classList.toggle('is-active', String(dot.dataset.noteId || '') === activeNoteId));
    };

    const loadNotes = async () => {
      if (!feed) return;
      const byEntity = onlyCurrent && onlyCurrent.checked ? '1' : '0';
      const resp = await fetch(`/experiments/${experimentId}/notes.json?only_current=${byEntity}&entity_type=${encodeURIComponent(entityType)}&entity_id=${encodeURIComponent(entityId)}`);
      if (!resp.ok) return;
      const data = await resp.json();
      const notes = Array.isArray(data.notes) ? data.notes : [];
      feed.innerHTML = '';
      if (!notes.length) {
        feed.innerHTML = '<div class="small-note notes-empty">No notes yet.</div>';
        rebuildRail();
        return;
      }
      notes
        .slice()
        .sort((a, b) => new Date(b.activity_at || b.updated_at || b.created_at || 0).getTime() - new Date(a.activity_at || a.updated_at || a.created_at || 0).getTime())
        .forEach((note) => feed.appendChild(renderNote(note)));
      applyFilters(searchInput?.value || '', dateInput?.value || '');
      rebuildRail();
      if (feedScroll) {
        feedScroll.scrollTop = 0;
      }
    };

    const applyFilters = (query, dateValue) => {
      if (!feed) return;
      const q = String(query || '').trim().toLowerCase();
      const date = String(dateValue || '').trim();
      feed.querySelectorAll('.journal-item').forEach((item) => {
        const text = item.textContent?.toLowerCase() || '';
        const createdAt = item.dataset.createdAt || '';
        const itemDate = createdAt ? new Date(createdAt).toISOString().slice(0, 10) : '';
        const byText = !q || text.includes(q);
        const byDate = !date || date === itemDate;
        item.style.display = byText && byDate ? '' : 'none';
      });
      rebuildRail();
    };

    const sortFeedByActivityDesc = () => {
      if (!feed) return;
      const cards = Array.from(feed.querySelectorAll('.journal-item'));
      cards.sort((a, b) => {
        const at = new Date(a.dataset.createdAt || 0).getTime();
        const bt = new Date(b.dataset.createdAt || 0).getTime();
        return bt - at;
      });
      cards.forEach((card) => feed.appendChild(card));
    };

    const upsertNote = (note) => {
      if (!feed) return;
      feed.querySelectorAll('.notes-empty').forEach((el) => el.remove());
      const existing = feed.querySelector(`.journal-item[data-note-id="${String(note.id)}"]`);
      const card = renderNote(note);
      if (existing) existing.replaceWith(card);
      else feed.appendChild(card);
      sortFeedByActivityDesc();
    };

    const submit = async (forceNew = false) => {
      if (!input || !sendBtn) return;
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const bodyHtml = editor.getHTML().trim();
      const bodyText = editor.getText().trim();
      if (!bodyHtml || !bodyText) return;
      sendBtn.disabled = true;
      const payload = new URLSearchParams();
      payload.set('entity_type', entityType);
      payload.set('entity_id', String(entityId));
      payload.set('body_html', bodyHtml);
      if (forceNew) payload.set('force_new', '1');
      const isEdit = Boolean(editingNoteId);
      const url = isEdit
        ? `/experiments/${experimentId}/notes/${editingNoteId}/update`
        : `/experiments/${experimentId}/notes`;
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: payload
        });
        const data = await resp.json();
        if (!resp.ok || !data?.note) return;
        upsertNote(data.note);
        editor.commands.clearContent(true);
        editingNoteId = null;
        if (sendBtn) sendBtn.textContent = 'Add note';
        applyFilters(searchInput?.value || '', dateInput?.value || '');
        rebuildRail();
        if (feedScroll) {
          feedScroll.scrollTop = 0;
        }
      } finally {
        sendBtn.disabled = false;
      }
    };

    toggle?.addEventListener('click', async () => {
      const willOpen = !drawer.classList.contains('is-open');
      drawer.classList.toggle('is-open', willOpen);
      toggle.setAttribute('aria-expanded', String(willOpen));
      document.body.classList.toggle('notes-drawer-open', willOpen);
      if (willOpen) {
        await loadNotes();
        if (feedScroll) {
          feedScroll.scrollTop = 0;
        }
        toggle.style.display = 'none';
        if (journalToggle) journalToggle.style.display = 'none';
      }
    });

    closeBtn?.addEventListener('click', () => {
      drawer.classList.remove('is-open');
      toggle?.setAttribute('aria-expanded', 'false');
      if (toggle) toggle.style.display = '';
      if (journalToggle) journalToggle.style.display = '';
      if (!document.querySelector('.notes-drawer.is-open')) {
        document.body.classList.remove('notes-drawer-open');
      }
    });

    drawer.querySelectorAll('[data-entity-notes-cmd]').forEach((btn) => {
      btn.addEventListener('click', () => execEditorCommand(btn.getAttribute('data-entity-notes-cmd') || ''));
    });
    feed?.addEventListener('click', async (event) => {
      const target = event.target;
      const editButton = target && target.closest ? target.closest('[data-note-edit]') : null;
      if (editButton) {
        const card = editButton.closest('.journal-item');
        const noteId = card?.dataset?.noteId;
        if (!noteId) return;
        const editor = await ensureNotesEditor();
        if (!editor) return;
        const body = card.querySelector('.journal-item-body');
        editor.commands.setContent(body?.innerHTML || '<p></p>', { emitUpdate: true });
        editingNoteId = noteId;
        if (sendBtn) sendBtn.textContent = 'Update note';
        editor.commands.focus('end');
        return;
      }
      const button = target && target.closest ? target.closest('[data-note-delete]') : null;
      if (!button) return;
      const card = button.closest('.journal-item');
      const noteId = card?.dataset?.noteId;
      if (!noteId) return;
      if (!window.confirm('Delete this note?')) return;
      const resp = await fetch(`/experiments/${experimentId}/notes/${noteId}/delete`, { method: 'POST' });
      if (!resp.ok) return;
      card.remove();
      if (!feed.querySelector('.journal-item')) {
        feed.innerHTML = '<div class="small-note notes-empty">No notes yet.</div>';
      }
      rebuildRail();
    });
    feed?.addEventListener('change', async (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement) || target.type !== 'checkbox') return;
      const card = target.closest('.journal-item');
      if (!card) return;
      const noteId = card.dataset.noteId;
      if (!noteId) return;
      const items = Array.from(card.querySelectorAll('.md-checklist input[type="checkbox"]'));
      const itemIndex = items.indexOf(target);
      if (itemIndex < 0) return;
      const payload = new URLSearchParams();
      payload.set('item_index', String(itemIndex));
      payload.set('checked', target.checked ? '1' : '0');
      const resp = await fetch(`/experiments/${experimentId}/notes/${noteId}/checklist`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: payload
      });
      const data = await resp.json().catch(() => null);
      if (!resp.ok || !data?.note) {
        target.checked = !target.checked;
        return;
      }
      await loadNotes();
    });

    onlyCurrent?.addEventListener('change', loadNotes);
    searchInput?.addEventListener('input', () => applyFilters(searchInput.value, dateInput?.value || ''));
    dateInput?.addEventListener('change', () => applyFilters(searchInput?.value || '', dateInput.value));
    feedScroll?.addEventListener('scroll', updateActiveRailDot, { passive: true });
    window.addEventListener('resize', updateActiveRailDot);
    sendBtn?.addEventListener('click', submit);
    fontFamilySelect?.addEventListener('change', async () => {
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const value = fontFamilySelect.value;
      const chain = editor.chain().focus();
      if (!value) chain.unsetFontFamily().run();
      else chain.setFontFamily(value).run();
    });
    fontSizeSelect?.addEventListener('change', async () => {
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const value = fontSizeSelect.value;
      const chain = editor.chain().focus();
      if (!value) chain.unsetFontSize().run();
      else chain.setFontSize(value).run();
    });
    lineHeightSelect?.addEventListener('change', async () => {
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const value = lineHeightSelect.value;
      const chain = editor.chain().focus();
      if (!value) chain.unsetLineHeight().run();
      else chain.setLineHeight(value).run();
    });
    presetSelect?.addEventListener('change', async () => {
      const editor = await ensureNotesEditor();
      if (!editor) return;
      const preset = presetSelect.value;
      if (preset === 'body') editor.chain().focus().setParagraph().setFontSize('16px').setLineHeight('1.5').unsetBold().unsetItalic().unsetUnderline().unsetHighlight().run();
      if (preset === 'subtitle') editor.chain().focus().setHeading({ level: 3 }).setFontSize('20px').setLineHeight('1.35').setBold().unsetItalic().unsetUnderline().unsetHighlight().run();
      if (preset === 'note') editor.chain().focus().setParagraph().setFontSize('15px').setLineHeight('1.65').unsetBold().setItalic().unsetUnderline().unsetHighlight().run();
      if (preset === 'emphasis') editor.chain().focus().setParagraph().setFontSize('18px').setLineHeight('1.5').setBold().unsetItalic().setUnderline().setHighlight().run();
      presetSelect.value = '';
    });
    document.addEventListener('keydown', (event) => {
      if (!(event.ctrlKey || event.metaKey) || event.key !== 'Enter') return;
      const target = event.target;
      if (!(target instanceof Element)) return;
      if (!input) return;
      const active = document.activeElement;
      const insideEditor = input.contains(target) || (active instanceof Element && input.contains(active));
      if (!insideEditor) return;
      event.preventDefault();
      submit(Boolean(event.shiftKey));
    }, true);
    ensureNotesEditor();
    initTablePicker();

    const openInitially = drawer.classList.contains('is-open');
    if (openInitially) {
      document.body.classList.add('notes-drawer-open');
      loadNotes();
    }
    updateActiveRailDot();
  })();
</script>
