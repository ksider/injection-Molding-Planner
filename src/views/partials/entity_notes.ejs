<button
  class="icon-button notes-drawer-toggle"
  type="button"
  data-entity-notes-toggle
  aria-expanded="false"
  title="Notes"
>
  <span class="material-symbols-rounded" aria-hidden="true">expand_less</span>
</button>

<aside
  class="notes-drawer"
  data-entity-notes-drawer
  data-experiment-id="<%= experimentId %>"
  data-entity-type="<%= entityType %>"
  data-entity-id="<%= entityId %>"
  aria-label="Entity notes"
>
  <div class="notes-drawer-head">
    <strong><%= title || 'Notes' %></strong>
    <div class="section-actions">
      <a class="pure-button" href="/experiments/<%= experimentId %>/journal">Open in journal</a>
      <button class="icon-button" type="button" data-entity-notes-close title="Hide notes">
        <span class="material-symbols-rounded" aria-hidden="true">expand_more</span>
      </button>
    </div>
  </div>

  <div class="notes-drawer-toolbar">
    <label class="toggle" title="Filter notes by this entity">
      <input type="checkbox" data-entity-only-current checked>
      <span class="track"></span>
      <span>Only this entity</span>
    </label>
    <span class="small-note"><%= entityType %> #<%= entityId %></span>
    <input class="notes-search" type="date" data-entity-notes-date title="Filter by date">
    <input class="notes-search" type="search" data-entity-notes-search placeholder="Search notes">
  </div>

  <div class="notes-drawer-body">
    <aside class="journal-rail" data-entity-notes-rail></aside>
    <section class="notes-feed-scroll">
      <div class="journal-feed" data-entity-notes-feed>
        <div class="small-note">Loading...</div>
      </div>

      <% if (canWrite) { %>
        <div class="notes-compose">
          <div class="journal-toolbar" role="toolbar" aria-label="Notes formatting">
            <button class="pure-button" type="button" data-entity-notes-cmd="undo" title="Undo">↶</button>
            <button class="pure-button" type="button" data-entity-notes-cmd="redo" title="Redo">↷</button>
            <button class="pure-button" type="button" data-entity-notes-cmd="bold" title="Bold">B</button>
            <button class="pure-button" type="button" data-entity-notes-cmd="italic" title="Italic">I</button>
            <button class="pure-button" type="button" data-entity-notes-cmd="underline" title="Underline">U</button>
            <button class="pure-button" type="button" data-entity-notes-cmd="insertUnorderedList" title="Bullet list">List</button>
            <button class="pure-button" type="button" data-entity-notes-link title="Link">Link</button>
            <button class="pure-button" type="button" data-entity-notes-code title="Code">Code</button>
          </div>
          <div class="journal-editor" contenteditable="true" data-entity-notes-input data-placeholder="Write note for this entity..."></div>
          <div class="notes-compose-footer">
            <span class="small-note">Ctrl/Cmd+Enter: append today · Ctrl/Cmd+Shift+Enter: new note</span>
            <button class="pure-button pure-button-primary" type="button" data-entity-notes-send>Add note</button>
          </div>
        </div>
      <% } %>
    </section>
  </div>
</aside>

<script>
  (() => {
    const drawer = document.currentScript?.previousElementSibling;
    const toggle = drawer?.previousElementSibling;
    if (!drawer || !drawer.matches('[data-entity-notes-drawer]')) return;
    const experimentId = drawer.getAttribute('data-experiment-id');
    const entityType = drawer.getAttribute('data-entity-type') || 'experiment';
    const entityId = drawer.getAttribute('data-entity-id') || experimentId;

    const closeBtn = drawer.querySelector('[data-entity-notes-close]');
    const onlyCurrent = drawer.querySelector('[data-entity-only-current]');
    const searchInput = drawer.querySelector('[data-entity-notes-search]');
    const dateInput = drawer.querySelector('[data-entity-notes-date]');
    const rail = drawer.querySelector('[data-entity-notes-rail]');
    const feed = drawer.querySelector('[data-entity-notes-feed]');
    const feedScroll = drawer.querySelector('.notes-feed-scroll');
    const input = drawer.querySelector('[data-entity-notes-input]');
    const sendBtn = drawer.querySelector('[data-entity-notes-send]');

    const esc = (value) =>
      String(value || '').replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char]));

    const renderNote = (note) => {
      const entity = String(note.entity_type || 'experiment');
      const article = document.createElement('article');
      article.className = 'journal-item';
      article.dataset.noteId = String(note.id || '');
      article.dataset.entityType = entity;
      article.dataset.createdAt = String(note.activity_at || note.updated_at || note.created_at || '');
      article.innerHTML = `
        <header class="journal-item-head">
          <strong>${esc(note.display_title || note.title || '')}</strong>
          <div class="journal-item-head-actions">
            <span class="small-note">${esc(note.timestamp || '')}</span>
            ${note.can_delete ? '<button class="icon-button danger tiny" type="button" data-note-delete title="Delete note"><span class="material-symbols-rounded" aria-hidden="true">delete</span></button>' : ''}
          </div>
        </header>
        <div class="journal-item-entity small-note">
          <span class="entity-pill entity-${esc(entity)}">${esc(entity)}</span> #${esc(note.entity_id || experimentId)}
        </div>
        <div class="journal-item-body">${note.body_html || ''}</div>
      `;
      return article;
    };

    const rebuildRail = () => {
      if (!rail || !feed) return;
      rail.innerHTML = '';
      const items = feed.querySelectorAll('.journal-item:not([style*="display: none"])');
      items.forEach((item, index) => {
        const entity = item.dataset.entityType || 'experiment';
        const dot = document.createElement('button');
        dot.type = 'button';
        dot.className = `journal-rail-dot entity-${entity}`;
        const stamp = item.querySelector('.small-note')?.textContent || `Note ${index + 1}`;
        dot.title = stamp;
        dot.setAttribute('aria-label', stamp);
        dot.addEventListener('click', () => item.scrollIntoView({ behavior: 'smooth', block: 'start' }));
        rail.appendChild(dot);
      });
    };

    const loadNotes = async () => {
      if (!feed) return;
      const byEntity = onlyCurrent && onlyCurrent.checked ? '1' : '0';
      const resp = await fetch(`/experiments/${experimentId}/notes.json?only_current=${byEntity}&entity_type=${encodeURIComponent(entityType)}&entity_id=${encodeURIComponent(entityId)}`);
      if (!resp.ok) return;
      const data = await resp.json();
      const notes = Array.isArray(data.notes) ? data.notes : [];
      feed.innerHTML = '';
      if (!notes.length) {
        feed.innerHTML = '<div class="small-note notes-empty">No notes yet.</div>';
        rebuildRail();
        return;
      }
      notes
        .slice()
        .sort((a, b) => new Date(a.activity_at || a.updated_at || a.created_at || 0).getTime() - new Date(b.activity_at || b.updated_at || b.created_at || 0).getTime())
        .forEach((note) => feed.appendChild(renderNote(note)));
      applyFilters(searchInput?.value || '', dateInput?.value || '');
      rebuildRail();
      if (feedScroll) {
        feedScroll.scrollTop = feedScroll.scrollHeight;
      }
    };

    const applyFilters = (query, dateValue) => {
      if (!feed) return;
      const q = String(query || '').trim().toLowerCase();
      const date = String(dateValue || '').trim();
      feed.querySelectorAll('.journal-item').forEach((item) => {
        const text = item.textContent?.toLowerCase() || '';
        const createdAt = item.dataset.createdAt || '';
        const itemDate = createdAt ? new Date(createdAt).toISOString().slice(0, 10) : '';
        const byText = !q || text.includes(q);
        const byDate = !date || date === itemDate;
        item.style.display = byText && byDate ? '' : 'none';
      });
      rebuildRail();
    };

    const exec = (cmd, value) => {
      if (!input) return;
      input.focus();
      document.execCommand(cmd, false, value);
    };

    const upsertNote = (note) => {
      if (!feed) return;
      feed.querySelectorAll('.notes-empty').forEach((el) => el.remove());
      const existing = feed.querySelector(`.journal-item[data-note-id="${String(note.id)}"]`);
      const card = renderNote(note);
      if (existing) existing.replaceWith(card);
      else feed.appendChild(card);
    };

    const submit = async (forceNew = false) => {
      if (!input || !sendBtn) return;
      const bodyHtml = input.innerHTML.trim();
      if (!bodyHtml || !input.textContent || input.textContent.trim().length === 0) return;
      sendBtn.disabled = true;
      const payload = new URLSearchParams();
      payload.set('entity_type', entityType);
      payload.set('entity_id', String(entityId));
      payload.set('body_html', bodyHtml);
      if (forceNew) payload.set('force_new', '1');
      try {
        const resp = await fetch(`/experiments/${experimentId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: payload
        });
        const data = await resp.json();
        if (!resp.ok || !data?.note) return;
        upsertNote(data.note);
        input.innerHTML = '';
        applyFilters(searchInput?.value || '', dateInput?.value || '');
        rebuildRail();
        if (feedScroll) {
          feedScroll.scrollTop = feedScroll.scrollHeight;
        }
      } finally {
        sendBtn.disabled = false;
      }
    };

    toggle?.addEventListener('click', async () => {
      const willOpen = !drawer.classList.contains('is-open');
      drawer.classList.toggle('is-open', willOpen);
      toggle.setAttribute('aria-expanded', String(willOpen));
      if (willOpen) {
        await loadNotes();
        if (feedScroll) {
          feedScroll.scrollTop = feedScroll.scrollHeight;
        }
        toggle.style.display = 'none';
      }
    });

    closeBtn?.addEventListener('click', () => {
      drawer.classList.remove('is-open');
      toggle?.setAttribute('aria-expanded', 'false');
      if (toggle) toggle.style.display = '';
    });

    drawer.querySelectorAll('[data-entity-notes-cmd]').forEach((btn) => {
      btn.addEventListener('click', () => exec(btn.getAttribute('data-entity-notes-cmd') || 'bold'));
    });
    drawer.querySelectorAll('[data-entity-notes-link]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const url = window.prompt('Enter URL', 'https://');
        if (!url) return;
        exec('createLink', url);
      });
    });
    drawer.querySelectorAll('[data-entity-notes-code]').forEach((btn) => {
      btn.addEventListener('click', () => {
        const sel = window.getSelection();
        const text = sel && sel.rangeCount ? sel.toString() : '';
        exec('insertHTML', `<code>${esc(text || 'code')}</code>`);
      });
    });
    feed?.addEventListener('click', async (event) => {
      const target = event.target;
      const button = target && target.closest ? target.closest('[data-note-delete]') : null;
      if (!button) return;
      const card = button.closest('.journal-item');
      const noteId = card?.dataset?.noteId;
      if (!noteId) return;
      if (!window.confirm('Delete this note?')) return;
      const resp = await fetch(`/experiments/${experimentId}/notes/${noteId}/delete`, { method: 'POST' });
      if (!resp.ok) return;
      card.remove();
      if (!feed.querySelector('.journal-item')) {
        feed.innerHTML = '<div class="small-note notes-empty">No notes yet.</div>';
      }
      rebuildRail();
    });

    onlyCurrent?.addEventListener('change', loadNotes);
    searchInput?.addEventListener('input', () => applyFilters(searchInput.value, dateInput?.value || ''));
    dateInput?.addEventListener('change', () => applyFilters(searchInput?.value || '', dateInput.value));
    sendBtn?.addEventListener('click', submit);
    input?.addEventListener('keydown', (event) => {
      if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault();
        submit(Boolean(event.shiftKey));
      }
    });

    const openInitially = drawer.classList.contains('is-open');
    if (openInitially) {
      loadNotes();
    }
  })();
</script>
