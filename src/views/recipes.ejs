<%- include('partials/head', { title: 'IM Planner | Recipes' }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="recipes-header">
      <div class="recipes-header-left">
        <h1 class="card-title">Saved Recipes</h1>
        <p class="small-note">Import BPACKs-style matrix CSV/TSV to populate recipe components.</p>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
          <form class="pure-form recipes-import-file" action="/recipes/import" method="post" enctype="multipart/form-data">
            <input type="file" name="matrix" accept=".csv,.tsv,text/csv,text/tab-separated-values" required>
            <button class="icon-btn" type="submit" title="Import Recipes">Import</button>
          </form>
        <% } %>
      </div>
      <div class="recipes-actions">
      </div>
    </div>
    <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
      <form class="pure-form recipe-import-text" action="/recipes/import-text" method="post">
        <label class="small-note" for="recipe_text">Plain text: recipe name on line 1, then "Component  PHR" (two spaces).</label>
        <textarea id="recipe_text" name="recipe_text" rows="6" placeholder="Recipe Name&#10;Component A  12.5&#10;Component B  0.8" required></textarea>
        <button class="icon-btn" type="submit" title="Import Recipe from Text">Add from text</button>
      </form>
    <% } %>
    <% if (importedCount !== null) { %>
      <p class="small-note"><%= importedCount %> recipes imported.</p>
    <% } %>
    <% if (error) { %>
      <p class="small-note"><%= error %></p>
    <% } %>
    <% if (recipes.length === 0) { %>
      <p class="small-note">No recipes loaded yet.</p>
    <% } else { %>
      <div class="recipes-list-toolbar">
        <input type="search" class="recipe-search" placeholder="Search recipes..." data-recipe-search>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager')) { %>
          <form class="pure-form inline-form" action="/recipes/clear" method="post" onsubmit="return confirm('Delete all imported recipes?');">
            <button class="icon-btn danger" type="submit" title="Delete All Recipes">Delete All</button>
          </form>
        <% } %>
      </div>
      <div class="recipe-card-grid">
        <% recipes.forEach((recipe) => { %>
          <% const dataText = [recipe.name, recipe.description || '', ...recipe.components.map((c) => `${c.component_name} ${c.phr}`)].join(' ').toLowerCase(); %>
          <div
            class="recipe-card"
            data-recipe-text="<%= dataText %>"
            data-recipe-id="<%= recipe.id %>"
            data-recipe-name="<%= recipe.name %>"
            data-recipe-components="<%= JSON.stringify(recipe.components || []) %>"
          >
            <div class="recipe-card-header">
              <h3><%- formatInline(recipe.name) %></h3>
              <div>
                <span class="badge imported">import</span>
              </div>
            </div>
            <% if (recipe.description) { %>
              <div class="recipe-desc"><%- formatInline(recipe.description) %></div>
            <% } %>
            <div class="recipe-components">
              <% const maxLines = 10; %>
              <% const comps = recipe.components || []; %>
              <% comps.slice(0, maxLines).forEach((component) => { %>
                <div class="recipe-comp-line">
                  <span class="recipe-comp-name"><%- formatInline(component.component_name) %></span>
                  <span class="recipe-comp-qty"><%= formatNumber(component.phr) %></span>
                </div>
              <% }); %>
              <% if (comps.length > maxLines) { %>
                <div class="recipe-comp-more">+<%= comps.length - maxLines %> more</div>
              <% } %>
            </div>
            <div class="recipe-card-actions">
              <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
                <button class="icon-btn icon-only" type="button" data-recipe-edit title="Edit recipe" aria-label="Edit recipe">
                  <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                </button>
              <% } %>
              <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager')) { %>
                <form class="pure-form inline-form" action="/recipes/<%= recipe.id %>/delete" method="post" onsubmit="return confirm('Archive this recipe?');">
                  <button class="icon-btn icon-only danger" type="submit" title="Archive recipe" aria-label="Archive recipe">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                </form>
              <% } %>
            </div>
          </div>
        <% }); %>
      </div>
    <% } %>
  </div>
</div>

<dialog class="modal-frame" id="recipeEditDialog">
  <div class="modal-header">
    <strong>Edit Recipe</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" id="recipeEditForm" method="post">
    <div class="modal-body">
      <div class="field-grid">
        <div>
          <label for="recipeEditName">Recipe Name</label>
          <input id="recipeEditName" name="name" required>
        </div>
      </div>
      <h3 class="card-title" style="margin-top: 1rem;">Mass Parts Table</h3>
      <table class="pure-table table-compact recipe-edit-table">
        <thead>
          <tr>
            <th>Component</th>
            <th>Static parts</th>
          </tr>
        </thead>
        <tbody id="recipeEditBody"></tbody>
      </table>
      <div class="recipe-edit-actions">
        <button class="pure-button pure-button-secondary" type="button" id="recipeAddRow">Add component</button>
      </div>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>
<%- include('partials/foot') %>

<script>
  const searchInput = document.querySelector('[data-recipe-search]');
  if (searchInput) {
    searchInput.addEventListener('input', (event) => {
      const query = event.target.value.toLowerCase();
      document.querySelectorAll('[data-recipe-text]').forEach((card) => {
        const text = card.getAttribute('data-recipe-text') || '';
        card.style.display = text.includes(query) ? '' : 'none';
      });
    });
  }

  const dialog = document.getElementById('recipeEditDialog');
  const form = document.getElementById('recipeEditForm');
  const nameInput = document.getElementById('recipeEditName');
  const body = document.getElementById('recipeEditBody');
  const addRowBtn = document.getElementById('recipeAddRow');

  function addRow(name = '', phr = '') {
    const row = document.createElement('tr');
    const nameCell = document.createElement('td');
    const phrCell = document.createElement('td');
    const nameInput = document.createElement('input');
    const phrInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.name = 'component_name';
    nameInput.required = true;
    nameInput.value = name ?? '';
    phrInput.type = 'number';
    phrInput.step = 'any';
    phrInput.name = 'component_phr';
    phrInput.required = true;
    phrInput.value = phr ?? '';
    nameCell.appendChild(nameInput);
    phrCell.appendChild(phrInput);
    row.appendChild(nameCell);
    row.appendChild(phrCell);
    body.appendChild(row);
  }

  document.querySelectorAll('[data-recipe-edit]').forEach((button) => {
    button.addEventListener('click', () => {
      const card = button.closest('.recipe-card');
      if (!card || !dialog || !form || !nameInput || !body) return;
      const recipeId = card.getAttribute('data-recipe-id');
      const recipeName = card.getAttribute('data-recipe-name') || '';
      const componentsRaw = card.getAttribute('data-recipe-components') || '[]';
      let components = [];
      try {
        components = JSON.parse(componentsRaw);
      } catch {}

      form.setAttribute('action', `/recipes/${recipeId}/update`);
      nameInput.value = recipeName;
      body.innerHTML = '';
      if (components.length === 0) addRow();
      components.forEach((component) => addRow(component.component_name || '', component.phr ?? ''));
      dialog.showModal();
    });
  });

  addRowBtn?.addEventListener('click', () => addRow());

  dialog?.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => dialog.close());
  });
</script>
