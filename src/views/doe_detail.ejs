<%- include('partials/head', { title: `IM Planner | ${experiment.name}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="card-header card-header-main">
      <a class="back-link" href="/experiments/<%= experiment.id %>" aria-label="Back to experiment">
        <span class="material-symbols-rounded" aria-hidden="true">arrow_back</span>
      </a>
      <div>
        <h1 class="card-title"><%- formatInline(doe.name) %></h1>
        <p class="small-note">
          <strong><%- formatInline(experiment.name) %></strong> · <%= doe.design_type %> · Seed <%= doe.seed %>
        </p>
      </div>
      <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
        <div class="section-actions">
          <button class="icon-button" type="button" id="openDoeNameDialog" title="Edit DOE name">
            <span class="material-symbols-rounded" aria-hidden="true">edit</span>
          </button>
        </div>
      <% } %>
    </div>
    <div class="tabs">
      <a class="<%= tab === 'design' ? 'active' : '' %>" href="/experiments/<%= experiment.id %>/doe/<%= doeId %>?tab=design">Design</a>
      <a class="<%= tab === 'runs' ? 'active' : '' %>" href="/experiments/<%= experiment.id %>/doe/<%= doeId %>?tab=runs">Runs</a>
      <a class="<%= tab === 'analysis' ? 'active' : '' %>" href="/experiments/<%= experiment.id %>/doe/<%= doeId %>?tab=analysis">Analysis</a>
    </div>
  </div>

  <%- include('partials/entity_notes', {
    experimentId: experiment.id,
    entityType: 'doe',
    entityId: doeId,
    title: 'DOE Notes',
    canWrite: currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')
  }) %>

  <% if (tab === 'design') { %>
    <div class="card">
      <h2 class="card-title">Factor Setup</h2>
      <p class="small-note">Manage all parameters and custom fields from the popup.</p>
      <% if (errorMessage) { %>
        <p class="small-note"><strong><%= errorMessage %></strong></p>
      <% } %>
      <% const configMap = new Map(); configs.forEach(c => configMap.set(c.param_def_id, c)); %>
      <% const activeParams = inputParams.filter((param) => (configMap.get(param.id)?.active ?? 0) === 1); %>
      <table class="pure-table table-compact" style="margin-top: 0.75rem;">
        <thead>
          <tr>
            <th>Parameter</th>
            <th>Mode</th>
            <th>Values</th>
          </tr>
        </thead>
        <tbody data-factor-summary-body>
          <% if (activeParams.length === 0) { %>
            <tr><td colspan="3">No active factors selected.</td></tr>
          <% } %>
          <% activeParams.forEach((param) => { const config = configMap.get(param.id); const groupKey = (param.group_label || 'General').toLowerCase().replace(/[^a-z0-9]+/g, '-'); const valuesText = config?.mode === 'RANGE' ? `${formatNumber(config?.range_min_real)} .. ${formatNumber(config?.range_max_real)}` : config?.mode === 'LIST' ? (config?.list_json ? JSON.parse(config.list_json).map((val) => formatNumber(val)).join(', ') : '-') : formatNumber(config?.fixed_value_real); %>
            <tr class="row-active group-row group-<%= groupKey %>" data-group-key="<%= groupKey %>">
              <td>
                <%- formatInline(param.label) %>
                <% if (param.unit) { %>
                  <span class="small-note">(<%- formatInline(param.unit) %>)</span>
                <% } %>
              </td>
              <td><span class="badge"><%= config?.mode || 'FIXED' %></span></td>
              <td><%= valuesText %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
      <div style="margin-top: 1rem;">
        <button class="pure-button pure-button-secondary" type="button" id="openFactorDialog">Edit All Parameters</button>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Generate Runs</h2>
      <p class="small-note">Generation will replace existing runs for this experiment.</p>
      <p class="small-note" data-run-preview>
        Preview: <strong data-run-total><%= runPreview.totalRuns %></strong> runs
        = base <span data-run-base><%= runPreview.baseRuns %></span>
        × recipes <span data-run-recipes><%= runPreview.recipeMultiplier %></span>
        × replicates <span data-run-replicates><%= runPreview.replicateMultiplier %></span>
      </p>
      <p class="small-note" data-run-formula><%= runPreview.formula %></p>
      <p class="small-note" data-run-warning style="<%= runPreview.warning ? '' : 'display:none;' %>">
        <strong><%= runPreview.warning %></strong>
      </p>
      <form class="pure-form" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/generate" method="post">
        <button class="pure-button pure-button-primary" type="submit">Generate Runlist</button>
      </form>
    </div>

    <dialog id="factorDialog" class="modal-frame">
      <div class="modal-header">
        <strong>All Parameters</strong>
        <button class="pure-button" type="button" data-close>Close</button>
      </div>
      <div class="modal-body">
        <% if (errorMessage) { %>
          <p class="small-note"><strong><%= errorMessage %></strong></p>
        <% } %>
        <% const groupSet = new Set(); inputParams.forEach((param) => groupSet.add(param.group_label || 'General')); const groupList = Array.from(groupSet); %>
        <div class="group-filter" data-group-filter>
          <button type="button" class="group-chip active" data-group-filter="all">All</button>
          <% groupList.forEach((group) => { const groupKey = group.toLowerCase().replace(/[^a-z0-9]+/g, '-'); %>
            <button
              type="button"
              class="group-chip"
              data-group-filter="<%= groupKey %>"
              data-group-label="<%= group %>"
            >
              <%- formatInline(group) %>
            </button>
          <% }); %>
        </div>
        <form class="pure-form" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/configs" method="post" id="factorForm">
          <div class="small-note" style="margin-bottom: 0.5rem;">
            Do not randomize (optional): pick one factor to keep grouped in run order.
          </div>
          <table class="pure-table table-compact">
            <thead>
              <tr>
                <th>On</th>
                <th>
                  <label class="toggle">
                    <input
                      type="radio"
                      name="non_randomized_param_id"
                      value=""
                      id="nonRandomizeNone"
                      <%= !nonRandomizedParamId ? 'checked' : '' %>
                    >
                    <span class="track"></span>
                    <span class="toggle-label">None</span>
                  </label>
                </th>
                <th>Parameter</th>
                <th>Mode</th>
                <th>Settings</th>
              </tr>
            </thead>
            <tbody>
              <% inputParams.forEach((param) => { const config = configMap.get(param.id); const groupKey = (param.group_label || 'General').toLowerCase().replace(/[^a-z0-9]+/g, '-'); %>
                <% const valueText = config?.mode === 'LIST' && config?.list_json ? JSON.parse(config.list_json).join(', ') : (config?.fixed_value_real ?? ''); %>
                <tr
                  data-param-row
                  data-param-id="<%= param.id %>"
                  data-param-label="<%= param.label %>"
                  data-param-group="<%= param.group_label || 'General' %>"
                  data-param-unit="<%= param.unit || '' %>"
                  data-group-key="<%= groupKey %>"
                  class="<%= config?.active ? 'row-active' : '' %> group-row group-<%= groupKey %>"
                >
                  <td>
                    <label class="toggle">
                      <input type="checkbox" name="param_<%= param.id %>_active" data-active-toggle <%= config?.active ? 'checked' : '' %>>
                      <span class="track"></span>
                    </label>
                  </td>
                  <td>
                    <label class="toggle">
                      <input
                        type="radio"
                        name="non_randomized_param_id"
                        value="<%= param.id %>"
                        data-nonrandomize
                        <%= nonRandomizedParamId === param.id ? 'checked' : '' %>
                        <%= config?.active ? '' : 'disabled' %>
                      >
                      <span class="track"></span>
                    </label>
                  </td>
                  <td>
                    <%- formatInline(param.label) %>
                    <% if (param.unit) { %>
                      <span class="small-note">(<%- formatInline(param.unit) %>)</span>
                    <% } %>
                  </td>
                  <td class="mode-cell mode-<%= (config?.mode || 'FIXED').toLowerCase() %>">
                    <select name="param_<%= param.id %>_mode" data-mode-select>
                      <option value="FIXED" <%= config?.mode === 'FIXED' ? 'selected' : '' %>>FIXED</option>
                      <option value="RANGE" <%= config?.mode === 'RANGE' ? 'selected' : '' %>>RANGE</option>
                      <option value="LIST" <%= config?.mode === 'LIST' ? 'selected' : '' %>>LIST</option>
                    </select>
                  </td>
                  <td>
                    <div class="factor-settings">
                      <div class="settings-range">
                        <input type="number" step="any" name="param_<%= param.id %>_min" data-range value="<%= config?.range_min_real ?? '' %>">
                        <input type="number" step="any" name="param_<%= param.id %>_max" data-range value="<%= config?.range_max_real ?? '' %>">
                        <% if (doe.design_type !== 'BBD') { %>
                          <select name="param_<%= param.id %>_levels" data-levels>
                            <option value="2" <%= (config?.level_count || 2) === 2 ? 'selected' : '' %>>2</option>
                            <option value="3" <%= config?.level_count === 3 ? 'selected' : '' %>>3</option>
                          </select>
                        <% } %>
                      </div>
                      <div class="settings-values">
                        <input type="text" name="param_<%= param.id %>_values" data-values value="<%= valueText %>">
                      </div>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
          <div style="margin-top: 1rem;">
            <button class="pure-button pure-button-primary" type="submit">Save Factors</button>
          </div>
        </form>

        <div class="card" style="margin-top: 1rem;">
          <h2 class="card-title">Custom Fields</h2>
          <form class="pure-form pure-form-stacked" id="doeCustomFieldForm" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/params" method="post">
            <div class="field-toolbar">
              <label>
                Library
                <select id="doeLibrarySelect">
                  <option value="">Select parameter…</option>
                  <% params.filter((param) => param.scope === 'GLOBAL').forEach((param) => { %>
                    <option
                      value="<%= param.id %>"
                      data-code="<%= param.code %>"
                      data-label="<%- formatInline(param.label) %>"
                      data-unit="<%= param.unit || '' %>"
                      data-group="<%= param.group_label || '' %>"
                      data-kind="<%= param.field_kind %>"
                      data-type="<%= param.field_type %>"
                      data-allowed="<%= param.allowed_values_json || '' %>"
                    >
                      <%- formatInline(param.label) %> (<%= param.code %>)
                    </option>
                  <% }); %>
                </select>
              </label>
              <button class="pure-button" type="button" id="doeLibraryFill">Use selected</button>
              <a class="pure-button pure-button-secondary" href="/param-library">Open library</a>
            </div>
            <div class="grid-two">
              <div>
                <label>Code</label>
                <input type="text" name="code" placeholder="custom_param" required>
              </div>
              <div>
                <label>Label</label>
                <input type="text" name="label" placeholder="Custom Parameter" required>
              </div>
              <div>
                <label>Unit</label>
                <input type="text" name="unit">
              </div>
              <div>
                <label>Group</label>
                <input type="text" name="group_label" placeholder="Outputs">
              </div>
              <div>
                <label>Kind</label>
                <select name="field_kind">
                  <option value="INPUT">Input</option>
                  <option value="OUTPUT">Output</option>
                </select>
              </div>
              <div>
                <label>Type</label>
                <select name="field_type">
                  <option value="number">Number</option>
                  <option value="text">Text</option>
                  <option value="tag">Tag</option>
                </select>
              </div>
              <div>
                <label>Allowed Tags (comma-separated)</label>
                <input type="text" name="allowed_values" placeholder="good, ok, fail">
              </div>
            </div>
            <button class="pure-button pure-button-secondary" type="submit">Add Field</button>
          </form>
        </div>

        
      </div>
      <div class="modal-footer">
        <button class="pure-button" type="button" data-close>Close</button>
      </div>
    </dialog>

    <script>
      const factorDialog = document.getElementById('factorDialog');
      const openFactorDialog = document.getElementById('openFactorDialog');
      if (openFactorDialog && factorDialog) {
        openFactorDialog.addEventListener('click', () => factorDialog.showModal());
      }
      if (factorDialog && "<%= errorMessage ? '1' : '' %>") {
        factorDialog.showModal();
      }
      document.querySelectorAll('[data-close]').forEach((btn) => {
        btn.addEventListener('click', () => factorDialog.close());
      });

      const librarySelect = document.getElementById('doeLibrarySelect');
      const fillBtn = document.getElementById('doeLibraryFill');
      const customForm = document.getElementById('doeCustomFieldForm');
      const fillFromOption = (option) => {
        if (!option || !customForm) return;
        customForm.querySelector('input[name="code"]').value = option.dataset.code || '';
        customForm.querySelector('input[name="label"]').value = option.dataset.label || option.textContent || '';
        customForm.querySelector('input[name="unit"]').value = option.dataset.unit || '';
        customForm.querySelector('input[name="group_label"]').value = option.dataset.group || '';
        const kind = option.dataset.kind || 'INPUT';
        const type = option.dataset.type || 'number';
        customForm.querySelector('select[name="field_kind"]').value = kind;
        customForm.querySelector('select[name="field_type"]').value = type;
        let allowed = '';
        if (option.dataset.allowed) {
          try {
            const parsed = JSON.parse(option.dataset.allowed);
            if (Array.isArray(parsed)) allowed = parsed.join(', ');
          } catch {}
        }
        customForm.querySelector('input[name="allowed_values"]').value = allowed;
      };
      fillBtn?.addEventListener('click', () => {
        const option = librarySelect?.selectedOptions?.[0];
        if (option && option.value) fillFromOption(option);
      });

      function updateRow(row) {
        const modeSelect = row.querySelector('[data-mode-select]');
        const rangeInputs = row.querySelectorAll('[data-range]');
        const valuesInput = row.querySelector('[data-values]');
        const levelsSelect = row.querySelector('[data-levels]');
        const modeCell = row.querySelector('.mode-cell');
        const nonRandomize = row.querySelector('[data-nonrandomize]');
        const activeToggle = row.querySelector('[data-active-toggle]');
        if (!modeSelect) return;
        const mode = modeSelect.value;
        rangeInputs.forEach((input) => { input.disabled = mode !== 'RANGE'; });
        if (valuesInput) valuesInput.disabled = mode === 'RANGE';
        if (levelsSelect) levelsSelect.disabled = mode !== 'RANGE';
        if (modeCell) {
          modeCell.classList.remove('mode-fixed', 'mode-range', 'mode-list');
          modeCell.classList.add(`mode-${mode.toLowerCase()}`);
        }
        row.dataset.mode = mode.toLowerCase();
        if (nonRandomize && activeToggle) {
          nonRandomize.disabled = !activeToggle.checked;
          if (!activeToggle.checked && nonRandomize.checked) {
            const noneRadio = document.getElementById('nonRandomizeNone');
            if (noneRadio) noneRadio.checked = true;
          }
        }
      }

      document.querySelectorAll('[data-param-row]').forEach((row) => {
        updateRow(row);
        const modeSelect = row.querySelector('[data-mode-select]');
        if (modeSelect) {
          modeSelect.addEventListener('change', () => updateRow(row));
        }
        const activeToggle = row.querySelector('[data-active-toggle]');
        if (activeToggle) {
          activeToggle.addEventListener('change', () => {
            row.classList.toggle('row-active', activeToggle.checked);
            updateRow(row);
          });
        }
      });

      const factorForm = document.getElementById('factorForm');
      if (factorForm) {
        let saveTimer = null;
        let saving = false;
        const scheduleSave = (immediate = false) => {
          if (saveTimer) clearTimeout(saveTimer);
          const delay = immediate ? 0 : 350;
          saveTimer = setTimeout(async () => {
            if (saving) return;
            saving = true;
            const formData = new FormData(factorForm);
            const body = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
              body.append(key, String(value));
            }
            try {
              const resp = await fetch(factorForm.action, {
                method: 'POST',
                body,
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                  'Content-Type': 'application/x-www-form-urlencoded'
                }
              });
              if (!resp.ok) {
                const data = await resp.json().catch(() => null);
                if (data?.error) {
                  console.error('Auto-save failed:', data.error);
                }
              }
            } catch (err) {
              console.error('Auto-save failed', err);
            } finally {
              saving = false;
            }
          }, delay);
        };
        factorForm.addEventListener('change', scheduleSave);
        factorForm.addEventListener('blur', scheduleSave, true);
        factorForm.addEventListener('submit', (event) => {
          event.preventDefault();
          scheduleSave(true);
        });
      }

      function formatValue(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return '';
        const rounded = Math.round(num * 1000) / 1000;
        let str = String(rounded);
        if (str.includes('.')) {
          str = str.replace(/0+$/, '').replace(/\.$/, '');
        }
        return str;
      }

      function updateFactorSummary() {
        const tbody = document.querySelector('[data-factor-summary-body]');
        if (!tbody) return;
        tbody.innerHTML = '';
        const rows = document.querySelectorAll('[data-param-row]');
        const activeRows = [];
        rows.forEach((row) => {
          const activeToggle = row.querySelector('[data-active-toggle]');
          if (activeToggle && activeToggle.checked) {
            activeRows.push(row);
          }
        });
        if (!activeRows.length) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3">No active factors selected.</td>';
          tbody.appendChild(tr);
          return;
        }
        activeRows.forEach((row) => {
          const modeSelect = row.querySelector('[data-mode-select]');
          const minInput = row.querySelector('input[data-range][name$="_min"]');
          const maxInput = row.querySelector('input[data-range][name$="_max"]');
          const valuesInput = row.querySelector('[data-values]');
          const mode = modeSelect ? modeSelect.value : 'FIXED';
          let valuesText = '';
          if (mode === 'RANGE') {
            valuesText = `${formatValue(minInput?.value)} .. ${formatValue(maxInput?.value)}`.trim();
          } else if (mode === 'LIST') {
            valuesText = valuesInput?.value || '';
          } else {
            valuesText = valuesInput?.value || '';
          }
          const label = row.dataset.paramLabel || '';
          const unit = row.dataset.paramUnit || '';
          const groupKey = row.dataset.groupKey || 'general';

          const tr = document.createElement('tr');
          tr.className = `row-active group-row group-${groupKey}`;
          tr.dataset.groupKey = groupKey;
          tr.innerHTML = `
            <td>${label}</td>
            <td><span class="badge">${mode}</span></td>
            <td>${valuesText}${unit ? ` ${unit}` : ''}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      function parseListCount(raw) {
        if (!raw) return 0;
        return raw
          .split(/[\s,;]+/)
          .map((val) => parseFloat(val))
          .filter((val) => Number.isFinite(val)).length;
      }

      function updateRunPreview() {
        const preview = document.querySelector('[data-run-preview]');
        if (!preview) return;
        const designType = '<%= doe.design_type %>';
        const centerPoints = Number('<%= doe.center_points %>');
        const maxRuns = Number('<%= doe.max_runs %>');
        const replicateCount = Number('<%= doe.replicate_count %>');
        const recipeAsBlock = Number('<%= doe.recipe_as_block %>');
        const recipeCount = Number('<%= linkedRecipes.length %>');
        const activeRows = Array.from(document.querySelectorAll('[data-param-row]')).filter((row) => {
          const activeToggle = row.querySelector('[data-active-toggle]');
          return activeToggle && activeToggle.checked;
        });

        const levelCounts = activeRows.map((row) => {
          const modeSelect = row.querySelector('[data-mode-select]');
          const valuesInput = row.querySelector('[data-values]');
          const levelsSelect = row.querySelector('[data-levels]');
          const mode = modeSelect ? modeSelect.value : 'FIXED';
          if (mode === 'LIST') {
            return parseListCount(valuesInput?.value || '');
          }
          if (mode === 'RANGE') {
            const levels = Number(levelsSelect?.value || '2');
            return levels === 3 ? 3 : 2;
          }
          return 1;
        });

        const threeLevelFlags = activeRows.map((row) => {
          const modeSelect = row.querySelector('[data-mode-select]');
          const valuesInput = row.querySelector('[data-values]');
          const minInput = row.querySelector('input[data-range][name$="_min"]');
          const maxInput = row.querySelector('input[data-range][name$="_max"]');
          const mode = modeSelect ? modeSelect.value : 'FIXED';
          if (mode === 'LIST') {
            return parseListCount(valuesInput?.value || '') === 3;
          }
          if (mode === 'RANGE') {
            if (designType === 'BBD') {
              const minVal = parseFloat(minInput?.value || '');
              const maxVal = parseFloat(maxInput?.value || '');
              return Number.isFinite(minVal) && Number.isFinite(maxVal);
            }
            const levelsSelect = row.querySelector('[data-levels]');
            return Number(levelsSelect?.value || '2') === 3;
          }
          return false;
        });

        let baseRuns = 0;
        let formula = '';
        let warning = '';
        if (designType === 'SIM') {
          baseRuns = levelCounts.length
            ? levelCounts.reduce((acc, val) => acc * Math.max(val, 1), 1)
            : 0;
          formula = `SIM: product(levels) = ${baseRuns}`;
        } else if (designType === 'FFA') {
          baseRuns = levelCounts.length
            ? levelCounts.reduce((acc, val) => acc * Math.max(val, 1), 1)
            : 0;
          formula = `FFA: product(levels) = ${baseRuns}`;
        } else if (designType === 'BBD') {
          const k = threeLevelFlags.filter(Boolean).length;
          baseRuns = k >= 2 ? 4 * (k * (k - 1)) / 2 + (centerPoints || 0) : 0;
          formula = `BBD: 4*C(k,2)+center = ${baseRuns} (k=${k})`;
          if (k < 2) {
            warning = `BBD needs at least 2 factors with 3 levels. Currently: ${k}. Set Levels=3 or use LIST with 3 values.`;
          }
        } else {
          const k = levelCounts.length;
          const fullCombos = k > 0 ? Math.pow(2, k) : 0;
          baseRuns = Math.min(maxRuns || fullCombos, fullCombos);
          formula = `SCREEN: min(max_runs, 2^k) = ${baseRuns} (k=${k})`;
        }

        const recipeMultiplier = recipeAsBlock === 1 && recipeCount > 0 ? recipeCount : 1;
        const replicateMultiplier = Math.max(replicateCount || 1, 1);
        const totalRuns = baseRuns * recipeMultiplier * replicateMultiplier;

        const totalEl = document.querySelector('[data-run-total]');
        const baseEl = document.querySelector('[data-run-base]');
        const recipesEl = document.querySelector('[data-run-recipes]');
        const repsEl = document.querySelector('[data-run-replicates]');
        const formulaEl = document.querySelector('[data-run-formula]');
        const warningEl = document.querySelector('[data-run-warning]');

        if (totalEl) totalEl.textContent = String(totalRuns);
        if (baseEl) baseEl.textContent = String(baseRuns);
        if (recipesEl) recipesEl.textContent = String(recipeMultiplier);
        if (repsEl) repsEl.textContent = String(replicateMultiplier);
        if (formulaEl) formulaEl.textContent = formula;
        if (warningEl) {
          warningEl.style.display = warning ? '' : 'none';
          warningEl.innerHTML = warning ? `<strong>${warning}</strong>` : '';
        }
      }

      document.querySelectorAll('[data-param-row]').forEach((row) => {
        row.addEventListener('change', updateFactorSummary);
        row.addEventListener('blur', updateFactorSummary, true);
        row.addEventListener('change', updateRunPreview);
        row.addEventListener('blur', updateRunPreview, true);
      });
      updateFactorSummary();
      updateRunPreview();

      function applyGroupColors() {
        const chips = Array.from(document.querySelectorAll('.group-chip')).filter((chip) => {
          return chip.dataset.groupFilter && chip.dataset.groupFilter !== 'all';
        });
        const palette = [18, 42, 90, 140, 200, 250, 300, 330];
        chips.forEach((chip, idx) => {
          const hue = palette[idx % palette.length];
          const color = `hsl(${hue} 60% 40%)`;
          const bg = `hsla(${hue} 60% 92% / 0.6)`;
          chip.style.setProperty('--chip-color', color);
          chip.style.setProperty('--chip-bg', bg);
          const key = chip.dataset.groupFilter;
          document.querySelectorAll(`[data-group-key="${key}"]`).forEach((row) => {
            row.style.setProperty('--group-color', color);
            row.style.setProperty('--group-bg', bg);
          });
        });
      }

      function wireGroupFilter() {
        const container = document.querySelector('[data-group-filter]');
        if (!container) return;
        container.addEventListener('click', (event) => {
          const target = event.target.closest('.group-chip');
          if (!target) return;
          const key = target.dataset.groupFilter || 'all';
          container.querySelectorAll('.group-chip').forEach((chip) => {
            chip.classList.toggle('active', chip === target);
          });
          document.querySelectorAll('[data-param-row]').forEach((row) => {
            const rowKey = row.dataset.groupKey;
            row.style.display = key === 'all' || rowKey === key ? '' : 'none';
          });
        });
      }

      applyGroupColors();
      wireGroupFilter();
    </script>
  <% } %>

  <% if (tab === 'runs') { %>
    <div class="card">
      <h2 class="card-title">Runs</h2>
      <div class="run-controls">
        <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/doe/<%= doeId %>/export/runs">Export Runs CSV</a>
        <a class="pure-button" href="/experiments/<%= experiment.id %>/doe/<%= doeId %>/export/wide">Export Wide CSV</a>
      </div>
      <% const recipeMap = new Map(); recipes.forEach(r => recipeMap.set(r.id, r.name)); %>
      <% const activeMap = new Map(); activeInputParams.forEach(p => activeMap.set(p.id, p)); %>
      <table class="pure-table table-compact" style="margin-top: 1rem;">
        <thead>
          <tr>
            <th>Run</th>
            <th>Recipe</th>
            <th>Done</th>
            <th>Exclude</th>
            <% activeInputParams.forEach((param) => { %>
              <th><%- formatInline(param.label) %> <span class="small-note"><%- formatInline(param.unit || '') %></span></th>
            <% }); %>
          </tr>
        </thead>
        <tbody>
          <% if (runs.length === 0) { %>
            <tr><td colspan="<%= 4 + activeInputParams.length %>">No runs yet. Generate a runlist.</td></tr>
          <% } %>
          <% runRows.forEach((run) => { %>
            <tr class="<%= run.done ? 'run-done' : '' %> <%= run.exclude_from_analysis ? 'run-excluded' : '' %>">
              <td><a href="/runs/<%= run.id %>"><%= run.run_code %></a></td>
              <td><%- run.recipe_id ? formatInline(recipeMap.get(run.recipe_id)) : '-' %></td>
              <td><%= run.done ? 'Yes' : 'No' %></td>
              <td><%= run.exclude_from_analysis ? 'Yes' : 'No' %></td>
              <% activeInputParams.forEach((param) => { %>
                <td><%= formatNumber(run.values[param.id]) %></td>
              <% }); %>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>

  <% if (tab === 'analysis') { %>
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Analysis Controls</h2>
        <button class="pure-button pure-button-secondary" type="button" id="openMeasuredFieldsDialog">Manage measured fields</button>
      </div>
      <p class="small-note" id="noActiveNumericOutputs" <%= outputNumericParams.length === 0 ? '' : 'style="display:none;"' %>><strong>No active numeric outputs.</strong> Enable measured fields to run analysis.</p>
      <form class="pure-form pure-form-stacked" method="get" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>">
        <input type="hidden" name="tab" value="analysis">
        <div class="grid-two">
          <div>
            <label>Output</label>
            <select name="output_param" id="outputParamSelect">
              <% outputNumericParams.forEach((param) => { %>
                <option value="<%= param.id %>" <%= analysis?.outputParamId === param.id ? 'selected' : '' %>><%= param.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>X Factor</label>
            <select name="x_param">
              <% activeInputParams.forEach((param) => { %>
                <option value="<%= param.id %>" <%= analysis?.xParamId === param.id ? 'selected' : '' %>><%= param.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Y Factor (Heatmap)</label>
            <select name="y_param">
              <% activeInputParams.forEach((param) => { %>
                <option value="<%= param.id %>" <%= analysis?.yParamId === param.id ? 'selected' : '' %>><%= param.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Recipe Filter</label>
            <% if (linkedRecipeOptions.length > 0) { %>
              <select name="recipe_id">
                <option value="">All</option>
                <% linkedRecipeOptions.forEach((recipe) => { %>
                  <option value="<%= recipe.id %>" <%= analysis?.recipeId === recipe.id ? 'selected' : '' %>><%= recipe.name %></option>
                <% }); %>
              </select>
            <% } else { %>
              <div class="small-note">No linked recipes.</div>
            <% } %>
          </div>
          <div>
            <label>Tag Field</label>
            <select name="tag_field" id="tagFieldSelect">
              <option value="">None</option>
              <% tagOutputFields.forEach((field) => { %>
                <option value="<%= field.id %>" <%= analysis?.tagFieldId === field.id ? 'selected' : '' %>><%= field.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Tag Value</label>
            <select id="tagValueSelect">
              <option value="">Select tag</option>
            </select>
            <div class="tag-cloud" id="tagValueChips"></div>
            <div id="tagValueInputs"></div>
          </div>
          <div>
            <label>Boolean Field</label>
            <select name="bool_field" id="boolFieldSelect">
              <option value="">None</option>
              <% booleanOutputFields.forEach((field) => { %>
                <option value="<%= field.id %>" <%= analysis?.boolFieldId === field.id ? 'selected' : '' %>><%= field.label %></option>
              <% }); %>
            </select>
          </div>
          <div>
            <label>Boolean Value</label>
            <select name="bool_value">
              <option value="">Any</option>
              <option value="1" <%= analysis?.boolValue === 1 ? 'selected' : '' %>>True</option>
              <option value="0" <%= analysis?.boolValue === 0 ? 'selected' : '' %>>False</option>
            </select>
          </div>
        </div>
        <button class="pure-button pure-button-primary" type="submit">Update Analysis</button>
      </form>
    </div>

    <div class="grid-two chart-grid">
      <div class="card chart-card" id="lineChart"></div>
      <div class="card chart-card" id="heatmapChart"></div>
      <div class="card chart-card" id="scatterChart"></div>
      <div class="card chart-card" id="scatter3d"></div>
    </div>

    <div class="card">
      <h2 class="card-title">Decision Notes</h2>
      <p class="small-note">
        Trends are descriptive. Low replicate counts and missing data reduce confidence.
      </p>
      <div>
        <strong>Model (linear) R2:</strong> <%= analysis?.regression?.r2?.toFixed ? analysis.regression.r2.toFixed(3) : 'n/a' %>
      </div>
      <div>
        <strong>Overall:</strong>
        <%= Number.isFinite(analysis?.overall?.mean) ? analysis.overall.mean.toFixed(3) : 'n/a' %>
        (SD <%= Number.isFinite(analysis?.overall?.sd) ? analysis.overall.sd.toFixed(3) : 'n/a' %>,
        n=<%= analysis?.overall?.n ?? 0 %>)
      </div>
      <% if (analysis?.tagPenaltyRate != null) { %>
        <div>
          <strong>Tag rate:</strong> <%= (analysis.tagPenaltyRate * 100).toFixed(1) %>%
        </div>
      <% } %>
      <% if (analysis?.boolPenaltyRate != null) { %>
        <div>
          <strong>Boolean rate:</strong> <%= (analysis.boolPenaltyRate * 100).toFixed(1) %>%
        </div>
      <% } %>
      <table class="pure-table table-compact" style="margin-top: 1rem;">
        <thead>
          <tr>
            <th>Factor Level</th>
            <th>Mean</th>
            <th>SD</th>
            <th>N</th>
          </tr>
        </thead>
        <tbody>
          <% if ((analysis?.summary || []).length === 0) { %>
            <tr><td colspan="4">No summary available.</td></tr>
          <% } %>
          <% (analysis?.summary || []).forEach((row) => { %>
            <tr>
              <td><%= row.factor %></td>
              <td><%= Number.isFinite(row.mean) ? row.mean.toFixed(3) : '-' %></td>
              <td><%= Number.isFinite(row.sd) ? row.sd.toFixed(3) : '-' %></td>
              <td><%= row.n %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <script src="/vendor/echarts/dist/echarts.min.js"></script>
    <script>
      const summary = <%- JSON.stringify(analysis?.summary || []) %>;
      const heatmap = <%- JSON.stringify(analysis?.heatmap || []) %>;
      const scatter = <%- JSON.stringify(analysis?.scatter || []) %>;
      const scatter3dData = <%- JSON.stringify(analysis?.scatter3d || []) %>;
      const inputMeta = <%- JSON.stringify(activeInputParams.map((p) => ({ id: p.id, label: p.label, unit: p.unit || '' }))) %>;
      const outputMeta = <%- JSON.stringify(outputNumericParams.map((p) => ({ id: p.id, label: p.label, unit: p.unit || '' }))) %>;
      const selectedOutputId = <%- JSON.stringify(analysis?.outputParamId || null) %>;
      const selectedXId = <%- JSON.stringify(analysis?.xParamId || null) %>;
      const selectedYId = <%- JSON.stringify(analysis?.yParamId || null) %>;

      const lineChart = echarts.init(document.getElementById('lineChart'));
      const finite = (value) => Number.isFinite(value);
      const extent = (values) => {
        const filtered = values.filter(finite);
        if (!filtered.length) return null;
        return [Math.min(...filtered), Math.max(...filtered)];
      };
      const pad = (range, ratio = 0.08) => {
        if (!range) return null;
        const [min, max] = range;
        if (min === max) return [min - 1, max + 1];
        const span = (max - min) * ratio;
        return [min - span, max + span];
      };
      const metaMap = (list) => new Map(list.map((item) => [item.id, item]));
      const inputMap = metaMap(inputMeta);
      const outputMap = metaMap(outputMeta);
      const formatLabel = (meta) => (meta ? `${meta.label}${meta.unit ? ` (${meta.unit})` : ''}` : '');
      const xLabel = formatLabel(inputMap.get(selectedXId));
      const yLabel = formatLabel(inputMap.get(selectedYId));
      const outputLabel = formatLabel(outputMap.get(selectedOutputId));
      const sdScale = 1;
      const upper = summary.map(s => s.mean + (s.sd || 0) * sdScale);
      const lower = summary.map(s => s.mean - (s.sd || 0) * sdScale);
      const band = upper.map((val, idx) => val - lower[idx]);
      const yRange = pad(extent([...upper, ...lower, ...summary.map(s => s.mean)]));
      lineChart.setOption({
        title: { text: 'Mean vs Factor' },
        tooltip: {},
        xAxis: {
          type: 'category',
          data: summary.map(s => s.factor),
          name: xLabel,
          nameLocation: 'middle',
          nameGap: 28
        },
        yAxis: {
          type: 'value',
          min: yRange ? yRange[0] : undefined,
          max: yRange ? yRange[1] : undefined,
          name: outputLabel,
          nameLocation: 'middle',
          nameGap: 40,
          axisLabel: {
            formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val
          }
        },
        series: [
          {
            type: 'line',
            data: lower,
            smooth: true,
            stack: 'sd',
            lineStyle: { opacity: 0 },
            showSymbol: false,
            emphasis: { disabled: true }
          },
          {
            type: 'line',
            data: band,
            smooth: true,
            stack: 'sd',
            lineStyle: { opacity: 0 },
            showSymbol: false,
            areaStyle: { opacity: 0.2, color: '#5b8ff9' },
            name: `Mean ± ${sdScale} SD`
          },
          { type: 'line', data: summary.map(s => s.mean), smooth: true, name: 'Mean' }
        ]
      });

      const heatmapChart = echarts.init(document.getElementById('heatmapChart'));
      const xVals = [...new Set(heatmap.map(h => h.x))].sort((a,b) => a-b);
      const yVals = [...new Set(heatmap.map(h => h.y))].sort((a,b) => a-b);
      const heatmapData = heatmap.map(h => [xVals.indexOf(h.x), yVals.indexOf(h.y), h.mean, h.sd, h.n]);
      const heatExtent = extent(heatmap.map(h => h.mean));
      heatmapChart.setOption({
        title: { text: 'Heatmap' },
        tooltip: {
          formatter: (params) => {
            const [x, y, mean, sd, n] = params.data;
            return `Mean: ${mean?.toFixed ? mean.toFixed(3) : mean}<br>SD: ${sd?.toFixed ? sd.toFixed(3) : sd}<br>N: ${n}`;
          }
        },
        xAxis: {
          type: 'category',
          data: xVals,
          name: xLabel,
          nameLocation: 'middle',
          nameGap: 28
        },
        yAxis: {
          type: 'category',
          data: yVals,
          name: yLabel,
          nameLocation: 'middle',
          nameGap: 40
        },
        visualMap: {
          dimension: 2,
          min: heatExtent ? heatExtent[0] : 0,
          max: heatExtent ? heatExtent[1] : 1,
          calculable: true,
          orient: 'horizontal',
          text: [outputLabel || 'Output', ''],
          formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val,
          inRange: {
            color: ['#fff1a6', '#f6b26b', '#d64545']
          }
        },
        series: [{ type: 'heatmap', data: heatmapData }]
      });

      const scatterChart = echarts.init(document.getElementById('scatterChart'));
      const recipes = [...new Set(scatter.map(s => s.recipe_id))];
      const scatterX = pad(extent(scatter.map(s => s.x)));
      const scatterY = pad(extent(scatter.map(s => s.y)));
      scatterChart.setOption({
        title: { text: 'Scatter' },
        tooltip: {
          formatter: (params) => {
            const [x, y] = params.data || [];
            return `${xLabel}: ${x}<br>${outputLabel}: ${y}`;
          }
        },
        xAxis: {
          type: 'value',
          min: scatterX ? scatterX[0] : undefined,
          max: scatterX ? scatterX[1] : undefined,
          name: xLabel,
          nameLocation: 'middle',
          nameGap: 28,
          axisLabel: {
            formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val
          }
        },
        yAxis: {
          type: 'value',
          min: scatterY ? scatterY[0] : undefined,
          max: scatterY ? scatterY[1] : undefined,
          name: outputLabel,
          nameLocation: 'middle',
          nameGap: 40,
          axisLabel: {
            formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val
          }
        },
        visualMap: {
          type: 'piecewise',
          dimension: 2,
          categories: recipes,
          inRange: { color: ['#e05f2b', '#2c7ea0', '#6a5acd', '#2f9c74'] },
          top: 30,
          right: 10
        },
        series: [{ type: 'scatter', data: scatter.map(s => [s.x, s.y, s.recipe_id]) }]
      });

      const responseChart = echarts.init(document.getElementById('scatter3d'));
      const responseX = pad(extent(scatter3dData.map(h => h.x)));
      const responseY = pad(extent(scatter3dData.map(h => h.y)));
      const responseZ = pad(extent(scatter3dData.map(h => h.z)));
      responseChart.setOption({
        title: { text: scatter3dData.length > 8 ? 'Response Surface (color)' : 'Response Surface (insufficient data)' },
        tooltip: {
          formatter: (params) => {
            const [x, y, z] = params.data || [];
            return `${xLabel}: ${x}<br>${yLabel}: ${y}<br>${outputLabel}: ${z}`;
          }
        },
        xAxis: {
          type: 'value',
          min: responseX ? responseX[0] : undefined,
          max: responseX ? responseX[1] : undefined,
          name: xLabel,
          nameLocation: 'middle',
          nameGap: 28,
          axisLabel: {
            formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val
          }
        },
        yAxis: {
          type: 'value',
          min: responseY ? responseY[0] : undefined,
          max: responseY ? responseY[1] : undefined,
          name: yLabel,
          nameLocation: 'middle',
          nameGap: 40,
          axisLabel: {
            formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val
          }
        },
        visualMap: {
          min: responseZ ? responseZ[0] : 0,
          max: responseZ ? responseZ[1] : 1,
          calculable: true,
          orient: 'horizontal',
          text: [outputLabel || 'Output', ''],
          formatter: (val) => Number.isFinite(val) ? Number(val).toFixed(2) : val
        },
        series: [
          {
            type: 'scatter',
            data: scatter3dData.map(h => [h.x, h.y, h.z]),
            symbolSize: 14
          }
        ]
      });

      const charts = [lineChart, heatmapChart, scatterChart, responseChart];
      window.addEventListener('resize', () => {
        charts.forEach((chart) => chart.resize());
      });
    </script>
  <% } %>
</div>

<dialog id="measuredFieldsDialog" class="modal-frame">
  <div class="modal-header">
    <strong>Measured Fields</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <div class="modal-body">
    <div class="card">
      <h2 class="card-title">Standard fields</h2>
      <p class="small-note">Activate per experiment. Deactivating keeps stored data.</p>
      <form method="POST" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/analysis-fields/standard" data-autosave="standard">
        <div class="field-grid">
          <% standardAnalysisFields.forEach((field) => { %>
            <label class="field-chip" data-standard-chip data-group-label="<%= field.group_label || 'Custom' %>">
              <input type="checkbox" name="standard_codes" value="<%= field.code %>" <%= field.is_active ? 'checked' : '' %>>
              <div class="field-content">
                <div class="field-title"><%- formatInline(field.label) %></div>
                <div class="field-meta">
                  <%= field.field_type %>
                  <% if (field.unit) { %> · <%- formatInline(field.unit) %><% } %>
                  <% if (field.group_label) { %> · <%- formatInline(field.group_label) %><% } %>
                </div>
              </div>
            </label>
          <% }); %>
        </div>
        <div style="margin-top: 1rem;">
          <button class="pure-button pure-button-primary" type="submit">Save standard fields</button>
          <span class="small-note" data-autosave-status></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top: 1rem;">
      <h2 class="card-title">Custom fields</h2>
      <% if (customAnalysisFields.length === 0) { %>
        <p class="small-note" id="customFieldsEmpty">No custom fields yet.</p>
      <% } %>
      <form method="POST" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/analysis-fields/custom" data-autosave="custom" id="customFieldsForm">
        <div class="table-wrap">
          <table class="pure-table table-compact field-table">
            <thead>
              <tr>
                <th>Active</th>
                <th>Label</th>
                <th>Type</th>
                <th>Unit</th>
                <th>Group</th>
                <th>Allowed values</th>
              </tr>
            </thead>
            <tbody id="customFieldsBody">
                <% customAnalysisFields.forEach((field) => { %>
                  <tr>
                    <td>
                      <input type="hidden" name="custom[<%= field.id %>][is_active]" value="0">
                      <input type="checkbox" name="custom[<%= field.id %>][is_active]" value="1" <%= field.is_active ? 'checked' : '' %> data-custom-active data-field-id="<%= field.id %>">
                    </td>
                  <td><input name="custom[<%= field.id %>][label]" value="<%= field.label %>"></td>
                  <td><span class="badge"><%= field.field_type %></span></td>
                  <td><input name="custom[<%= field.id %>][unit]" value="<%= field.unit || '' %>"></td>
                  <td><input name="custom[<%= field.id %>][group_label]" value="<%= field.group_label || '' %>"></td>
                  <td>
                    <input name="custom[<%= field.id %>][allowed_values]" value="<%= field.allowedValues ? field.allowedValues.join(', ') : '' %>" <%= field.field_type === 'tag' ? '' : 'disabled' %>>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
        <div style="margin-top: 1rem;">
          <button class="pure-button pure-button-primary" type="submit">Save custom fields</button>
          <span class="small-note" data-autosave-status></span>
        </div>
      </form>
    </div>

    <div class="card" style="margin-top: 1rem;">
      <h2 class="card-title">Add new field</h2>
      <form method="POST" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/analysis-fields/new" id="analysisFieldCreateForm">
        <div class="grid-two">
          <div>
            <label>Label</label>
            <input name="label" required>
          </div>
          <div>
            <label>Code</label>
            <input name="code" placeholder="part_weight_g">
          </div>
          <div>
            <label>Type</label>
            <select name="field_type">
              <option value="number">Number</option>
              <option value="text">Text</option>
              <option value="tag">Tag</option>
              <option value="boolean">Boolean</option>
            </select>
          </div>
          <div>
            <label>Unit</label>
            <input name="unit">
          </div>
          <div>
            <label>Group</label>
            <input name="group_label">
          </div>
          <div>
            <label>Allowed values (tags)</label>
            <input name="allowed_values" placeholder="short_shot, flash">
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <button class="pure-button pure-button-primary" type="submit">Add field</button>
        </div>
      </form>
    </div>
  </div>
  <div class="modal-footer">
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
</dialog>

<script>
  const measuredDialog = document.getElementById('measuredFieldsDialog');
  const openMeasuredDialog = document.getElementById('openMeasuredFieldsDialog');
  if (openMeasuredDialog && measuredDialog) {
    openMeasuredDialog.addEventListener('click', () => measuredDialog.showModal());
  }
  if (measuredDialog) {
    measuredDialog.querySelectorAll('[data-close]').forEach((btn) => {
      btn.addEventListener('click', () => measuredDialog.close());
    });
  }

  const createForm = document.getElementById('analysisFieldCreateForm');
  if (createForm) {
    const labelInput = createForm.querySelector('input[name="label"]');
    const codeInput = createForm.querySelector('input[name="code"]');
    let codeTouched = false;
    if (codeInput) {
      codeInput.addEventListener('input', () => {
        codeTouched = codeInput.value.trim().length > 0;
      });
    }
    if (labelInput && codeInput) {
      labelInput.addEventListener('input', () => {
        if (codeTouched) return;
        const slug = labelInput.value
          .toLowerCase()
          .replace(/[^a-z0-9]+/g, '_')
          .replace(/^_+|_+$/g, '');
        codeInput.value = slug;
      });
    }
  }

  function setupAutosave(form) {
    if (!form) return;
    const status = form.querySelector('[data-autosave-status]');
    let timer = null;

    const submit = () => {
      const body = new URLSearchParams(new FormData(form));
      if (status) status.textContent = 'Saving...';
      return fetch(form.action, {
        method: form.method || 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body
      })
        .then((res) => {
          if (!res.ok) throw new Error('Save failed');
          if (status) status.textContent = 'Saved';
          return true;
        })
        .catch(() => {
          if (status) status.textContent = 'Save failed';
          return false;
        });
    };

    const schedule = () => {
      if (timer) window.clearTimeout(timer);
      timer = window.setTimeout(() => {
        submit().then((ok) => {
          if (ok) refreshActiveFields();
        });
      }, 200);
    };

    form.addEventListener('change', (event) => {
      if (event.target && event.target.matches('input, select, textarea')) {
        schedule();
      }
    });
    form.addEventListener('submit', (event) => {
      event.preventDefault();
      submit().then((ok) => {
        if (ok) refreshActiveFields();
      });
    });
  }

  const outputSelect = document.getElementById('outputParamSelect');
  const tagSelect = document.getElementById('tagFieldSelect');
  const boolSelect = document.getElementById('boolFieldSelect');
  const tagValueSelect = document.getElementById('tagValueSelect');
  const tagValueChips = document.getElementById('tagValueChips');
  const tagValueInputs = document.getElementById('tagValueInputs');
  const noNumericNote = document.getElementById('noActiveNumericOutputs');
  const initialTagValues = <%- JSON.stringify(analysis?.tagValues || []) %>;

  function setOptions(select, options, includeNone) {
    if (!select) return;
    const current = select.value;
    const fragment = document.createDocumentFragment();
    if (includeNone) {
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'None';
      fragment.appendChild(opt);
    }
    options.forEach((option) => {
      const opt = document.createElement('option');
      opt.value = String(option.id);
      opt.textContent = option.label;
      fragment.appendChild(opt);
    });
    select.innerHTML = '';
    select.appendChild(fragment);
    const stillExists = options.some((opt) => String(opt.id) === current);
    if (stillExists) {
      select.value = current;
    } else if (!includeNone && options.length > 0) {
      select.value = String(options[0].id);
    } else {
      select.value = '';
    }
  }

  function refreshActiveFields() {
    return fetch(`/experiments/<%= experiment.id %>/doe/<%= doeId %>/analysis-fields/active`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then((res) => res.json())
      .then((payload) => {
        const fields = Array.isArray(payload.fields) ? payload.fields : [];
        const numeric = fields.filter((field) => field.field_type === 'number');
        const tags = fields.filter((field) => field.field_type === 'tag');
        const bools = fields.filter((field) => field.field_type === 'boolean');
        setOptions(outputSelect, numeric, false);
        setOptions(tagSelect, tags, true);
        setOptions(boolSelect, bools, true);
        if (noNumericNote) {
          noNumericNote.style.display = numeric.length === 0 ? '' : 'none';
        }
        if (outputSelect) outputSelect.disabled = numeric.length === 0;
        refreshTagValues(false);
      })
      .catch(() => {
        // Ignore refresh errors; page still works on reload.
      });
  }

  function renderTagChips(selected) {
    if (!tagValueChips || !tagValueInputs) return;
    tagValueChips.innerHTML = '';
    tagValueInputs.innerHTML = '';
    selected.forEach((tag) => {
      const chip = document.createElement('span');
      chip.className = 'tag-chip tag-chip-remove';
      const label = tag === '__none__' ? 'No tags' : tag;
      chip.innerHTML = `<span>${label}</span><button type="button" aria-label="Remove ${label}">×</button>`;
      chip.querySelector('button').addEventListener('click', () => {
        selected.delete(tag);
        renderTagChips(selected);
      });
      tagValueChips.appendChild(chip);
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'tag_value';
      input.value = tag;
      tagValueInputs.appendChild(input);
    });
  }

  function setTagOptions(values) {
    if (!tagValueSelect) return;
    const fragment = document.createDocumentFragment();
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'Select tag';
    fragment.appendChild(placeholder);
    const noneOpt = document.createElement('option');
    noneOpt.value = '__none__';
    noneOpt.textContent = 'No tags';
    fragment.appendChild(noneOpt);
    values.forEach((value) => {
      const opt = document.createElement('option');
      opt.value = value;
      opt.textContent = value;
      fragment.appendChild(opt);
    });
    tagValueSelect.innerHTML = '';
    tagValueSelect.appendChild(fragment);
  }

  function refreshTagValues(clearSelection) {
    if (!tagSelect || !tagValueSelect) return;
    const fieldId = tagSelect.value;
    if (!fieldId) {
      setTagOptions([]);
      if (clearSelection && selectedTags) selectedTags.clear();
      renderTagChips(selectedTags);
      return;
    }
    fetch(`/experiments/<%= experiment.id %>/doe/<%= doeId %>/analysis-fields/tag-values?field_id=${fieldId}`, {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
      .then((res) => res.json())
      .then((payload) => {
        const values = Array.isArray(payload.values) ? payload.values : [];
        setTagOptions(values);
        if (clearSelection && selectedTags) selectedTags.clear();
        renderTagChips(selectedTags);
      })
      .catch(() => {
        // Ignore tag refresh errors.
      });
  }

  const selectedTags = new Set(initialTagValues);
  renderTagChips(selectedTags);
  refreshTagValues(false);

  if (tagSelect) {
    tagSelect.addEventListener('change', () => {
      refreshTagValues(true);
    });
  }

  if (tagValueSelect) {
    tagValueSelect.addEventListener('change', () => {
      const value = tagValueSelect.value;
      if (!value) return;
      selectedTags.add(value);
      renderTagChips(selectedTags);
      tagValueSelect.value = '';
    });
  }

  setupAutosave(document.querySelector('form[data-autosave="standard"]'));
  setupAutosave(document.querySelector('form[data-autosave="custom"]'));

  if (createForm) {
    const customBody = document.getElementById('customFieldsBody');
    const customEmpty = document.getElementById('customFieldsEmpty');

    const buildCustomRow = (field) => {
      const row = document.createElement('tr');
      const allowedValues = Array.isArray(field.allowed_values) ? field.allowed_values : [];
      const allowedValueText = allowedValues.join(', ');
      row.innerHTML = `
        <td>
          <input type="hidden" name="custom[${field.id}][is_active]" value="0">
          <input type="checkbox" name="custom[${field.id}][is_active]" value="1" ${field.is_active ? 'checked' : ''} data-custom-active data-field-id="${field.id}">
        </td>
        <td><input name="custom[${field.id}][label]" value="${field.label || ''}"></td>
        <td><span class="badge">${field.field_type}</span></td>
        <td><input name="custom[${field.id}][unit]" value="${field.unit || ''}"></td>
        <td><input name="custom[${field.id}][group_label]" value="${field.group_label || ''}"></td>
        <td>
          <input name="custom[${field.id}][allowed_values]" value="${allowedValueText}" ${field.field_type === 'tag' ? '' : 'disabled'}>
        </td>
      `;
      return row;
    };

    createForm.addEventListener('submit', (event) => {
      event.preventDefault();
      const body = new URLSearchParams(new FormData(createForm));
      fetch(createForm.action, {
        method: createForm.method || 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body
      })
        .then((res) => {
          if (!res.ok) throw new Error('Create failed');
          return res.json();
        })
        .then((payload) => {
          if (!payload || !payload.field) return;
          if (customBody) {
            customBody.appendChild(buildCustomRow(payload.field));
          }
          if (customEmpty) customEmpty.remove();
          createForm.reset();
          refreshActiveFields();
        })
        .catch(() => {
          // Keep the form values so user can retry.
        });
    });
  }

  if (measuredDialog) {
    const updateChip = (chip) => {
      const input = chip.querySelector('input[type="checkbox"]');
      if (!input) return;
      chip.classList.toggle('is-active', input.checked);
    };
    const palette = [18, 42, 90, 140, 200, 250, 300, 330];
    const groupColors = new Map();
    measuredDialog.querySelectorAll('[data-standard-chip]').forEach((chip) => {
      updateChip(chip);
      const label = chip.dataset.groupLabel || 'Custom';
      if (!groupColors.has(label)) {
        const hue = palette[groupColors.size % palette.length];
        groupColors.set(label, {
          accent: `hsl(${hue} 60% 42%)`,
          bg: `hsla(${hue} 60% 92% / 0.9)`
        });
      }
      const colors = groupColors.get(label);
      chip.style.setProperty('--group-accent', colors.accent);
      chip.style.setProperty('--group-bg', colors.bg);
    });
    measuredDialog.addEventListener('change', (event) => {
      const checkbox = event.target;
      const chip = checkbox && checkbox.closest('[data-standard-chip]');
      if (chip) updateChip(chip);
      if (!checkbox || !checkbox.matches('[data-custom-active]')) return;
      const fieldId = checkbox.getAttribute('data-field-id');
      if (!fieldId) return;
      const params = new URLSearchParams();
      params.set('field_id', fieldId);
      params.set('is_active', checkbox.checked ? '1' : '0');
      fetch(`/experiments/<%= experiment.id %>/doe/<%= doeId %>/analysis-fields/custom/active`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: params
      })
        .then(() => refreshActiveFields())
        .catch(() => {
          // Ignore network errors; user can retry by toggling.
        });
    });
  }
</script>
<%- include('partials/foot') %>

<dialog class="modal-frame" id="doeNameDialog">
  <div class="modal-header">
    <strong>Edit DOE name</strong>
    <button class="pure-button" type="button" data-close>Close</button>
  </div>
  <form class="pure-form" action="/experiments/<%= experiment.id %>/doe/<%= doeId %>/name" method="post">
    <div class="modal-body">
      <label for="doeNameInput">DOE name</label>
      <input id="doeNameInput" name="name" type="text" value="<%- formatInline(doe.name) %>" required>
    </div>
    <div class="modal-footer">
      <button class="pure-button" type="button" data-close>Cancel</button>
      <button class="pure-button pure-button-primary" type="submit">Save</button>
    </div>
  </form>
</dialog>

<script>
  const doeNameDialog = document.getElementById('doeNameDialog');
  document.getElementById('openDoeNameDialog')?.addEventListener('click', () => doeNameDialog?.showModal());
  doeNameDialog?.querySelectorAll('[data-close]').forEach((btn) => {
    btn.addEventListener('click', () => doeNameDialog.close());
  });
</script>
