<%- include('partials/head', { title: `Run ${run.run_code}` }) %>
<%- include('partials/nav') %>
<div class="container">
  <div class="card">
    <div class="card-header">
      <a class="back-link" href="/experiments/<%= experiment.id %>/doe/<%= run.doe_id %>?tab=runs" aria-label="Back to detailed optimization runs">
        <span class="material-symbols-rounded" aria-hidden="true">arrow_back</span>
      </a>
      <h1 class="card-title">Run <%= run.run_code %></h1>
    </div>
    <p class="small-note">Experiment: <%- formatInline(experiment.name) %></p>
    <div class="run-controls">
      <% if (prevId) { %>
        <a class="pure-button" href="/runs/<%= prevId %>">Prev</a>
      <% } %>
      <% if (nextId) { %>
        <a class="pure-button" href="/runs/<%= nextId %>">Next</a>
      <% } %>
      <a class="pure-button" href="/experiments/<%= experiment.id %>/doe/<%= run.doe_id %>?tab=runs">Back to Runs</a>
    </div>
  </div>

  <% if (recipe) { %>
    <div class="card">
      <h2 class="card-title">Recipe: <%- formatInline(recipe.name) %></h2>
      <table class="pure-table table-compact">
        <thead>
          <tr>
            <th>Component</th>
            <th>PHR</th>
          </tr>
        </thead>
        <tbody>
          <% components.forEach((component) => { %>
            <tr>
              <td><%- formatInline(component.component_name) %></td>
              <td><%= component.phr %></td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>
  <% } %>

  <%- include('partials/entity_notes', {
    experimentId: experiment.id,
    entityType: 'run',
    entityId: run.id,
    title: 'Run Notes',
    canWrite: currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')
  }) %>

  <form class="pure-form run-form" action="/runs/<%= run.id %>" method="post">
    <div class="card">
      <h2 class="card-title">Inputs</h2>
      <div class="value-list">
        <% inputParams.forEach((param) => { const value = valueMap.get(param.id); %>
          <div class="value-row">
            <div class="value-label"><%- formatInline(param.label) %> <span class="small-note"><%- formatInline(param.unit || '') %></span></div>
            <div class="value-dots"></div>
            <div class="value-value">
              <% if (param.field_type === 'text') { %>
                <%= value?.value_text ?? '-' %>
              <% } else { %>
                <%= formatNumber(value?.value_real) %>
              <% } %>
            </div>
          </div>
        <% }); %>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2 class="card-title">Measured Outputs</h2>
        <a class="pure-button pure-button-secondary" href="/experiments/<%= experiment.id %>/doe/<%= run.doe_id %>?tab=analysis">Manage measured fields</a>
      </div>
      <% if (analysisGroups.length === 0) { %>
        <p class="small-note">No active measured fields. Enable them in the Analysis tab.</p>
      <% } %>
      <% analysisGroups.forEach((group) => { %>
        <div class="output-group">
          <div class="small-note"><strong><%- formatInline(group.group) %></strong></div>
          <div class="outputs-grid">
            <% group.fields.forEach((field) => { const valueRow = analysisValueMap.get(field.id); %>
              <div class="<%= field.field_type === 'tag' ? 'output-card output-tags' : 'output-card' %>">
                <label><%- formatInline(field.label) %> <span class="small-note"><%- formatInline(field.unit || '') %></span></label>
                <% if (field.field_type === 'tag') { %>
                  <% let selected = []; %>
                  <% if (valueRow?.value_tags_json) { try { const parsed = JSON.parse(valueRow.value_tags_json); if (Array.isArray(parsed)) selected = parsed.map(String); } catch {} } %>
                  <input type="hidden" name="analysis_<%= field.id %>" value="">
                  <div class="tag-select" data-tag-select>
                    <div class="tag-selected" data-tag-selected>
                      <% if (selected.length === 0) { %>
                        <span class="tag-placeholder">Select...</span>
                      <% } %>
                      <% selected.forEach((tag) => { %>
                        <span class="tag-chip"><%- formatInline(tag) %></span>
                      <% }); %>
                    </div>
                    <div class="tag-panel" data-tag-panel>
                      <input class="tag-filter" data-tag-filter type="text" placeholder="Filter...">
                      <div class="tag-options">
                        <% field.allowedValues.forEach((tag) => { %>
                          <label class="tag-option" data-tag-option data-tag-label="<%= tag %>">
                            <input type="checkbox" name="analysis_<%= field.id %>" value="<%= tag %>" <%= selected.includes(tag) ? 'checked' : '' %>>
                            <span class="tag-chip"><%- formatInline(tag) %></span>
                          </label>
                        <% }); %>
                      </div>
                    </div>
                  </div>
                <% } else if (field.field_type === 'text') { %>
                  <input type="text" name="analysis_<%= field.id %>" value="<%= valueRow?.value_text ?? '' %>">
                <% } else if (field.field_type === 'boolean') { %>
                  <label class="toggle">
                    <input type="hidden" name="analysis_<%= field.id %>" value="0">
                    <input type="checkbox" name="analysis_<%= field.id %>" value="1" <%= valueRow?.value_real ? 'checked' : '' %>>
                    <span class="track"></span>
                  </label>
                <% } else { %>
                  <input type="number" step="any" name="analysis_<%= field.id %>" value="<%= valueRow?.value_real ?? '' %>">
                <% } %>
              </div>
            <% }); %>
          </div>
        </div>
      <% }); %>
    </div>

    <div class="card">
      <div class="run-controls">
        <label class="pure-checkbox">
          <input type="checkbox" name="done" <%= run.done ? 'checked' : '' %>> Done
        </label>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer')) { %>
          <label class="pure-checkbox">
            <input type="checkbox" name="exclude" <%= run.exclude_from_analysis ? 'checked' : '' %>> Exclude from analysis
          </label>
        <% } %>
        <% if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'manager' || currentUser.role === 'engineer' || currentUser.role === 'operator')) { %>
          <button class="pure-button pure-button-primary" type="submit">Save Run</button>
        <% } %>
      </div>
    </div>
  </form>
</div>
<%- include('partials/foot') %>
