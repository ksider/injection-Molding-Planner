# IM Planner — структурированный план внедрения

## 0) Статус проекта (факт)

### Сделано
1. Базовая ролевая модель и аутентификация (`admin/manager/engineer/operator`).
2. Управление владельцем эксперимента и базовые ACL по сущностям.
3. Переработан UI страницы эксперимента (острова, модалки, выравнивание, статусы).
4. Статусы эксперимента:
- авто-логика + ручной `done` toggle для `admin/manager`.
5. Отчеты:
- подпись/отзыв подписи,
- запрет редактирования и удаления подписанных отчетов,
- бейдж подписанного отчета.
6. Редактор отчетов переведен на `Tiptap` (WYSIWYG), добавлены таблицы/формулы/изображения, автосохранение, toolbar.
7. Поддержка `content_md` в `report_documents` (переходный dual-format).
8. Notes / Lab Journal:
- страница журнала,
- drawer-заметки на страницах эксперимента и сущностей,
- фильтры, rail-навигация, цвета сущностей,
- дневная заметка (`Cmd/Ctrl+Enter`) и принудительно новая (`Cmd/Ctrl+Shift+Enter`).
9. Заметки: редактирование + чеклисты сохраняются в БД + версионирование (`note_versions`).
10. Ссылки заметок по сущностям (включая `doe`, `run`) исправлены.
11. Run-роуты переведены на вложенную модель:
- основной путь `/experiments/:id/runs/:runId`,
- legacy `/runs/:id` сохранен как redirect/compat.
12. Qualification overview убран из основного потока:
- `/experiments/:id/qualification` -> redirect на `/experiments/:id#qualification`,
- компактные карточки шагов qualification встроены в `experiment_detail`.
13. Исправлены точечные регрессии (archive action, маршруты, выравнивания).

### В процессе
1. Полировка UI журнала и связанного drawer (единообразие и плотность).
2. Финальная стабилизация Tiptap-редактора отчетов под реальные сценарии.

---

## 1) Далее — высокий потенциал (делать в первую очередь)

## 1.1 Notes / Journal V2 (внутри текущего релиза)
**Цель:** завершить notes как ежедневный рабочий инструмент.

1. Календарный режим на странице журнала (MVP):
- month-view,
- точки активности по дням,
- клик по дате => фильтр ленты.
2. Единые фильтры:
- `text + date + entity_type` работают одинаково в journal и drawer.
3. UI-доводка:
- единый вид карточек,
- плотные отступы,
- стабильный mobile layout.
4. История правок заметок (UI поверх `note_versions`):
- список версий,
- просмотр diff (минимум plain-diff),
- rollback (опционально вторым шагом).

**DoD:**
1. Любая новая/дописанная заметка сразу видна в правильной позиции.
2. Чеклисты сохраняются без потери состояния.
3. История версии доступна хотя бы на уровне просмотра.

## 1.2 Report Editor stabilization
**Цель:** закрыть редактор отчетов как production-ready.

1. Регрессия по реальным отчетам (10-15 кейсов):
- таблицы,
- формулы,
- изображения,
- чеклисты.
2. PDF (базово уже реализован):
- оставить текущий рабочий экспорт,
- довести print-стили (разрывы страниц, скрытие editor controls, типографика).
3. Финализировать источник экспорта:
- `content_md` как канонический,
- `html_snapshot` как производный кеш.

**DoD:**
1. Подписанный отчет полностью read-only.
2. PDF стабилен на типовых шаблонах.
3. Нет потери структуры при повторных сохранениях.

---

## 2) Средний приоритет (после блока 1)

## 2.1 Экспорт данных
1. CSV экспорт по experiment/doe/qualification/reports.
2. ZIP-пакет `Export All` (+ `metadata.json`).
3. XLSX как отдельный этап.

## 2.2 Календарь пользователя (единая временная лента)
1. Страница `My Calendar` (`Tasks + Notes + Reports`).
2. Виды `Month/Week/Day/Agenda`.
3. Агрегирующий API `/me/calendar/events`.
4. ICS-экспорт и потом Google Calendar интеграция поэтапно.

## 2.3 Поиск и наблюдаемость
1. Глобальный поиск по сущностям.
2. Расширенный аудит изменений (параметры, владельцы, подписи, заметки).

---

## 3) Долгий горизонт (после стабилизации core)

1. Mobile strategy:
- сначала адаптивный web + server-first модель,
- потом selective offline drafts,
- затем (если нужно) ограниченная sync-модель.
2. Internal Mail (внутренняя почта):
- threads/messages/participants,
- интеграция с задачами и экспериментами,
- системные сообщения и in-app уведомления.
3. SPC / CAPA / Golden Run:
- контрольные карты,
- baseline-профили,
- corrective action поток.
4. Webhooks / Events API для внешних интеграций (MES/ERP/LIMS).

---

## 4) Упрощенный roadmap по потенциалу внедрения

## Wave A (быстро и с высокой отдачей)
1. Notes V2 calendar + filters + version UI.
2. Report editor stabilization (включая полировку PDF-стилей).
3. CSV/ZIP export.

## Wave B (средняя сложность, высокий бизнес-эффект)
1. My Calendar (user page).
2. Global search + audit UX.
3. Notifications base (без realtime).

## Wave C (масштабирование)
1. Internal Mail.
2. Mobile/offline strategy.
3. SPC/CAPA + integrations.

---

## 5) Удалено из плана как дубли/устаревшее

1. Повторяющиеся блоки про миграцию `Editor.js -> Tiptap` (оставлен единый статус выше).
2. Дубли про notes drawer/journal, где описывалось одно и то же разными формулировками.
3. Дубли по календарю (объединены в отдельные секции: `Journal Calendar` и `My Calendar`).

---

## 6) Следующий рабочий шаг (предложение на следующий день)

1. Реализовать `note_versions` UI в журнале (кнопка `History`, просмотр версий).
2. Добавить календарь в `Lab Journal` (MVP на месяц + фильтр по дате).
3. Дополировать print-стили для report PDF (без смены текущего механизма экспорта).
