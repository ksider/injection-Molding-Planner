Ниже идеи, которые дают реальную пользу, без раздувания UX. Сгруппировано по эффекту.

**Качество процесса**
1. **Шаблоны экспериментов** (наборы машин/рецептов/DOE‑настроек/шагов) с клонированием.
2. **Валидация перед запуском** (обязательные поля/границы параметров/конфликт рецептов).
3. **Сравнение экспериментов** (side‑by‑side summary + differences in DOE и результаты).
4. **Контроль версий отчёта** (revision history + diff ключевых метрик).
5. **Подписи/утверждения** (ролевая подпись на отчётах/шаге квалификации).

**Ускорение работы**
1. **Горячие действия**: быстрые кнопки “Create DOE”, “Add run”, “Add report” из списка.
2. **Автозаполнение из последнего эксперимента** (машина/параметры/рецептуры).
3. **Поиск + фильтры** по статусу/машине/владельцу/дате.

**Аналитика**
1. **Авто‑метки дефектов** на основе аномалий (например, threshold по давлению/весу).
2. **Единый KPI‑панель** (cycle time, weight stability, defects rate, process window width).
3. **Стабильность результатов** (временная серия на уровне run’ов).

**Данные и интеграции**
1. **Экспорт CSV/Excel** по всем сущностям (эксперимент/DOE/qualification/report).
2. **Импорт параметров машин** из шаблона (CSV + токены).
3. **Лёгкий бэкап** (кнопка “Export DB” + auto‑backup folder).

**Роли и безопасность**
1. **Мягкие права** (manager может читать, admin — редактировать).
2. **Логи действий** (кто поменял параметры/владельца/отчёт).

**UX‑детали**
1. **Статусные бейджи** везде (эксперимент/DOE/отчёт/qualification step).
2. **Inline‑редактирование** для мелких правок (имя, описание).
3. **Скелетон‑загрузка** и подсветка “что изменилось”.

## План экспорта данных

**Этап 1 — Базовый CSV (быстро дать ценность)**
1. Экспорт эксперимента: `experiment.csv` (id, name, owner, status, created_at).
2. Экспорт DOE runs: `doe_runs.csv` (run_code, recipe, inputs, outputs, tags, done, exclude).
3. Экспорт qualification: `qualification.csv` (шаги, настройки, summary, run_values).
4. Экспорт отчётов: `reports.csv` (name, executors, include, signed_by, signed_at).

**Этап 2 — Пакетный экспорт**
1. ZIP‑пакет с подкаталогами: `experiment/`, `doe/`, `qualification/`, `reports/`.
2. Внутри — CSV + `metadata.json` (ver, timestamps, user).
3. Кнопка “Export All” на уровне эксперимента.

**Этап 3 — Excel**
1. Один `.xlsx` с табами: `Experiment`, `DOE Runs`, `Qualification`, `Reports`.
2. Опционально: вкладка “Summary” с KPI.

**Этап 4 — Импорт обратно (опционально)**
1. Импорт только runs (безопасный), затем расширение до полной загрузки.

**Технические детали (коротко)**
- Сервисы: `src/services/export_service.ts`.
- Роуты: `/experiments/:id/export` + параметры `format=csv|xlsx` и `scope=...`.
- Авторизация: только admin/manager.
- Размеры: стриминг для больших CSV.

## План: мобильное приложение и синхронизация

**Цель**
- Дать работу “в поле” с телефона/планшета и не терять целостность данных между устройствами.

**Вариант A — Общее серверное приложение (рекомендуемый как основной)**
1. Оставить одну центральную БД на сервере и открыть доступ через веб/API.
2. Сделать адаптивный mobile-first интерфейс (или легкий mobile app-клиент), который работает с этим же API.
3. Все изменения сразу пишутся в центральную БД, конфликты минимальны.

**Плюсы**
- Самая простая консистентность данных.
- Нет сложной логики двусторонней синхронизации.
- Быстрее поддержка ролей, подписей, аудита.

**Минусы**
- Нужен стабильный интернет.
- Требуется нормальный серверный деплой и резервирование.

**Вариант B — Локальные базы + облачная синхронизация**
1. На локальной установке хранится своя БД.
2. Поднимается sync-механизм: журнал изменений (`change_log`) + обмен дельтами через облако.
3. При конфликте используется стратегия: “последняя правка” или ручной merge по сущности.

**Плюсы**
- Можно работать оффлайн дольше.
- Подходит для изолированных площадок.

**Минусы**
- Самая дорогая часть по разработке и тестам.
- Высокий риск конфликтов при одновременном редактировании.
- Сложнее безопасность и трассировка изменений.

**Рекомендуемая стратегия**
1. Этап 1: серверная модель (Вариант A) + адаптивный UI.
2. Этап 2: локальный offline-cache только для чтения/черновиков.
3. Этап 3: если реально нужна автономность, вводить ограниченную sync-модель для конкретных сущностей (например, tasks/notes), а не всей БД сразу.

**Минимальный технический бэклог**
1. API-слой для мобильного клиента: auth, experiments, tasks, reports, notes.
2. Токены доступа + refresh; принудительный logout/ban должен инвалидировать сессии.
3. Фоновая отправка черновиков при восстановлении сети.
4. Наблюдаемость: лог ошибок sync/API, метрики задержек и конфликтов.

## План: комментарии, заметки и лабораторный журнал (MD + календарь)

**Цель**
- Вести полноценный хронологический журнал эксперимента: кто, когда и к какой сущности добавил заметку/комментарий.

**Модель данных**
1. `notes`:
- `id`, `experiment_id`, `author_id`, `title`, `body_md`, `created_at`, `updated_at`, `pinned`.
2. `note_links` (привязка к сущности):
- `note_id`, `entity_type` (`qualification_step|doe|run|report|task|experiment`), `entity_id`.
3. `note_comments` (обсуждение):
- `id`, `note_id`, `author_id`, `body_md`, `created_at`.
4. `note_tags` (опционально):
- Быстрые фильтры: `#defect`, `#machine`, `#recipe`, `#action-required`.

**Ключевое поведение**
1. Заметка может быть общей по эксперименту или привязанной к конкретной сущности.
2. В карточке сущности показывается блок “Журнал/Заметки” только по этой сущности + ссылка на общий журнал.
3. В карточке эксперимента должны отображаться все заметки связанные с экспериментом, помеченные сущностью в которой они были созданы
4. Таймлайн по датам: группировка `Сегодня / Вчера / Дата`.
5. Формат заметок: Markdown (заголовки, списки, чекбоксы, вложенные изображения/файлы по мере необходимости).
6. Экспорт в Обсидиан

**Календарный режим**
1. Месячный/недельный вид: точки активности по дням.
2. Клик по дате открывает список заметок, созданных/обновленных в этот день.
3. Фильтры календаря: по автору, сущности, тегу.

**Права и аудит**
1. Создавать: admin/manager/engineer.
2. Редактировать: автор, manager, admin.
3. Удалять: soft-delete только admin/manager.
4. Все правки заметок логируются (минимум: кто и когда редактировал).

**UI-минимум (первый релиз)**
1. Отдельная страница “Lab Journal” с непрерывной лентой заметок и боковой навигацией по точкам активности (по датам/якорям).
2. На странице эксперимента: правая плавающая панель шириной `~33%` экрана (чат-подобный вид), левая часть остается под рабочий контент эксперимента.
3. В этой панели можно быстро добавлять заметки “на лету”, без перехода на отдельную страницу.
4. Заголовок и метаданные заметки заполняются автоматически:
- `Эксперимент -> Сущность -> День -> Время -> Текст`.
- Сущность берется из текущего контекста (например, DOE, Run, Task, Qualification Step, Report).
- Дата и время берутся из серверного времени создания записи.
5. Минимальное меню форматирования в инпуте заметки:
- `bold`, `italic`, `bullet list`, `checklist`, `link`, `code`.
6. Каждое сообщение/заметка в панели показывает:
- авто-заголовок (эксперимент + сущность),
- timestamp,
- краткое тело заметки,
- ссылку “open in journal” для полного режима.

**Поведение правой панели в эксперименте**
1. По умолчанию панель открыта на desktop и сворачивается в иконку на mobile.
2. Фильтр “Только текущая сущность / Весь эксперимент”.
3. Быстрое переключение дней (Today, Yesterday, Date picker).
4. Sticky-позиционирование: панель остается видимой при прокрутке основной страницы.
5. Новые заметки появляются в ленте сразу после сохранения (optimistic update + sync с сервером).

**Этапы внедрения**
1. Этап 1: `notes` + Markdown + привязка к сущности + авто-метаданные + отдельная страница Journal.
2. Этап 2: правая плавающая панель `1/3` в эксперименте + быстрый ввод + live-лента.
3. Этап 3: комментарии и фильтры по дате/сущности/автору + боковая навигация по точкам.
4. Этап 4: календарный вид и уведомления о новых комментариях/упоминаниях.
5. Этап 5: экспорт журнала в report appendix (PDF/HTML).

**Риски и как закрыть**
1. Риск: “шум” из коротких комментариев.
- Решение: разделить быстрые комментарии и полноценные заметки, добавить pin/priority.
2. Риск: потеря контекста при переносе сущностей.
- Решение: хранить `entity_type + entity_id`, а для архивных сущностей не удалять связь, а помечать `archived`.
3. Риск: слишком сложный UI.
- Решение: начать с одного списка + фильтров, календарь добавить вторым этапом.

## План миграции: `Editor.js` -> современный Markdown-редактор (Milkdown/Tiptap)

**Приоритет выполнения**
1. Сначала полностью заменить редактор отчетов на Markdown-редактор в режиме `WYSIWYG`.
2. Только после стабилизации отчетов переходить к реализации журнала/заметок.

**Выбор движка (на сейчас)**
1. Основной путь: `Tiptap` (V2 редактор отчетов).
2. Резервный путь: `Milkdown`, если не достигаем стабильного Markdown round-trip и экспорта.
3. Решение о смене принимается по техкритериям, а не по визуалу сайта.

**Цель**
- Перейти от блочной модели отчетов к единой Markdown-модели для отчетов, заметок и будущего экспорта (PDF/HTML/Obsidian) без потери исторических данных.

**Почему миграция нужна**
1. Сейчас отчеты хранятся как block-JSON (`report_documents.content_json`) и завязаны на набор блоков.
2. Для журнала, комментариев и длинных текстов нужна единая линейная модель документа.
3. Единый формат Markdown упростит экспорт, diff, versioning и reuse в мобильном клиенте.

**Целевой формат данных**
1. Добавить в `report_documents`:
- `content_md TEXT` (канонический формат),
- `content_html TEXT` (кеш рендера, опционально),
- `editor_kind TEXT` (`editorjs|milkdown|tiptap`),
- `schema_version INTEGER`.
2. На переходный период хранить оба формата:
- legacy `content_json` (Editor.js),
- новый `content_md`.

**Стратегия перехода (dual-run)**
1. Режим чтения:
- Если есть `content_md`, рендерим новый документ.
- Если нет `content_md`, рендерим legacy `content_json`.
2. Режим редактирования:
- Новые отчеты создавать сразу в новом редакторе.
- Старые отчеты оставить в legacy-режиме без конвертации на текущем этапе.
3. Подписи:
- Подписанный отчет остается read-only вне зависимости от редактора.

**Требования к редактору отчетов (V2)**
1. Режим редактирования: `WYSIWYG` по умолчанию, Markdown-source как дополнительный режим.
2. Полный набор инструментов:
- заголовки `H1-H4`,
- bold/italic/underline/strike,
- bullet/ordered/check list,
- таблицы, цитаты, code block, divider,
- ссылки, изображения, вложения,
- undo/redo, горячие клавиши.
3. Поддержка вставки из буфера (Word/Google Docs/HTML) с предсказуемой очисткой форматирования.
4. Стабильный экспорт в HTML/PDF из одного источника (`content_md` + renderer).
5. Read-only режим для подписанных отчетов без побочных действий сохранения.

**Критерии фейла для `Tiptap` (когда переключаемся на `Milkdown`)**
1. Потеря структуры при `md -> editor -> md` на типовых шаблонах отчетов.
2. Нестабильный экспорт PDF/HTML (регрессии по таблицам, спискам, изображениям).
3. Невозможность обеспечить паритет read-only/подписи в согласованный срок.

**Текущая граница этапа**
1. Конвертацию legacy-отчетов (`Editor.js JSON -> Markdown`) не делаем сейчас.
2. Причина: в системе пока нет накопленного массива готовых отчетов, ценность низкая.
3. Возврат к задаче конвертации: когда появятся реальные архивные отчеты, которые нужно переносить.

**Этапы внедрения**
1. Этап 1: подготовка БД и репозиториев под dual-format (`content_md`, `editor_kind`, `schema_version`).
2. Этап 2: внедрение V2 WYSIWYG-редактора для всех новых отчетов (feature flag `REPORT_EDITOR_V2`).
3. Этап 3: паритет функций с текущим редактором + стабилизация подписей и read-only.
4. Этап 4: стабилизация экспортов (PDF/HTML) из V2 и отключение создания новых legacy-документов.
5. Этап 5: review через 1-2 релиза, нужен ли вообще migration-конвертер.

**Критерии готовности**
1. 100% новых отчетов создаются в новом редакторе.
2. Подписанные отчеты корректно читаются и не теряют данные.
3. Экспорт PDF/HTML работает из `content_md` без регрессии по структуре.

**Риски и контроль**
1. Риск: расхождение рендера между old/new.
- Контроль: визуальный snapshot-тест ключевых секций.
2. Риск: двойная поддержка затянется.
- Контроль: решение по полной миграции принять после появления достаточного объема legacy-данных.

**Технический бэклог (коротко)**
1. `src/services/report_migration_service.ts`:
- `validateMarkdownReport`.
2. Роуты:
- новые роуты под V2-редактор (создание/сохранение/просмотр в markdown-режиме).
3. UI:
- бейдж типа редактора (`Legacy`/`Markdown`),
- без кнопки миграции на текущем этапе.

**План реализации (ближайший спринт, Tiptap-first)**
1. Заменить UI `/reports/:id/editor` на Tiptap (WYSIWYG), сохранив текущие требования:
- `Save`, `Export PDF`, read-only для подписанных отчетов,
- заголовки, списки, таблицы, изображения, разделитель.
2. Сохранение документа:
- писать `content_json` как JSON Tiptap-документа,
- писать `html_snapshot` как HTML от рендера редактора.
3. Источник контента при открытии:
- сначала `html_snapshot` (если есть),
- затем `content_json` (если это Tiptap JSON),
- иначе fallback из текущего seed отчета.
4. Legacy-конвертер не делать на этом этапе.
5. Критерий готовности спринта:
- новый отчет редактируется/сохраняется в Tiptap,
- подписанный отчет открывается read-only,
- печать/экспорт в PDF работает как сейчас.
