# IM Planner — план расширения до платформы полимерных процессов

## 1) Цель
Сделать из текущего сервиса (литье под давлением) модульную платформу для:
1. планирования литья,
2. планирования масштабирования,
3. других полимерных процессов,
с единым UX редактирования отчетов, заметок, задач и ролей.

Ключевая идея: добавить внешний уровень контекста (`Процесс/Тип процесса`) над экспериментами, не ломая текущую структуру.

---

## 2) Текущее состояние (база уже есть)

### Реализовано
1. Аутентификация и роли (`admin/manager/engineer/operator`).
2. Владельцы экспериментов + ACL.
3. Статусы экспериментов и UI страницы эксперимента.
4. Отчеты: подпись, отзыв подписи, read-only подписанных.
5. Report Editor на Tiptap (WYSIWYG), `content_md/html/json`, автосейв, PDF-экспорт (печать).
6. Notes/Journal: drawer + отдельная страница, фильтры, rail, версионирование заметок, чеклисты.
7. Run-роуты вложены под эксперимент + legacy-redirect.

### Что дожать в текущем контуре
1. Полная стабилизация popup notes-редактора (одинаковое поведение с report editor).
2. Финальный проход по UX журнала/заметок (плотность, мобилка, фильтры).

---

## 3) Целевая доменная модель (новый уровень вложенности)

## 3.1 Новая иерархия
1. `Process Program` (опционально, верхний контейнер компании/направления).
2. `Process Type` (обязательный внешний слой): `Injection`, `Scale-up`, `Extrusion`, `Compounding`, ...
3. `Process` (конкретный процесс/инициатива, с ответственным за процесс).
4. `Experiment` (как сейчас).
5. Сущности эксперимента (`Qualification`, `DOE`, `Run`, `Task`, `Report`, `Notes`).

Минимум для первого этапа: ввести `Process Type + Process` и привязать к ним эксперименты.

## 3.2 Роли и ответственность (расширение)
1. `Process Owner` — новый уровень ответственности.
2. `Experiment Owner` — остается.
3. `Entity Assignee` — остается (шаги/DOE/другие сущности).
4. Правила прав:
1. `Process Owner` видит/управляет всем в процессе.
2. `Experiment Owner` управляет экспериментом и подписывает отчеты по его сущностям.
3. Назначения по сущностям создают автозадачи и уведомления.

---

## 4) Архитектурные принципы для масштабирования
1. Feature modules: каждый процесс подключает свои блоки (параметры, шаги, шаблоны отчетов) как модуль.
2. Единое ядро: auth/roles/notes/tasks/reports/editor/calendar/search.
3. Общий Report Editor: один Tiptap-движок и одна тулбар-логика для всех типов процессов.
4. Типизированные entity metadata: расширения через `entity_type + schema`, без копипаста таблиц.
5. Совместимость по роутам: старые URL продолжают работать через redirect/compat слой.

---

## 5) Интегрированный roadmap (с учетом текущего плана)

## Wave A — стабилизация текущего ядра (короткий горизонт)
1. Привести popup notes editor к паритету с report editor (форматирование/фокус/выделение/таблицы/формулы).
2. Journal V2:
1. календарный режим (MVP),
2. единые фильтры `text + date + entity_type`,
3. UI истории версий заметок.
3. Report Editor stabilization:
1. регрессия реальных кейсов,
2. print-стили PDF,
3. фиксация канона хранения (`content_md`).

## Wave B — доменный слой `Process Type + Process` (главный шаг масштабирования)
1. БД:
1. `process_types`,
2. `processes` (`owner_user_id`, статус, метаданные),
3. связь `experiments.process_id`.
2. UI/навигация:
1. выбор процесса и типа процесса,
2. фильтры/группировка на home/list страницах,
3. карточка процесса.
3. Роли:
1. добавить `process_owner` права,
2. матрица доступа `admin/manager/process_owner/experiment_owner`.
4. Миграция:
1. создать default `Process Type = Injection`,
2. существующие эксперименты привязать к default process,
3. сохранить старые маршруты через redirect.

## Wave C — мультипроцессность и модульные шаблоны
1. Процессные шаблоны:
1. структура этапов,
2. обязательные поля,
3. шаблоны отчетов.
2. Подключить второй процессный модуль (например, `Scale-up`) без форка ядра.
3. Унифицировать report blocks по типам процессов.

## Wave D — общесистемные функции
1. Экспорт данных: CSV/ZIP/XLSX.
2. Пользовательский календарь (`tasks + notes + reports`) + ICS/Google.
3. Глобальный поиск + расширенный аудит.
4. Основа внутренних сообщений (поверх текущих notifications).

---

## 6) План миграции без боли
1. Сначала расширяем схему БД, не ломая текущие таблицы.
2. Вводим fallback-контекст `Injection Default Process`.
3. Переводим UI поэтапно: список -> карточка эксперимента -> отчеты -> заметки.
4. Legacy routes держим минимум 1 релиз.
5. На каждом шаге — миграционные скрипты + smoke tests.

---

## 7) Что делаем следующим спринтом (конкретно)
1. Завершить стабилизацию notes popup editor до полной паритетности с report editor.
2. Подготовить и применить миграцию БД для `process_types/processes/experiments.process_id`.
3. Добавить `Process Owner` в модель ролей и ACL.
4. Сделать первый UI процесса:
1. создание процесса,
2. выбор типа процесса,
3. список экспериментов внутри процесса.
5. Обновить README и архитектурный раздел по новой иерархии.

---

## 8) Критерии успеха
1. Новый процесс можно создать без изменения ядра редактора/заметок/задач.
2. Для нового типа процесса переиспользуются те же report editing функции.
3. Есть явный `Process Owner` и прозрачная матрица прав.
4. Старые эксперименты продолжают работать без ручного вмешательства.
