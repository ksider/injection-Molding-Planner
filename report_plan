План интеграции Task Manager (внутри эксперимента) — этапы разработки

Этап 1. Модель данных
- tasks:
  id, experiment_id, title, description,
  status (init | in_progress | done | failed),
  owner_user_id (manager/engineer),
  due_at, created_at, updated_at
- task_entities:
  id, task_id, entity_type (qualification_step | doe | report), entity_id,
  label, weight (default равный), progress_mode (toggle | milestone)
  * report учитывается только если привязан к задаче
- task_assignments:
  id, task_id, user_id (operator), role

Этап 2. Логика прогресса
- По умолчанию веса равные, но в редакторе можно менять.
- Суммарный прогресс задачи = (сумма выполненных весов / сумма всех весов).
- Для milestone: фиксированные этапы init → in_progress → done → failed.
- Подпись вышестоящей роли в report‑сущности:
  - добавляется опция “signature required”.
  - подпись менеджера/инженера увеличивает вес сущности и может закрыть задачу.

Этап 3. Сущности (initial scope)
- qualification_step (6 шагов)
- doe (исследование)
- report (отчёт)
  * один report может быть привязан к нескольким задачам (например, Qualification + DOE)

Этап 4. Правила прогресса и весов (по умолчанию)
- Qualification steps:
  Step 1: 3
  Step 2: 1 (опциональный)
  Step 3: 1 (опциональный)
  Step 4: 3
  Step 5: 2
  Step 6: 2
- Step 2 и Step 3 могут быть пропущены, но тогда требуется подпись в отчёте,
  которая закрывает задачу (report + signature покрывают отсутствие шагов).
- DOE:
  главный вклад — отчёт и выводы.
  runs учитываются как прогресс, но задача считается done только при наличии report (+signature).

Этап 5. Роли и доступ
- manager/engineer: создают задачи, связывают с сущностями, назначают владельца.
- operator: отмечает прогресс по своим сущностям внутри задачи.
- viewer: только чтение.

Этап 6. API/маршруты
- GET /experiments/:id/tasks (список)
- POST /experiments/:id/tasks (создание)
- POST /tasks/:id (обновление)
- POST /tasks/:id/status
- POST /tasks/:id/entities (привязка сущности)
- POST /tasks/:id/assign (назначение оператора)
- POST /tasks/:id/sign (подпись вышестоящей роли)
- GET /me/tasks (список пользователя)
- GET /tasks/:id/calendar.ics
- GET /tasks/:id/calendar/google

Этап 7. UI внутри эксперимента
- Отдельный остров Tasks с канбан‑доской (4 колонки).
- Карточка задачи свернута: title + owner + due + %.
- Клик по карточке → попап с:
  описание, привязанные сущности, веса, прогресс, подпись.

Этап 8. UI на странице пользователя
- Без канбана, список “задача — эксперимент”.
- Показ: title, experiment, due, status, %.

Этап 9. Календарь
- Одна кнопка “Add to календарь”.
- Варианты: Google Calendar link + Download .ics.

Этап 10. Тестирование
- Проверка прогресса/весов/подписей.
- Проверка прав доступа.
- Проверка календарных ссылок.
